<?php

/*

  $Id: orders.php,v 1.2 2004/03/05 00:36:41 ccwjr Exp $



  osCommerce, Open Source E-Commerce Solutions

  http://www.oscommerce.com



  Copyright (c) 2003 osCommerce



  Released under the GNU General Public License

*/


header("Expires: Mon, 26 Jul 1997 05:00:00 GMT");             // Date in the past
header("Last-Modified: " . gmdate("D, d M Y H:i:s") . " GMT"); // always modified
header("Cache-Control: no-cache, must-revalidate");           // HTTP/1.1
header("Pragma: no-cache");

  require('includes/application_top.php');
	
	if($_GET['action']=='act_providers_conf'){
		if(isset($_POST['aryFormData']))
			{
				$aryFormData = $_POST['aryFormData'];
			
				foreach ($aryFormData as $key => $value )
				{
					foreach ($value as $key2 => $value2 )
					{	  
		
						if (eregi('--leftbrack', $key)) {				
						$key = str_replace('--leftbrack','[',$key);
						$key = str_replace('rightbrack--',']',$key);				
						}
						
						$value2 = str_replace('@@amp;','&',$value2);
						$value2 = str_replace('@@plush;','+',$value2);
						$value2 = mb_convert_encoding($value2, CHARSET, 'UTF-8');
						$_POST[$key] = $HTTP_POST_VARS[$key] = stripslashes($value2);  
		
						//echo "$key=>$value2<br>";  	   
					}
				}
			$orders_id=tep_db_input($_POST['orders_id']);
			$provider_order_status_id=tep_db_input($_POST['provider_order_status_id_'.$_GET["opID"]]);
			$provider_comment=tep_db_input($_POST['provider_comment_'.$_GET["opID"]]);
			$orders_products_id=tep_db_input($_GET["opID"]);
			$products_id=tep_db_input($_POST['products_id_'.$_GET["opID"]]);
			if(tep_not_null($provider_order_status_id) && $provider_order_status_id>0)
			{
				$sql_data_array = array('orders_products_id' => $orders_products_id,
								'provider_order_status_id' => $provider_order_status_id,
								'provider_comment' => $provider_comment,
								'provider_status_update_date' => 'now()',
								'popc_updated_by' => $login_id,
								'notify_tours4fun' => 1);
				tep_db_perform(TABLE_PROVIDER_ORDER_PRODUCTS_STATUS_HISTORY, $sql_data_array);
			
				$qry_providers="SELECT pl.*, concat_ws(' ', pl.providers_firstname, pl.providers_lastname) as providers_name, p.provider_tour_code, pd.products_name, ta.agency_name, op.products_departure_date, op.products_departure_time, op.customer_invoice_no FROM ".TABLE_PROVIDERS_LOGIN." pl, ".TABLE_TRAVEL_AGENCY." ta, ".TABLE_PRODUCTS." p, ".TABLE_PRODUCTS_DESCRIPTION." pd, ".TABLE_ORDERS_PRODUCTS." op WHERE pl.providers_agency_id=ta.agency_id AND p.agency_id=ta.agency_id AND p.products_id=pd.products_id AND pl.providers_agency_id=p.agency_id AND p.products_id=op.products_id AND op.orders_id='".$orders_id."' AND p.products_id='".$products_id."' AND pl.providers_status=1";
				$mail_to="";
				$qry_providers_detail=$qry_providers." AND pl.parent_providers_id>=0";
				$res_providers_detail=tep_db_query($qry_providers_detail);
				
				$orders_link=FILENAME_PROVIDERS_ORDERS.'?oID='.$orders_products_id.'&action=edit_order';
				$orders_prod_status=tep_get_provider_order_status_name($provider_order_status_id);
				$mail_subject=sprintf(EMAIL_ORDERS_PRODUCTS_STATUS_CHANGED_SUBJECT, $orders_id, $orders_prod_status);
				
				if(tep_db_num_rows($res_providers_detail)>0){//Send to sub users
					while($row_providers_detail=tep_db_fetch_array($res_providers_detail)){
						/*if(tep_not_null($mail_to)){
							$mail_to.=", ".$row_providers_detail['providers_firstname']." &lt;".$row_providers_detail['providers_email_address']."&gt;";
						}else{
							$mail_to=$row_providers_detail['providers_firstname']." &lt;".$row_providers_detail['providers_email_address']."&gt;";
						}*/
						//$mail_to=$row_providers_detail['providers_firstname']." &lt;".$row_providers_detail['providers_email_address']."&gt;";
						if(trim($row_providers_detail['providers_firstname'])==""){
							$to_name = $row_providers_detail['agency_name'];
						}else{
							$to_name = $row_providers_detail['providers_firstname'];
						}
						
						$mail_body=sprintf(EMAIL_ORDERS_PRODUCTS_STATUS_CHANGED_BODY, STORE_OWNER, $orders_id, tep_db_prepare_input($row_providers_detail['provider_tour_code'])." (".tep_db_prepare_input($row_providers_detail['products_name']).")", $orders_id, tep_date_short($row_providers_detail['products_departure_date'])." ".$row_providers_detail['products_departure_time'], $orders_prod_status, ($row_providers_detail['customer_invoice_no']!="")?"\n Invoice#: ".$row_providers_detail['customer_invoice_no']:"", $provider_comment, $orders_link, $orders_link, STORE_OWNER);
						tep_mail($to_name, $row_providers_detail['providers_email_address'], $mail_subject, $mail_body, STORE_OWNER, STORE_OWNER_EMAIL_ADDRESS);
					}
				}else{//Send to root user
					$qry_providers_detail=$qry_providers." AND pl.parent_providers_id=0";
					$res_providers_detail=tep_db_query($qry_providers_detail);
					$row_providers_detail=tep_db_fetch_array($res_providers_detail);
					//$mail_to=$row_providers_detail['providers_firstname']." &lt;".$row_providers_detail['providers_email_address']."&gt;";
					if(trim($row_providers_detail['providers_firstname'])==""){
						$to_name = $row_providers_detail['agency_name'];
					}else{
						$to_name = $row_providers_detail['providers_firstname'];
					}
					
					$mail_body=sprintf(EMAIL_ORDERS_PRODUCTS_STATUS_CHANGED_BODY, STORE_OWNER, $orders_id, tep_db_prepare_input($row_providers_detail['provider_tour_code'])." (".tep_db_prepare_input($row_providers_detail['products_name']).")", $orders_id, tep_date_short($row_providers_detail['products_departure_date'])." ".$row_providers_detail['products_departure_time'], $orders_prod_status, ($row_providers_detail['customer_invoice_no']!="")?"\n Invoice#: ".$row_providers_detail['customer_invoice_no']:"", $provider_comment, $orders_link, $orders_link, STORE_OWNER);
					tep_mail($to_name, $row_providers_detail['providers_email_address'], $mail_subject, $mail_body, STORE_OWNER, STORE_OWNER_EMAIL_ADDRESS);
				}
				/*tep_db_data_seek($res_providers_detail,0);
				$row_providers_detail=tep_db_fetch_array($res_providers_detail);
				$orders_link=FILENAME_PROVIDERS_ORDERS.'?oID='.$orders_products_id.'&action=edit_order';
				$orders_prod_status=tep_get_provider_order_status_name($provider_order_status_id);
				$mail_subject=sprintf(EMAIL_ORDERS_PRODUCTS_STATUS_CHANGED_SUBJECT, $orders_id, $orders_prod_status);
				$mail_body=sprintf(EMAIL_ORDERS_PRODUCTS_STATUS_CHANGED_BODY, STORE_OWNER, $orders_id, tep_db_prepare_input($row_providers_detail['provider_tour_code'])." (".tep_db_prepare_input($row_providers_detail['products_name']).")", $orders_id, tep_date_short($row_providers_detail['products_departure_date'])." ".$row_providers_detail['products_departure_time'], $orders_prod_status, ($row_providers_detail['customer_invoice_no']!="")?"\n Invoice#: ".$row_providers_detail['customer_invoice_no']:"", $provider_comment, $orders_link, $orders_link, STORE_OWNER);
				tep_mail('', $mail_to, $mail_subject, $mail_body, STORE_OWNER, STORE_OWNER_EMAIL_ADDRESS);*/
				echo '<nobr><strong>'.PROVIDERS_CONFIRMATION_SENT.'</strong></nobr>';
			}
		}
		exit;
	}

/* ** GOOGLE CHECKOUT **/

  define('STATE_PENDING', "1");

  define('STATE_PROCESSING', "2");

  define('STATE_DELIVERED', "3");



 /*

  * Function which posts a request to the specified url.

  * @param url Url where request is to be posted

  * @param merid The merchant ID used for HTTP Basic Authentication

  * @param merkey The merchant key used for HTTP Basic Authentication

  * @param postargs The post arguments to be sent

  * @param message_log An opened log file poitner for appending logs

  */

  function send_google_req($url, $merid, $merkey, $postargs, $message_log) {

    // Get the curl session object

    $session = curl_init($url);



    $header_string_1 = "Authorization: Basic ".base64_encode($merid.':'.$merkey);

    $header_string_2 = "Content-Type: application/xml";

    $header_string_3 = "Accept: application/xml";



    fwrite($message_log, sprintf("\r\n%s %s %s\n",$header_string_1, $header_string_2, $header_string_3));

    // Set the POST options.

    curl_setopt($session, CURLOPT_POST, true);

    curl_setopt($session, CURLOPT_HTTPHEADER, array($header_string_1, $header_string_2, $header_string_3));

    curl_setopt($session, CURLOPT_POSTFIELDS, $postargs);

    curl_setopt($session, CURLOPT_HEADER, true);

    curl_setopt($session, CURLOPT_RETURNTRANSFER, true);

	// Uncomment the following and set the path to your CA-bundle.crt file if SSL verification fails

	//curl_setopt($session, CURLOPT_CAINFO, "C:\\Program Files\\xampp\\apache\\conf\\ssl.crt\\ca-bundle.crt");



    // Do the POST and then close the session

    $response = curl_exec($session);

	if (curl_errno($session)) {

		die(curl_error($session));

	} else {

	    curl_close($session);

	}



    fwrite($message_log, sprintf("\r\n%s\n",$response));



    // Get HTTP Status code from the response

    $status_code = array();

    preg_match('/\d\d\d/', $response, $status_code);



    fwrite($message_log, sprintf("\r\n%s\n",$status_code[0]));

    // Check for errors

    switch( $status_code[0] ) {

      case 200:

      // Success

        break;

      case 503:

        die('Error 503: Service unavailable. An internal problem prevented us from returning data to you.');

	      break;

      case 403:

        die('Error 403: Forbidden. You do not have permission to access this resource, or are over your rate limit.');

        break;

      case 400:

        die('Error 400: Bad request. The parameters passed to the service did not match as expected. The exact error is returned in the XML response.');

        break;

      default:

        die('Error :' . $status_code[0]);

    }

  }



  function google_checkout_state_change($check_status, $status, $oID, $cust_notify, $notify_comments) {

    // If status update is from Pending -> Processing on the Admin UI

    // this invokes the processing-order and charge-order commands

    // 1->Pending, 2-> Processing



      define('API_CALLBACK_MESSAGE_LOG', DIR_FS_CATALOG . "/googlecheckout/response_message.log");

      define('API_CALLBACK_ERROR_LOG', DIR_FS_CATALOG. "/googlecheckout/response_error.log");



      include_once(DIR_FS_CATALOG . '/includes/modules/payment/googlecheckout.php');

      $googlepay = new googlecheckout();



      //Setup the log file

      if (!$message_log = fopen(str_replace('//','/',API_CALLBACK_MESSAGE_LOG), "a")) {

        error_func("Cannot open " . API_CALLBACK_MESSAGE_LOG . " file.\n", 0);

        exit(1);

      }

      $google_answer = tep_db_fetch_array(tep_db_query("select google_order_number, order_amount from " . $googlepay->table_order . " where orders_id = " . (int)$oID ));

      $google_order = $google_answer['google_order_number'];

      $amt = $google_answer['order_amount'];



    if($check_status['orders_status'] == STATE_PENDING && $status == STATE_PROCESSING) {

      if($google_order != '') {

        $postargs = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>

                    <charge-order xmlns=\"".$googlepay->schema_url."\" google-order-number=\"". $google_order. "\">

                    <amount currency=\"USD\">" . $amt . "</amount>

                    </charge-order>";

        fwrite($message_log, sprintf("\r\n%s\n",$postargs));

        send_google_req($googlepay->request_url, $googlepay->merchantid, $googlepay->merchantkey,

                        $postargs, $message_log);



        $postargs = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>

                    <process-order xmlns=\"".$googlepay->schema_url    ."\" google-order-number=\"". $google_order. "\"/> ";

        fwrite($message_log, sprintf("\r\n%s\n",$postargs));

        send_google_req($googlepay->request_url, $googlepay->merchantid, $googlepay->merchantkey,

                    $postargs, $message_log);

      }

    }



    // If status update is from Processing -> Delivered on the Admin UI

    // this invokes the deliver-order and archive-order commands

    // 2->Processing, 3-> Delivered

    if($check_status['orders_status'] == STATE_PROCESSING &&  $status == STATE_DELIVERED) {

      $send_mail = "false";

      if($cust_notify == 1)

        $send_mail = "true";

      if($google_order != '') {

        $postargs = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>

                     <deliver-order xmlns=\"".$googlepay->schema_url    ."\" google-order-number=\"". $google_order. "\">

                     <send-email> " . $send_mail . "</send-email>

                     </deliver-order> ";

        fwrite($message_log, sprintf("\r\n%s\n",$postargs));

        send_google_req($googlepay->request_url, $googlepay->merchantid, $googlepay->merchantkey,

	              $postargs, $message_log);



        $postargs = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>

                     <archive-order xmlns=\"".$googlepay->schema_url."\" google-order-number=\"". $google_order. "\"/>";

        fwrite($message_log, sprintf("\r\n%s\n",$postargs));

        send_google_req($googlepay->request_url, $googlepay->merchantid, $googlepay->merchantkey,

                        $postargs, $message_log);

      }

    }



    if(isset($notify_comments)) {

      $postargs =  "<?xml version=\"1.0\" encoding=\"UTF-8\"?>

                   <send-buyer-message xmlns=\"http://checkout.google.com/schema/2\" google-order-number=\"". $google_order. "\">

                   <message>". strip_tags($notify_comments) . "</message>

                   </send-buyer-message>";

      fwrite($message_log, sprintf("\r\n%s\n",$postargs));

      send_google_req($googlepay->request_url, $googlepay->merchantid, $googlepay->merchantkey,

                      $postargs, $message_log);



    }

  }

  // ** END GOOGLE CHECKOUT **

  require(DIR_WS_CLASSES . 'currencies.php');

  $currencies = new currencies();



  $orders_statuses = array();

  $orders_status_array = array();

  //tom added 日本团的自带磁带提示信息
  //JPTK82-1407，JPTK82-1413， JPTK82-1414， JPTK82-1414， JPTK82-1414， JPTK82-1414，JPTK82-1413，JPTK82-1413
  $japan_array = '';
  $japan_array[0]='JPTK82-1407';
  $japan_array[1]='JPTK82-1413';
  $japan_array[2]='JPTK82-1414';
  $japan_array[3]='JPTK82-1414';
  $japan_array[4]='JPTK82-1414';
  $japan_array[5]='JPTK82-1414';
  $japan_array[6]='JPTK82-1413';
  $japan_array[7]='JPTK82-1413';

  $not_in_ids = '11,47,100011,100024,100034,100035,100039,100028,100041,100047,100049,100050,100058,100059';
  $orders_status_query = tep_db_query("select orders_status_id, orders_status_name from " . TABLE_ORDERS_STATUS . " where orders_status_id not in(".$not_in_ids.")  AND language_id = '" . (int)$languages_id . "' ORDER BY `orders_status_name` ASC ");

  while ($orders_status = tep_db_fetch_array($orders_status_query)) {

    $orders_statuses[] = array('id' => $orders_status['orders_status_id'],

                               'text' => $orders_status['orders_status_name']);

    $orders_status_array[$orders_status['orders_status_id']] = $orders_status['orders_status_name'];

  }


  $action = (isset($HTTP_GET_VARS['action']) ? $HTTP_GET_VARS['action'] : '');



  if (tep_not_null($action)) {

    switch ($action) {

//begin PayPal_Shopping_Cart_IPN  V2.8 DMG

        case 'accept_order':

            include(DIR_FS_CATALOG_MODULES.'payment/paypal/admin/AcceptOrder.inc.php');

            break;

//end PayPal_Shopping_Cart_IPN

      case 'update_order':

        $oID = tep_db_prepare_input($HTTP_GET_VARS['oID']);

        $status = tep_db_prepare_input($HTTP_POST_VARS['status']);

        $comments = tep_db_prepare_input($HTTP_POST_VARS['comments']);

		//$comments_for_email = $CharEncoding->EncodeString($comments);

		$comments_for_email = $comments;



        $order_updated = false;

        $check_status_query = tep_db_query("select * from " . TABLE_ORDERS . " where orders_id = '" . (int)$oID . "'");

        $check_status = tep_db_fetch_array($check_status_query);

// BOF: WebMakers.com Added: Downloads Controller

// always update date and time on order_status

// original        if ( ($check_status['orders_status'] != $status) || tep_not_null($comments)) {

       if ( ($check_status['orders_status'] != $status) || $comments != '' || ($status ==DOWNLOADS_ORDERS_STATUS_UPDATED_VALUE) ) {

			//howard added write vale to "orders_cancelled_total"
			if($status==6){
				$check_old_status_sql = tep_db_query('SELECT count(*) as total FROM `orders` WHERE orders_id="'.(int)$oID.'" AND orders_status=6 ');
				$check_old_status_row = tep_db_fetch_array($check_old_status_sql);
				if(!(int)$check_old_status_row['total']){
					$sql = tep_db_query('SELECT value FROM `orders_total` WHERE orders_id="'.(int)$oID.'" AND class="ot_total" ');
					$row = tep_db_fetch_array($sql);
					if((int)$row['value']){
						tep_db_query('UPDATE orders SET orders_cancelled_total="'.$row['value'].'" WHERE orders_id="'.(int)$oID.'" ');
					}
				}
			}
			//howard added write vale to "orders_cancelled_total" end
          tep_db_query("update " . TABLE_ORDERS . " set orders_status = '" . tep_db_input($status) . "', last_modified = now() where orders_id = '" . (int)$oID . "'");


        $check_status_query2 = tep_db_query("select customers_name, customers_email_address, orders_status, date_purchased from " . TABLE_ORDERS . " where orders_id = '" . (int)$oID . "'");

        $check_status2 = tep_db_fetch_array($check_status_query2);

      if ( $check_status2['orders_status']==DOWNLOADS_ORDERS_STATUS_UPDATED_VALUE ) {

        tep_db_query("update " . TABLE_ORDERS_PRODUCTS_DOWNLOAD . " set download_maxdays = '" . tep_get_configuration_key_value('DOWNLOAD_MAX_DAYS') . "', download_count = '" . tep_get_configuration_key_value('DOWNLOAD_MAX_COUNT') . "' where orders_id = '" . (int)$oID . "'");

      }

// EOF: WebMakers.com Added: Downloads Controller
      if($status==100071){
		    if($_SERVER['HTTP_HOST']=='cn.toursforfun.com'||$_SERVER['HTTP_HOST']=='www.toursforfun.com'){
                   $to_email_address = 'richard.chen@tours4fun.com';
         }else{
                    $to_email_address = 'weiyi.li@tours4fun.com';
         }
                           $to_name = db_to_html('陈锐');
                           //$to_email_address = 'richard.chen@tours4fun.com';
                          // $to_email_address = 'workmousechen@126.com';
                    if($HTTP_POST_VARS['email_subject'] != ''){

                                $email_sent_subject =$HTTP_POST_VARS['email_subject'];

			              }else{

				                $email_sent_subject = EMAIL_TEXT_SUBJECT.' '.date('Y-m-d H:i:s');

			              }
			                  $email_sent_subject.='('.$oID.')';
                        $user_lang_code = customers_language_code($check_status['customers_email_address']);
                        $email_subject = iconv(CHARSET,$user_lang_code.'//IGNORE',$email_sent_subject);
                        $notify_comments = sprintf(EMAIL_TEXT_COMMENTS_UPDATE, $comments_for_email) . "\n\n";
                        $email = '';
                        $email.=
					

																			EMAIL_SEPARATOR . "\n"  .
									
																			STORE_NAME . "\n" .
									
																			EMAIL_SEPARATOR . "\n" .
									
																			db_to_html('客户订单号：') . ' ' . $oID . "\n" .
																			EMAIL_TEXT_DATE_ORDERED . ' ' . tep_date_long($check_status['date_purchased']) . "\n\n" .

					    $notify_comments . sprintf(EMAIL_TEXT_STATUS_UPDATE, $orders_status_array[$status]);

			        $email.= email_track_code('OrderStatus',$check_status['customers_email_address'],$oID );
                    $email_text = iconv(CHARSET,$user_lang_code.'//IGNORE',$email);
                           //$email_text = $comments_for_email;
                    $from_email_name = iconv(CHARSET,$user_lang_code.'//IGNORE', db_to_html(STORE_OWNER));
			        //$from_email_address = STORE_OWNER_EMAIL_ADDRESS;
			        $from_email_address = 'service@toursforfun.com ';
					    $to_name = iconv(CHARSET,$user_lang_code.'//IGNORE',$to_name);

              tep_mail($to_name, $to_email_address, $email_subject, $email_text, $from_email_name, $from_email_address , 'true', $user_lang_code);

         }else{



          $customer_notified = '0';

          if (isset($HTTP_POST_VARS['notify']) && ($HTTP_POST_VARS['notify'] == 'on')) {

            $notify_comments = '';

// BOF: WebMakers.com Added: Downloads Controller - Only tell of comments if there are comments

            if (isset($HTTP_POST_VARS['notify_comments']) && ($HTTP_POST_VARS['notify_comments'] == 'on')) {

              $notify_comments = sprintf(EMAIL_TEXT_COMMENTS_UPDATE, $comments_for_email) . "\n\n";

            }





			   // ** GOOGLE CHECKOUT **

            chdir("./..");

            require_once('includes/languages/' . $language . '/' .'modules/payment/googlecheckout.php');

            $payment_value= MODULE_PAYMENT_GOOGLECHECKOUT_TEXT_TITLE;

            $num_rows = tep_db_num_rows(tep_db_query("select google_order_number from google_orders where orders_id= ". (int)$oID));



            //Check if order is a Google Checkout order

            if($num_rows == 0) {

			 // ** GOOGLE CHECKOUT **

// EOF: WebMakers.com Added: Downloads Controller

            //$email = EMAIL_TEXT_DEAR . $CharEncoding->EncodeString($check_status['customers_name']) . "\n".  EMAIL_SEPARATOR . "\n"  . STORE_NAME . "\n" . EMAIL_SEPARATOR . "\n" . EMAIL_TEXT_ORDER_NUMBER . ' ' . $oID . "\n" . EMAIL_TEXT_INVOICE_URL . ' ' . tep_catalog_href_link(FILENAME_CATALOG_ACCOUNT_HISTORY_INFO, 'order_id=' . $oID, 'SSL') . "\n" . EMAIL_TEXT_DATE_ORDERED . ' ' . tep_date_long($check_status['date_purchased']) . "\n\n" . $notify_comments . sprintf(EMAIL_TEXT_STATUS_UPDATE, $orders_status_array[$status]);

            $email = '';
			//结伴同游邮件不同指名道姓
			$order_url = tep_catalog_href_link('orders_travel_companion_info.php', 'order_id=' . $oID, 'SSL');
			if(!isset($_POST['send_travel_companion_user']) || $_POST['send_travel_companion_user'] != '1'){
				$email.= EMAIL_TEXT_DEAR . db_to_html($check_status['customers_name']) . "\n" ;
				$order_url = tep_catalog_href_link(FILENAME_CATALOG_ACCOUNT_HISTORY_INFO, 'order_id=' . $oID, 'SSL');
			}
			//结伴同游邮件不同指名道姓 end
			$email.=
					EMAIL_TEXT_DEAR_A."\n".

					EMAIL_SEPARATOR . "\n"  .

					STORE_NAME . "\n" .

					EMAIL_SEPARATOR . "\n" .

					EMAIL_TEXT_ORDER_NUMBER . ' ' . $oID . "\n" .

					EMAIL_TEXT_INVOICE_URL . ' ' . $order_url . "\n" .

					EMAIL_TEXT_DATE_ORDERED . ' ' . tep_date_long($check_status['date_purchased']) . "\n\n" .

					$notify_comments . sprintf(EMAIL_TEXT_STATUS_UPDATE, $orders_status_array[$status]);

			$email.= email_track_code('OrderStatus',$check_status['customers_email_address'],$oID );



           //amit added to change email subject start



			if($HTTP_POST_VARS['email_subject'] != ''){

			$email_sent_subject =$HTTP_POST_VARS['email_subject'];

			}else{

				$email_sent_subject = EMAIL_TEXT_SUBJECT.' '.date('Y-m-d H:i:s');

			}



		//code extra information on comformation tour by bhavik

			if($status == '100000')

			include("orders_confirm_email_info.php");



			 //$email .= "\n\n" .str_replace('<a></a>', get_login_publicity_name() ,CONFORMATION_EMAIL_FOOTER);

			// howard fixed atuo get lang code to send mail
			$user_lang_code = customers_language_code($check_status['customers_email_address']);
			$to_name = iconv(CHARSET,$user_lang_code.'//IGNORE',db_to_html($check_status['customers_name']));
			$to_email_address = $check_status['customers_email_address'];
			$email_subject = iconv(CHARSET,$user_lang_code.'//IGNORE',$email_sent_subject);
			$email_text = iconv(CHARSET,$user_lang_code.'//IGNORE',$email);
			$from_email_name = iconv(CHARSET,$user_lang_code.'//IGNORE', db_to_html(STORE_OWNER));
			//$from_email_address = STORE_OWNER_EMAIL_ADDRESS;
			$from_email_address = 'orders@toursforfun.com';

			//如果是结伴同游，是否给其它成员发邮件
			if(isset($_POST['send_travel_companion_user']) && $_POST['send_travel_companion_user'] == '1'){
				$travel_companion_email = str_replace($to_email_address,'',get_order_travel_companion_email_list($oID));
				$to_email_address .= $travel_companion_email;
				$to_name .= $travel_companion_email;
			}

			tep_mail($to_name, $to_email_address, $email_subject, $email_text, $from_email_name, $from_email_address , 'true', $user_lang_code);
			// howard fixed atuo get lang code to send mail end

		//amit added to change email subject end

            $customer_notified = '1';

			 // ** GOOGLE CHECKOUT **

		  }else {

		          if($HTTP_POST_VARS['notify'] != 'on')

		          	unset($notify_comments);

		          google_checkout_state_change($check_status, $status, $oID, $customer_notified, $notify_comments);

            }

		  // ** GOOGLE CHECKOUT **



          }
		 }
	  ######## Points/Rewards Module V2.1rc2a BOF ##################

		if($status==100006){
		  if ((USE_POINTS_SYSTEM == 'true') && !tep_not_null(POINTS_AUTO_ON)) {
		  	$customer_query = tep_db_query("select unique_id, customer_id, points_pending from " . TABLE_CUSTOMERS_POINTS_PENDING . " where (points_status = 1 or points_status = 3) and points_type = 'SP' and orders_id = '" . (int)$oID . "' limit 1");
		    $customer_points = tep_db_fetch_array($customer_query);
		    if (tep_db_num_rows($customer_query)) {

				if (tep_not_null(POINTS_AUTO_EXPIRES)) {
					  $expire  = date('Y-m-d', strtotime('+ '. POINTS_AUTO_EXPIRES .' month'));
					  tep_db_query("update " . TABLE_CUSTOMERS . " set customers_shopping_points = customers_shopping_points + '". $customer_points['points_pending'] ."', customers_points_expires = '". $expire ."' where customers_id = '". (int)$customer_points['customer_id'] ."'");
			    } else {
			          tep_db_query("update " . TABLE_CUSTOMERS . " set customers_shopping_points = customers_shopping_points + '". $customer_points['points_pending'] ."' where customers_id = '". (int)$customer_points['customer_id'] ."'");
			    }
				tep_db_query("update " . TABLE_CUSTOMERS_POINTS_PENDING . " set points_status = 2, points_comment = 'TEXT_DEFAULT_COMMENT' where orders_id = '" . (int)$oID . "' and unique_id = '".$customer_points['unique_id']."'");
		        $sql = "optimize table " . TABLE_CUSTOMERS_POINTS_PENDING . "";

				//如果客户是第一次下订单则将为其推荐人添加积分
				//给老客户推荐人积分> $300 => 1000 , <=$300 => 500 start
				$Old_Customer_Testimonials_Order_End_Time = '2010-12-31 23:59:59';
				$Todaytime = date('Y-m-d H:i:s');
				if($Todaytime <= $Old_Customer_Testimonials_Order_End_Time){
					$customer_order_sql = tep_db_query('SELECT count(*) total FROM `orders` WHERE customers_id="'.(int)$customer_points['customer_id'].'" AND orders_status="100006" ');
					$customer_order_row = tep_db_fetch_array($customer_order_sql);
					if($customer_order_row['total']<2){
						$order_total_sql = tep_db_query('SELECT value FROM `orders_total` WHERE orders_id="'.(int)$oID.'" AND class="ot_total" ');
						$order_total_row = tep_db_fetch_array($order_total_sql);
						$old_customer_add_points = 500;
						if($order_total_row['value']>300){
							$old_customer_add_points = 1000;
						}
						$new_customer_email_address = tep_get_customers_email((int)$customer_points['customer_id']);
						$old_customer_sql = tep_db_query('SELECT old_customer_email_address FROM `old_customer_testimonials` WHERE new_customer_email_address="'.$new_customer_email_address.'" AND orders_id<1 ');
						$old_customer_row = tep_db_fetch_array($old_customer_sql);
						if(tep_not_null($old_customer_row['old_customer_email_address'])){
							//给老客户加分
							$old_customer_id = form_email_get_customers_id($old_customer_row['old_customer_email_address']);
							$sql_data_array = array('customer_id' => (int)$old_customer_id,
												  'points_pending' => $old_customer_add_points,
												  'date_added' => 'now()',
												  'points_comment' => 'TEXT_DEFAULT_REFERRAL',
												  'points_type' => 'RF',
												  'points_status' => 2,
												  'orders_id' => (int)$oID );

							tep_db_perform(TABLE_CUSTOMERS_POINTS_PENDING, $sql_data_array);
							$unique_id = tep_db_insert_id();
							tep_db_query("update " . TABLE_CUSTOMERS . " set customers_shopping_points = customers_shopping_points + '". $old_customer_add_points ."' where customers_id = '". (int)$old_customer_id ."' limit 1");
							tep_db_query("update `old_customer_testimonials` set orders_id = '". (int)$oID ."' where new_customer_email_address = '". $new_customer_email_address ."' limit 1");

						}
					}
				}
				//给老客户推荐人积分> $300 => 1000 , <=$300 => 500 end

				// howard added send points mail to customers
				if(abs($customer_points['points_pending'])){
					require_once(DIR_FS_CATALOG.'includes/languages/schinese/my_points.php');
					send_point_to_customers((int)$customer_points['customer_id']);
				}
			}
		  }
		}else if($status==6 || $status==100005){
			if ((USE_POINTS_SYSTEM == 'true') && !tep_not_null(POINTS_AUTO_ON)) {
		  	$customer_query = tep_db_query("select unique_id, customer_id, points_pending, points_status from " . TABLE_CUSTOMERS_POINTS_PENDING . " where points_type = 'SP' and points_status != 3 and points_status != 4 and orders_id = '" . (int)$oID . "' limit 1");
		    $customer_points = tep_db_fetch_array($customer_query);
		      if (tep_db_num_rows($customer_query)) {
				if($customer_points['points_status']==2){
				tep_db_query("update " . TABLE_CUSTOMERS . " set customers_shopping_points = customers_shopping_points - '". $customer_points['points_pending'] ."' where customers_id = '". (int)$customer_points['customer_id'] ."'");
				}

				if($status==6){
					$set_comment = ", points_comment = '".TEXT_ORDER_CANCELLED_COMMENT."'";
				 }else if($status==100005){
					$set_comment = ", points_comment = '".TEXT_ORDER_REFUNDED_COMMENT."'";
				 }

				tep_db_query("update " . TABLE_CUSTOMERS_POINTS_PENDING . " set points_status = 3 " . $set_comment . " where orders_id = '" . (int)$oID . "' and unique_id = '".$customer_points['unique_id']."'");
			  }

			  //auto confirm refunded used redeem points start
			  $customer_query = tep_db_query("select unique_id, customer_id, points_pending, points_status from " . TABLE_CUSTOMERS_POINTS_PENDING . " where points_type = 'SP' and points_status = 4 and points_pending < 0 and orders_id = '" . (int)$oID . "' limit 1");
		      $customer_points = tep_db_fetch_array($customer_query);
		      if (tep_db_num_rows($customer_query)) {

				$customer_points['points_pending'] = $customer_points['points_pending']*(-1);

				tep_db_query("update " . TABLE_CUSTOMERS . " set customers_shopping_points = customers_shopping_points + '". $customer_points['points_pending'] ."' where customers_id = '". (int)$customer_points['customer_id'] ."'");

				if($status==6){
					$set_comment = ", points_pending='0.00' ";
				 }else if($status==100005){
					$set_comment = ", points_pending='0.00' ";
				 }

				tep_db_query("update " . TABLE_CUSTOMERS_POINTS_PENDING . " set points_status = 4 " . $set_comment . " where orders_id = '" . (int)$oID . "' and unique_id = '".$customer_points['unique_id']."'");
			  }
			  //auto confirm refunded used redeem points end

		    }
		}else{
			if ((USE_POINTS_SYSTEM == 'true') && !tep_not_null(POINTS_AUTO_ON)) {
		  	$customer_query = tep_db_query("select unique_id, customer_id, points_pending, points_status from " . TABLE_CUSTOMERS_POINTS_PENDING . " where points_type = 'SP' and points_status != 1 and points_status != 4 and orders_id = '" . (int)$oID . "' limit 1");
		    $customer_points = tep_db_fetch_array($customer_query);
		      if (tep_db_num_rows($customer_query)) {
				if($customer_points['points_status']==2){
					tep_db_query("update " . TABLE_CUSTOMERS . " set customers_shopping_points = customers_shopping_points - '". $customer_points['points_pending'] ."' where customers_id = '". (int)$customer_points['customer_id'] ."'");
				}

				$set_comment = ", points_comment = 'TEXT_DEFAULT_COMMENT'";

				tep_db_query("update " . TABLE_CUSTOMERS_POINTS_PENDING . " set points_status = 1 " . $set_comment . " where orders_id = '" . (int)$oID . "' and unique_id = '".$customer_points['unique_id']."'");
			  }
		    }
		}

		  /*if ((USE_POINTS_SYSTEM == 'true') && !tep_not_null(POINTS_AUTO_ON)) {
	          if ((isset($_POST['confirm_points']) && ($_POST['confirm_points'] == 'on'))||(isset($_POST['delete_points']) && ($_POST['delete_points'] == 'on'))) {
		          $comments = ENTRY_CONFIRMED_POINTS  . $comments;
		          $customer_query = tep_db_query("select customer_id, points_pending from " . TABLE_CUSTOMERS_POINTS_PENDING . " where points_status = 1 and points_type = 'SP' and orders_id = '" . (int)$oID . "' limit 1");
		          $customer_points = tep_db_fetch_array($customer_query);
		          if (tep_db_num_rows($customer_query)) {
			          if (tep_not_null(POINTS_AUTO_EXPIRES)) {
				          $expire  = date('Y-m-d', strtotime('+ '. POINTS_AUTO_EXPIRES .' month'));
				          tep_db_query("update " . TABLE_CUSTOMERS . " set customers_shopping_points = customers_shopping_points + '". $customer_points['points_pending'] ."', customers_points_expires = '". $expire ."' where customers_id = '". (int)$customer_points['customer_id'] ."'");
			          } else {
				          tep_db_query("update " . TABLE_CUSTOMERS . " set customers_shopping_points = customers_shopping_points + '". $customer_points['points_pending'] ."' where customers_id = '". (int)$customer_points['customer_id'] ."'");
			          }

			          if (isset($_POST['delete_points']) && ($_POST['delete_points'] == 'on')) {
				          tep_db_query("delete from " . TABLE_CUSTOMERS_POINTS_PENDING . " where orders_id = '" . (int)$oID . "' and points_type = 'SP' limit 1");
				          $sql = "optimize table " . TABLE_CUSTOMERS_POINTS_PENDING . "";
			          }

			          if (isset($_POST['confirm_points']) && ($_POST['confirm_points'] == 'on')) {
				          tep_db_query("update " . TABLE_CUSTOMERS_POINTS_PENDING . " set points_status = 2 where orders_id = '" . (int)$oID . "' and points_type = 'SP' limit 1");
				          $sql = "optimize table " . TABLE_CUSTOMERS_POINTS_PENDING . "";
			          }
		          }
	          }
          }*/


######## Points/Rewards Module V2.1rc2a EOF ##################
          tep_db_query("insert into " . TABLE_ORDERS_STATUS_HISTORY . " (orders_id, orders_status_id, date_added, customer_notified, comments, updated_by) values ('" . (int)$oID . "', '" . tep_db_input($status) . "', now(), '" . tep_db_input($customer_notified) . "', '" . tep_db_input($comments)  . "','".$login_id."')");



          $order_updated = true;

        }



        if ($order_updated == true) {

         $messageStack->add_session(SUCCESS_ORDER_UPDATED, 'success');

        } else {

          $messageStack->add_session(WARNING_ORDER_NOT_UPDATED, 'warning');

        }



        tep_redirect(tep_href_link(FILENAME_ORDERS, tep_get_all_get_params(array('action')) . 'action=edit'));

        break;



	  case 'update_eticket':


	  $oID = tep_db_input($HTTP_GET_VARS['oID']);

	  $tour_provider = tep_db_input($HTTP_POST_VARS['tourprovider']);

	  $tour_arrangement = tep_db_input($HTTP_POST_VARS['tour_arrangement']);

	  $depature_full_address = tep_db_input($HTTP_POST_VARS['depature_full_address']);

	  $emergency_contact_person = tep_db_input($HTTP_POST_VARS['emergency_contact_person']);

	  $emergency_contact_no = tep_db_input($HTTP_POST_VARS['emergency_contact_no']);

	  $special_note = tep_db_input($HTTP_POST_VARS['special_note']);



	  //amit added to update order products table start

	  //howard fixed
		$depature_full_address = str_replace('&nbsp;',' ',$depature_full_address);
		$depature_full_address = str_replace('&#160;',' ',$depature_full_address);
	   	$depature_full_address = preg_replace('/ +/',' ',$depature_full_address);
	  	$depature_full_address = trim(ltrim($depature_full_address));

	  $fulladdress_array = explode(' ',$depature_full_address);

	  $products_departure_date = date('Y-m-d H:i:s',strtotime($fulladdress_array[0]));


	  $departure_add_location = '';

		  if(!empty($fulladdress_array)){

		  foreach($fulladdress_array as $key => $val){

			if($key > 0) $departure_add_location .= $val.' ';

		  }

		 }



	  if(eregi('am ',$departure_add_location)){

	    $fulladdress_array_time = explode('am ',$departure_add_location);

	  	$products_departure_time = $fulladdress_array_time[0].'am ';

		$departure_add_location = $fulladdress_array_time[1];

	  }else if(eregi('pm ',$departure_add_location)){

	    $fulladdress_array_time = explode('pm ',$departure_add_location);

	 	$products_departure_time = $fulladdress_array_time[0].'pm ';

		$departure_add_location = $fulladdress_array_time[1];

	  }



	  $products_departure_location = $departure_add_location;

	  $sql_data_array_locations = array('products_departure_date' => tep_db_prepare_input($products_departure_date),



                                  		'products_departure_time' => tep_db_prepare_input($products_departure_time),



								  		'products_departure_location' => tep_db_prepare_input($products_departure_location)

								  		);



			tep_db_perform(TABLE_ORDERS_PRODUCTS, $sql_data_array_locations, 'update', "orders_id = '" . (int)$oID  . "' and products_id = '".$_GET['products_id']."' ");



	  //amit added to update order products table end



	  $h = 1;
	  $guest_name = '';


	  foreach ($_POST as $key=>$val)

	  {

	  	//echo "<br>$key=>$val";

		if(strstr($key,'guest'))

		{

			if(isset($_POST['etckchildage'.$h])){
				$guest_name .= trim($val).'||'.$_POST['etckchildage'.$h]."<::>";
			}else{
				$guest_name .= trim($val)."<::>";
			}
			 $h++;

		}
		if(strstr($key,'bodyweight'))

		{

			$body_weight .= $val."<::>";

		}

	  }



	  $the_extra_query= tep_db_query("select * from ".TABLE_ORDERS_PRODUCTS_ETICKET." where orders_id = '" . (int)$oID . "'");

	  $the_extra= tep_db_fetch_array($the_extra_query);

	  $orders_id= $the_extra['orders_id'];

		if($orders_id == '')

		{

		$products_id = $_GET['products_id'];

		  tep_db_query("INSERT INTO `".TABLE_ORDERS_PRODUCTS_ETICKET."` ( `orders_id` , `products_id` , `guest_name` , `tour_provider` , `tour_arrangement`, `confirmation_date`,`special_note`,`emergency_contact_person`,`emergency_contact_no`,`depature_full_address` )

			VALUES ('$oID', '$products_id', '$guest_name', '$tour_provider', '$tour_arrangement', 'now()', '$special_note', '$emergency_contact_person', '$emergency_contact_no','$depature_full_address'

			);");

		}else

		{

			//处理要删除的客人资料 2010-05-19
			if(tep_not_null($HTTP_POST_VARS['garbage_boxs'])){
				$will_remove_guests = explode("<::>",$HTTP_POST_VARS['garbage_boxs']);
				$old_guest_names = explode("<::>",$guest_name);
				$new_guests = array_diff($old_guest_names, $will_remove_guests );
				$guest_name = implode("<::>",$new_guests)."<::>";
			}
			//处理要添加的客人信息
			if(tep_not_null($HTTP_POST_VARS['new_cus_name'])){
				$cus_name_and_bdate = $HTTP_POST_VARS['new_cus_name'];
				if(tep_not_null($HTTP_POST_VARS['birth_date'])){ $cus_name_and_bdate .= "||".$HTTP_POST_VARS['birth_date']; }
				if(preg_match('/(.+ +\[.+\](\|\|\d\d\/\d\d\/\d\d\d\d)*)/',$cus_name_and_bdate,$m)){	//CN name [En Name]||01/12/2008
					$m[0]= preg_replace('/ +/',' ',$m[0]);
					$guest_name .= str_replace(' [','  [',$m[0])."<::>";
				}
			}
			//更新房间信息
			if(tep_not_null($HTTP_POST_VARS['products_room_info_textarea'])){
				$nr = array("\r\n", "\n", "\r");
				$products_room_info_textarea = str_replace($nr,"<br>",tep_db_prepare_input($HTTP_POST_VARS['products_room_info_textarea']));
				tep_db_query("update ".TABLE_ORDERS_PRODUCTS." set products_room_info='".$products_room_info_textarea."' where orders_id = ".$orders_id." and products_id = ".$_GET['products_id']." ");
			}

			tep_db_query("update ".TABLE_ORDERS_PRODUCTS_ETICKET." set guest_name='".$guest_name."' , tour_provider='".$tour_provider."' , tour_arrangement='".$tour_arrangement."', special_note='".$special_note."', emergency_contact_person='".$emergency_contact_person."', emergency_contact_no='".$emergency_contact_no."', depature_full_address='".$depature_full_address."'  where orders_id = ".$orders_id." and products_id = ".$_GET['products_id']." ");

		}




		$airline_name=tep_db_input($HTTP_POST_VARS['airline_name']);

		$flight_no=tep_db_input($HTTP_POST_VARS['flight_no']);

		$airline_name_departure=tep_db_input($HTTP_POST_VARS['airline_name_departure']);

		$flight_no_departure=tep_db_input($HTTP_POST_VARS['flight_no_departure']);

		$airport_name=tep_db_input($HTTP_POST_VARS['airport_name']);

		$airport_name_departure=tep_db_input($HTTP_POST_VARS['airport_name_departure']);

		$arrival_date=tep_get_date_db(tep_db_input($HTTP_POST_VARS['arrival_date']));

		$arrival_time=tep_db_input($HTTP_POST_VARS['arrival_time']);

		$departure_date=tep_get_date_db(tep_db_input($HTTP_POST_VARS['departure_date']));

		$departure_time=tep_db_input($HTTP_POST_VARS['departure_time']);



	  $the_flight_query= tep_db_query("select * from  ".TABLE_ORDERS_PRODUCTS_FLIGHT." where orders_id = '" . (int)$oID . "'");

	  $the_flight= tep_db_fetch_array($the_flight_query);

	  $orders_id= $the_flight['orders_id'];

		if($orders_id == '')

		{

			$products_id = $_GET['products_id'];

		  tep_db_query("INSERT INTO `".TABLE_ORDERS_PRODUCTS_FLIGHT."` ( `orders_id` , `products_id` , `airline_name` , `flight_no` , `airline_name_departure`, `flight_no_departure`, `airport_name`, `airport_name_departure`, `arrival_date`,`arrival_time`,`departure_date`,`departure_time` )

			VALUES ('$oID', '$products_id', '$airline_name' , '$flight_no' , '$airline_name_departure', '$flight_no_departure', '$airport_name', '$airport_name_departure','$arrival_date','$arrival_time','$departure_date','$departure_time'

			);");

		}else

		{

			tep_db_query("update  ".TABLE_ORDERS_PRODUCTS_FLIGHT." set airline_name='$airline_name' , flight_no='$flight_no' , airline_name_departure='$airline_name_departure', flight_no_departure='$flight_no_departure', airport_name='$airport_name', airport_name_departure='$airport_name_departure', arrival_date='$arrival_date',arrival_time='$arrival_time',departure_date='$departure_date',departure_time='$departure_time' where orders_id = ".$orders_id." and products_id = ".$_GET['products_id']." ");

		}





		$customers_cellphone=tep_db_input($HTTP_POST_VARS['customers_cellphone']);

		$customers_id=tep_db_input($HTTP_POST_VARS['customers_id']);



	  tep_db_query("update  ".TABLE_CUSTOMERS." set customers_cellphone='$customers_cellphone' where customers_id = ".$customers_id."  ");



		tep_redirect(tep_href_link(FILENAME_ORDERS, tep_get_all_get_params(array('action','oID','products_id')).'action=eticket&products_id='.$products_id.'&oID='.$orders_id));

	   break;





      case 'deleteconfirm':



        $oID = tep_db_prepare_input($HTTP_GET_VARS['oID']);

        $restock1 = $HTTP_POST_VARS['restock'];

         if ($restock1== 'on'){

                $restock11 = 'true' ;

                }

        tep_remove_order($oID, $HTTP_POST_VARS['restock']);



        tep_redirect(tep_href_link(FILENAME_ORDERS, tep_get_all_get_params(array('oID', 'action'))));

        break;

    }

  }



  if (($action == 'edit') && isset($HTTP_GET_VARS['oID'])) {

    $oID = tep_db_prepare_input($HTTP_GET_VARS['oID']);



    $orders_query = tep_db_query("select orders_id from " . TABLE_ORDERS . " where orders_id = '" . (int)$oID . "'");

    $order_exists = true;

    if (!tep_db_num_rows($orders_query)) {
tep_redirect(tep_href_link(FILENAME_ORDERS, tep_get_all_get_params(array('oID', 'action')). 'search='.$oID));
      $order_exists = false;

      $messageStack->add(sprintf(ERROR_ORDER_DOES_NOT_EXIST, $oID), 'error');

    }

  }



  if (($action == 'eticket') && isset($HTTP_GET_VARS['oID'])) {

    $oID = tep_db_prepare_input($HTTP_GET_VARS['oID']);



    $orders_query = tep_db_query("select orders_id from " . TABLE_ORDERS . " where orders_id = '" . (int)$oID . "'");

    $order_exists = true;

    if (!tep_db_num_rows($orders_query)) {

      $order_exists = false;

      $messageStack->add(sprintf(ERROR_ORDER_DOES_NOT_EXIST, $oID), 'error');

    }

  }

// BOF: WebMakers.com Added: Additional info for Orders

// Look up things in orders

$the_extra_query= tep_db_query("select * from " . TABLE_ORDERS . " where orders_id = '" . (int)$oID . "'");

$the_extra= tep_db_fetch_array($the_extra_query);

$the_customers_id= $the_extra['customers_id'];

// Look up things in customers

$the_extra_query= tep_db_query("select * from " . TABLE_CUSTOMERS . " where customers_id = '" . $the_customers_id . "'");

$the_extra= tep_db_fetch_array($the_extra_query);

$the_customers_fax= $the_extra['customers_fax'];

$the_customers_mobile_phone= $the_extra['customers_mobile_phone'];

$the_customers_cellphone= $the_extra['customers_cellphone'];


// EOF: WebMakers.com Added: Additional info for Orders



  include(DIR_WS_CLASSES . 'order.php');

?>

<!doctype html public "-//W3C//DTD HTML 4.01 Transitional//EN">

<html <?php echo HTML_PARAMS; ?>>

<head>

<meta http-equiv="Content-Type" content="text/html; charset=<?php echo CHARSET; ?>">

<title><?php echo TITLE; ?></title>

<link rel="stylesheet" type="text/css" href="includes/stylesheet.css">





<link rel="stylesheet" type="text/css" href="includes/javascript/spiffyCal/spiffyCal_v2_1.css">

<script language="JavaScript" src="includes/javascript/spiffyCal/spiffyCal_v2_1.js"></script>



<div id="spiffycalendar" class="text"></div>





<script language="javascript" src="includes/menu.js"></script>
<script language="javascript" src="includes/big5_gb-min.js"></script>

<script language="javascript" src="includes/general.js"></script>

<script language="javascript"><!--

function popupWindow(url) {

  window.open(url,'popupWindow','toolbar=no,location=no,directories=no,status=no,menubar=no,scrollbars=no,resizable=yes,copyhistory=no,width=650,height=500,screenX=150,screenY=150,top=150,left=150')

}

//--></script>

<script type="text/javascript" src="includes/javascript/categories.js"></script>
<?php
$p=array('/&amp;/','/&quot;/');
$r=array('&','"');
?>
<script type="text/javascript">
//创建ajax对象
var ajax = false;
if(window.XMLHttpRequest) {
	 ajax = new XMLHttpRequest();
}
else if (window.ActiveXObject) {
	try {
			ajax = new ActiveXObject("Msxml2.XMLHTTP");
		} catch (e) {
	try {
			ajax = new ActiveXObject("Microsoft.XMLHTTP");
		} catch (e) {}
	}
}
if (!ajax) {
	window.alert("<?php echo db_to_html('不能创建XMLHttpRequest对象实例.')?>");
}
</script>
<script type="text/javascript">
//E-Ticket script start 2010-05-19
function remove_to_garbage_boxs(id,dateid){
	var re_obj = document.getElementById(id);
	var boxs = document.getElementById('garbage_boxs');
	boxs.value += re_obj.value;
	re_obj.style.color = "#CCCCCC";
	re_obj.style.textDecoration = "line-through";
	re_obj.readOnly = true;
	if(dateid!=""){
		var re_date_obj = document.getElementById(dateid);
		if(re_date_obj!=null){
			boxs.value += "||"+re_date_obj.value;
			re_date_obj.style.color = "#CCCCCC";
			re_date_obj.style.textDecoration = "line-through";
			re_date_obj.readOnly = true;
		}
	}
	boxs.value += "<::>";

}

//E-Ticket script end 2010-05-19
</script>

<?php
$display_eticket_itinerary_new_format=false;
if((int)$_GET['oID'] > 10650){
	$display_eticket_itinerary_new_format=true;
}

include('includes/javascript/editor.php');
echo tep_load_html_editor();
echo tep_insert_html_editor('tour_arrangement','advanced','500');

if ((HTML_AREA_WYSIWYG_DISABLE == 'Enable') or (HTML_AREA_WYSIWYG_DISABLE_JPSY == 'Enable')) { ?>

<script language="Javascript1.2"><!-- // load htmlarea

//MaxiDVD Added WYSIWYG HTML Area Box + Admin Function v1.8 <head>

      _editor_url = "<?php echo (($request_type == 'SSL') ? HTTPS_SERVER : HTTP_SERVER) . DIR_WS_ADMIN; ?>htmlarea/";  // URL to htmlarea files

        var win_ie_ver = parseFloat(navigator.appVersion.split("MSIE")[1]);

         if (navigator.userAgent.indexOf('Mac')        >= 0) { win_ie_ver = 0; }

          if (navigator.userAgent.indexOf('Windows CE') >= 0) { win_ie_ver = 0; }

           if (navigator.userAgent.indexOf('Opera')      >= 0) { win_ie_ver = 0; }

       <?php if (HTML_AREA_WYSIWYG_BASIC_PD == 'Basic'){ ?>  if (win_ie_ver >= 5.5) {

       document.write('<scr' + 'ipt src="' +_editor_url+ 'editor_basic.js"');

       document.write(' language="Javascript1.2"></scr' + 'ipt>');

          } else { document.write('<scr'+'ipt>function editor_generate() { return false; }</scr'+'ipt>'); }

       <?php } else{ ?> if (win_ie_ver >= 5.5) {

       document.write('<scr' + 'ipt src="' +_editor_url+ 'editor_advanced.js"');

       document.write(' language="Javascript1.2"></scr' + 'ipt>');

          } else { document.write('<scr'+'ipt>function editor_generate() { return false; }</scr'+'ipt>'); }

       <?php }?>

// --></script>

<?php }

function RTESafe($strText) {

	//returns safe code for preloading in the RTE

	$tmpString = trim($strText);

	//convert all types of single quotes

	$tmpString = str_replace(chr(145), chr(39), $tmpString);

	$tmpString = str_replace(chr(146), chr(39), $tmpString);

	//$tmpString = str_replace("'", "&#39;", $tmpString);

	//convert all types of double quotes

	$tmpString = str_replace(chr(147), chr(34), $tmpString);

	$tmpString = str_replace(chr(148), chr(34), $tmpString);

	//replace carriage returns & line feeds

	$tmpString = str_replace(chr(10), "", $tmpString);

	$tmpString = str_replace(chr(13), "\\n", $tmpString);

	return $tmpString;

}

?>

<script language="javaScript">



	var orderstatussubjectarray = new Array();

	var orderstatuscommentarray = new Array();

	<?php

	  $orders_status_default_email_query = tep_db_query("select orders_status_id, orders_status_name, orders_status_default_subject, orders_status_default_comment  from " . TABLE_ORDERS_STATUS . " where language_id = '" . (int)$languages_id . "'");



	  while($orders_status_default_email_row = mysql_fetch_array($orders_status_default_email_query)){

	  if($orders_status_default_email_row['orders_status_default_comment'] !=''){

	  $orders_status_default_email_row['orders_status_default_comment'] = $orders_status_default_email_row['orders_status_default_comment'] . '\n\n'.TEXT_CHINESE_DEFAULT_AUTO_TEXT_FOOTER;

	  }

	  $orders_status_default_email_row['orders_status_default_comment'] .= '\n\n\n\n'.strip_tags(str_replace('<a></a>', get_login_publicity_name() ,CONFORMATION_EMAIL_FOOTER));

	  echo 'orderstatussubjectarray['.$orders_status_default_email_row['orders_status_id'].'] = "'.RTESafe(str_replace('OID', $HTTP_GET_VARS['oID'] ,$orders_status_default_email_row['orders_status_default_subject'])).'";';
	  if($orders_status_default_email_row['orders_status_id']=='100002'){
	  echo 'orderstatuscommentarray['.$orders_status_default_email_row['orders_status_id'].'] = "'.RTESafe(str_replace('OID', $HTTP_GET_VARS['oID'] ,$orders_status_default_email_row['orders_status_default_comment'])).'\n'.db_to_html('如有任何意见或建议请发送邮件至jiandu@toursforfun.com').'";';
	  }else{

	   echo 'orderstatuscommentarray['.$orders_status_default_email_row['orders_status_id'].'] = "'.RTESafe(str_replace('OID', $HTTP_GET_VARS['oID'] ,$orders_status_default_email_row['orders_status_default_comment'])).'";';

	   }

	  }


	?>



	 function changesubjectemail_new(theform){



		 if(document.status.status.value != ""){

		 	try{

		 	document.status.email_subject.value = orderstatussubjectarray[document.status.status.value];

		 	document. status.comments.value = orderstatuscommentarray[document.status.status.value];

			}catch(e){



			}

		 }

	  return true;

	  }







	 function changesubjectemail(theform){

	  	  if( document.status.status.value == "100001" ){

			document.status.email_subject.value = "Receipt of Reservation";

		 } else if(document.status.status.value == "100002"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_TICKET_ISSUED;?>";

		 	document. status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_TICKET_ISSUED;?>";

		  }else if(document.status.status.value ==  "100000"){

			 document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_CONFIREMED;?>";

			 document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_CONFIREMED;?>";

		  }else if(document.status.status.value ==  "100003"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_UPDATE;?>";

			document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_UPDATE;?><?php echo $HTTP_GET_VARS['oID'];?>";

		  }else if(document.status.status.value ==  "100004"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_RESERVATION_NOT_AVAILABLE;?>";

			document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_RESERVATION_NOT_AVAILABLE;?>";

		  }else if(document.status.status.value ==  "100005"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_REFUNDED;?>";

			 document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_REFUNDED;?>";

		  }else if(document.status.status.value ==  "100006"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_CHARGED_CAPTURED;?>";

			 document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_CHARGED_CAPTURED;?>";

		  }else if(document.status.status.value ==  "100007"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_PAYMENT_ADJUSTED;?>";

			 document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_PAYMENT_ADJUSTED;?>";

		  }else if(document.status.status.value ==  "100008"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_INFORMATION_NEEDED;?>";

			 document. status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_INFORMATION_NEEDED;?>";

		  }else if(document.status.status.value ==  "100009"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_BOOKED_ISSUED;?>";

			 document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_BOOKED_ISSUED;?>";

		  }else if(document.status.status.value ==  "100010"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_CHARGED_AUTHORIZED;?>";

			 document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_CHARGED_AUTHORIZED;?>";

		  }else if(document.status.status.value ==  "5"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_ON_HOLD; ?>";

			document. status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_ON_HOLD;?>";

		  }else if(document.status.status.value ==  "6"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_CANCELLED; ?>";

			document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_CANCELLED;?>";

		  }else if(document.status.status.value ==  "100011"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_CHARGED_FAILED;?>";

			document. status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_CHARGED_FAILED;?>";

		  }else if(document.status.status.value ==  "100012"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_FLIGHT_INFO_NEEDED;?>";

			document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_FLIGHT_INFO_NEEDED;?>";

		  }else if(document.status.status.value ==  "100013"){

  			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_CONFIRMED_DOC_PENDING;?>";

			document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_CONFIRMED_DOC_PENDING;?>";

		  }else if(document.status.status.value ==  "100014"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_CONFIRMED_FULL_DOC_RECEIVED;?>";

			document. status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_CONFIRMED_FULL_DOC_RECEIVED;?>";

		  }else if(document.status.status.value ==  "100015"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_CONFIRMED_PARTIAL_DOC_RECEIVED;?>";

			document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_CONFIRMED_PARTIAL_DOC_RECEIVED;?>";

		  }else if(document.status.status.value == "100016"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_PAYMENT_PENDING;?>";

			 document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_PAYMENT_PENDING;?>";

		  }else if(document.status.status.value == "100017"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_REFUND_REQUEST_RECEIVED;?>";

			document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_REFUND_REQUEST_RECEIVED;?>";

		  }else if(document.status.status.value == "100018"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_HOLD_TO_CHARGE;?>";

			 document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_HOLD_TO_CHARGE;?>";

		  }else if(document.status.status.value == "100019"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_FLIGHT_UPDATE_SENT;?>";

			 document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_FLIGHT_UPDATE_SENT;?>";

		  }else if(document.status.status.value == "100020"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_CANCELLATION_FORM_REQUIRED;?>";

			 document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_CANCELLATION_FORM_REQUIRED;?>";

		  }else if(document.status.status.value == "100021"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_CANCELLATION_REQUEST_RECEIVED;?>";

			 document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_CANCELLATION_REQUEST_RECEIVED;?>";

		  }else if(document.status.status.value == "99999"){

			document.status.email_subject.value = "<?php echo TEXT_EMAIL_SUBJECT_PAYPAL_PROCESSING;?>";

			 document.status.comments.value = "<?php echo TEXT_EMAIL_COMMENENT_PAYPAL_PROCESSING;?>";

		  }

		  return true;

	  }







</script>

</head>

<body marginwidth="0" marginheight="0" topmargin="0" bottommargin="0" leftmargin="0" rightmargin="0" bgcolor="#FFFFFF">

<!-- header //-->

<?php

  require(DIR_WS_INCLUDES . 'header.php');

?>

<!-- header_eof //-->



<!-- body //-->

<table border="0" width="100%" cellspacing="2" cellpadding="2">

  <tr>

    <td width="<?php echo BOX_WIDTH; ?>" valign="top"><table border="0" width="<?php echo BOX_WIDTH; ?>" cellspacing="1" cellpadding="1" class="columnLeft">

<!-- left_navigation //-->

<?php require(DIR_WS_INCLUDES . 'column_left.php'); ?>

<!-- left_navigation_eof //-->

    </table></td>

<!-- body_text //-->

    <td width="100%" valign="top"><table border="0" width="100%" cellspacing="0" cellpadding="2">

<?php

  if (($action == 'edit') && ($order_exists == true)) {

    $order = new order($oID);

?>

      <tr>

        <td width="100%"><table border="0" width="100%" cellspacing="0" cellpadding="0">

          <tr>

            <td class="pageHeading"><?php echo HEADING_TITLE; ?></td>

            <td class="pageHeading" width="15%" align="right"><?php echo tep_draw_separator('pixel_trans.gif', '1', '10'); ?></td>

<?php  //begin PayPal_Shopping_Cart_IPN V2.8 DMG;

if  ((strtolower($order->info['payment_method']) == 'paypal') && (isset($HTTP_GET_VARS['referer'])) && ($HTTP_GET_VARS['referer'] == 'ipn')) { ?>

            <td class="pageHeading" align="right"><?php echo '<a href="' . tep_href_link(FILENAME_PAYPAL, tep_get_all_get_params(array('action','oID','referer'))) . '">' . tep_image_button('button_back.gif', IMAGE_BACK) . '</a>'; ?></td>

<?php } else { ?>



            <td class="pageHeading" align="right"><?php echo '<a href="' . tep_href_link(FILENAME_ORDERS, tep_get_all_get_params(array('action','referer'))) . '">' . tep_image_button('button_back.gif', IMAGE_BACK) . '</a>'; ?></td>

<?php

}

//end PayPal_Shopping_Cart_IPN

?>

<td class="pageHeading" align="right">

<?php echo '<a href="' . tep_href_link("edit_orders.php", tep_get_all_get_params(array('action'))) . '">' . tep_image_button('button_edit.gif', IMAGE_EDIT) . '</a> &nbsp; '; ?></td>
<td>
			<?php echo tep_draw_form('orders', FILENAME_ORDERS, tep_get_all_get_params(array('oID','y','x', 'action')), 'get'); ?>

			<table width="100%" cellpadding="0" cellspacing="0">
			<tr>
			   <td class="smallText"  align="right"><?php echo HEADING_TITLE_SEARCH . ' ' . tep_draw_input_field('oID', '', 'size="12"'). tep_draw_hidden_field('action', 'edit'); ?>				 </td><td>&nbsp;<?php echo tep_image_submit('button_search.gif', IMAGE_SEARCH); ?></td>
				<td class="pageHeading" align="right"><?php echo tep_draw_separator('pixel_trans.gif', '10', '1'); ?></td>
             </tr>
			</table>
			 </form>		</td>
          </tr>

        </table></td>
      </tr>




      <tr>

        <td><table width="100%" border="0" cellspacing="0" cellpadding="2">

          <tr>

            <td colspan="3"><?php echo tep_draw_separator('pixel_trans.gif', '1', '10'); ?></td>
          </tr>

          <tr>

            <td valign="top"><table width="100%" border="0" cellspacing="0" cellpadding="2">

              <tr>

                <td class="main" valign="top"><b><?php echo ENTRY_CUSTOMER; ?></b></td>

                <td class="main"><?php
				echo tep_address_format(1, $order->customer, 1, '', '<br>');
				//echo tep_address_format($order->customer['format_id'], $order->customer, 1, '', '<br>'); ?></td>
              </tr>

              <tr>

                <td colspan="2"><?php echo tep_draw_separator('pixel_trans.gif', '1', '5'); ?></td>
              </tr>

              <tr>

                <td class="main"><b>Office Phone:</b></td>

                <td class="main"><?php echo $order->customer['telephone']; ?></td>
              </tr>

<?php

// BOF: WebMakers.com Added: Downloads Controller - Extra order info

?>

              <tr>

                <td class="main"><b>家庭电话:</b></td>

                <td class="main"><?php echo $the_customers_fax; ?></td>
              </tr>

              <tr>

                <td class="main"><b>客户紧急联系电话:</b></td>

                <td class="main"><?php echo $the_customers_cellphone; ?></td>
              </tr>
              <tr>

                <td class="main"><b>移动电话:</b></td>

                <td class="main"><?php echo $the_customers_mobile_phone; ?></td>
              </tr>

<?php

// EOF: WebMakers.com Added: Downloads Controller

?>

              <tr>

                <td class="main"><b><?php echo ENTRY_EMAIL_ADDRESS; ?></b></td>

                <td class="main"><?php echo '<a href="mailto:' . $order->customer['email_address'] . '"><u>' . $order->customer['email_address'] . '</u></a>'; ?></td>
              </tr>

            </table></td>

            <!--<td valign="top"><table width="100%" border="0" cellspacing="0" cellpadding="2">

              <tr>

                <td class="main" valign="top"><b><?php //echo ENTRY_SHIPPING_ADDRESS; ?></b></td>

                <td class="main"><?php //echo tep_address_format($order->delivery['format_id'], $order->delivery, 1, '', '<br>'); ?></td>

              </tr>

            </table></td>-->

            <td valign="top"><table width="100%" border="0" cellspacing="0" cellpadding="2">

              <tr>

                <td class="main" valign="top"><b><?php echo ENTRY_BILLING_ADDRESS; ?></b></td>

                <td class="main"><?php
				echo tep_address_format(1, $order->billing, 1, '', '<br>');
				//echo tep_address_format($order->billing['format_id'], $order->billing, 1, '', '<br>'); ?></td>
              </tr>

            </table></td>

          </tr>

        </table></td>
      </tr>

      <tr>

        <td><?php echo tep_draw_separator('pixel_trans.gif', '1', '10'); ?></td>
      </tr>

      <tr>

        <td>



<table border="0" cellspacing="0" cellpadding="2">

<?php

// BOF: WebMakers.com Added: Show Order Info

?>

<!-- add Order # // -->

<tr>

<td class="main"><b>Order # </b></td>

<td class="main"><?php echo tep_db_input($oID); ?></td>
</tr>

<!-- add date/time // -->

<tr>

<td class="main"><b>Order Date & Time</b></td>

<td class="main"><?php echo tep_datetime_short($order->info['date_purchased']); ?></td>
</tr>

<?php

// EOF: WebMakers.com Added: Show Order Info



//begin PayPal_Shopping_Cart_IPN V2.8 DMG

if (strtolower($order->info['payment_method']) == 'paypal') {

include(DIR_FS_CATALOG_MODULES . 'payment/paypal/admin/TransactionSummaryLogs.inc.php');

}



?>



          <tr>

            <td class="main"><b><?php echo ENTRY_PAYMENT_METHOD; ?></b></td>

            <td class="main"><?php echo $order->info['payment_method']; ?></td>
          </tr>

<?php

//}//else not paypal

//end PayPal_Shopping_Cart_IPN

    if (tep_not_null($order->info['cc_type']) || tep_not_null($order->info['cc_owner']) || tep_not_null($order->info['cc_number'])) {

if($login_groups_id == '1' || $access_cc_info == 'true'){//amti added for top see top admin and account group  only

?>

          <tr>

            <td colspan="2"><?php echo tep_draw_separator('pixel_trans.gif', '1', '10'); ?></td>
          </tr>

          <tr>

            <td class="main"><?php echo ENTRY_CREDIT_CARD_TYPE; ?></td>

            <td class="main"><?php echo $order->info['cc_type']; ?></td>
          </tr>

          <tr>

            <td class="main"><?php echo ENTRY_CREDIT_CARD_OWNER; ?></td>

            <td class="main"><?php echo $order->info['cc_owner']; ?></td>
          </tr>

          <tr>

            <td class="main"><?php echo ENTRY_CREDIT_CARD_NUMBER; ?></td>

            <td class="main">
			<?php
			if($_GET['show_car_num']=='true' || $login_groups_id=="5"){
				echo $order->info['cc_number'];
			}else{
				echo 'XXXXXXXXXXXX'.substr($order->info['cc_number'],12);
			}
			?>
			</td>
          </tr>

          <tr>

            <td class="main"><?php echo ENTRY_CREDIT_CARD_EXPIRES; ?></td>

            <td class="main"><?php echo $order->info['cc_expires']; ?></td>
          </tr>



			<tr>

            <td class="main"><?php echo ENTRY_CREDIT_CARD_CVV; ?></td>

            <td class="main"><?php echo $order->info['cc_cvv']; ?></td>
          </tr>





<?php
} //amti added for top see top admin and account group  only
  // START - Added for eCheck Payment into database

    } elseif (tep_not_null($order->info['checknumber']) || tep_not_null($order->info['accountnumber']) || tep_not_null($order->info['routingnumber'])) {



// Added this in v2.1 to query the order total amount - Thanks CatDadRick!

    		$order_amt_query= tep_db_query("select text from orders_total where orders_id = '" . (int)$oID . "' and title like '" . "<b>Total:</b>" . "'");

    		$order_amt= tep_db_fetch_array($order_amt_query);

    		$check_amt= $order_amt['text'];

?>



          <tr>

            <td colspan="2"><?php echo tep_draw_separator('pixel_trans.gif', '1', '10'); ?></td>
          </tr>

          <tr>

            <TD COLSPAN="2" ALIGN="left">



<TABLE BORDER="1" CELLSPACING="0" CELLPADDING="2" BORDERCOLOR="#94621F" BGCOLOR="#F1DEB6">

<TR>

	<TD WIDTH="100%">

	<TABLE WIDTH="600" BORDER="1" CELLSPACING="0" CELLPADDING="0" BORDERCOLOR="#94621F">

		<TR>

			<TD WIDTH="100%">

			<TABLE WIDTH="100%" BORDER="0">

				<TR>

					<TD WIDTH="220" ALIGN="left"><span class="smalltext"><?php echo $order->info['accountholder']; ?></span></TD>

					<TD WIDTH="40"> </TD>

					<TD ALIGN="left" colspan="2"><span class="smalltext"><?php echo $order->info['bank']; ?></span></TD>

					<TD ALIGN="right"><span class="smalltext"><STRONG><?php echo $order->info['checknumber']; ?></STRONG>&nbsp;&nbsp;&nbsp;</span></TD>
				</TR>

				<TR>

					<TD ALIGN="left"><span class="smalltext"><?php echo $order->info['address']; ?></span></TD>

					<TD> </TD>

					<TD ALIGN="left" colspan="2"><span class="smalltext"><?php echo $order->info['bankcity']; ?></span></TD>

					<TD> </TD>
				</TR>

				<TR>

					<TD ALIGN="left"><span class="smalltext"><?php echo $order->info['address2']; ?></span></TD>

					<TD> </TD>

					<TD ALIGN="left" colspan="2"><span class="smalltext"><?php echo $order->info['bankphone']; ?></span></TD>

					<TD ALIGN="right"></TD>
				</TR>

				<TR>

					<TD ALIGN="left"><span class="smalltext"><?php echo $order->info['phone']; ?></span></TD>

					<TD> </TD>

					<TD ALIGN="left" colspan="2"> </TD>

					<TD ALIGN="right"></TD>
				</TR>

				<TR>

					<TD HEIGHT="10" COLSPAN="5"> </TD>
				</TR>

				<TR>

					<TD colspan="5">

					<TABLE BORDER="0" WIDTH="100%">

						<TR>

							<TD WIDTH="65" ALIGN="left" VALIGN="top"><span class="smalltext"><STRONG><small><small><?php echo MODULE_PAYMENT_ECHECK_TEXT_PAY_TO; ?></small></small></STRONG></span></TD>

							<TD ALIGN="left" VALIGN="bottom"><span class="smalltext"><?php echo STORE_NAME; ?></span></TD>

							<TD WIDTH="70" ALIGN="left" VALIGN="bottom"><span class="smalltext"><?php echo $check_amt; ?></span></TD>
						</TR>
					</TABLE>



					<TABLE WIDTH="100%" BORDER="0">

						<TR>

							<TD HEIGHT="1" BGCOLOR="#000000"></TD>

							<TD WIDTH="5"></TD>

							<TD WIDTH="70" BGCOLOR="#000000"></TD>
						</TR>
					</TABLE>					</TD>
				</TR>

				<TR>

					<TD HEIGHT="30" COLSPAN="5"> </TD>
				</TR>

				<TR>

					<TD WIDTH="220" ALIGN="left"><span class="smalltext"><STRONG><?php echo MODULE_PAYMENT_ECHECK_TEXT_MEMO; ?></STRONG><U> Order #<?php echo $oID; ?>&nbsp;</U></span></TD>

					<TD WIDTH="40"> </TD>

					<TD> </TD>

					<TD ALIGN="right" colspan="2"><span class="smalltext"><small><small>No Signature Needed&nbsp;</small></small><BR><STRONG>Signature:</STRONG> <small><U>&nbsp;Authorized by E-mail&nbsp;</U></small></span></TD>
				</TR>

				<TR>

					<TD HEIGHT="9" COLSPAN="5"> </TD>
				</TR>

				<TR>

					<TD ALIGN="right">&nbsp;&nbsp;&nbsp;&nbsp;<FONT FACE="MICR E13B" SIZE="2">A<?php echo $order->info['routingnumber']; ?>A</FONT></TD>

					<TD COLSPAN="2" ALIGN="left">&nbsp;&nbsp;&nbsp;<FONT FACE="MICR E13B" SIZE="2"><?php echo $order->info['accountnumber']; ?>C</FONT></TD>

					<TD ALIGN="left" colspan="2"><FONT FACE="MICR E13B" SIZE="2"><?php echo $order->info['checknumber']; ?></FONT></TD>
				</TR>
			</TABLE>			</TD>
		</TR>
	</TABLE>	</TD>
</TR>
</TABLE>				</td>
          </tr>

<?php

    }

// END - Added for eCheck Payment into database

?>
        </table></TD>
      </tr>

       <tr>

        <td><?php echo tep_draw_separator('pixel_trans.gif', '1', '10'); ?></td>
      </tr>
       <tr>
         <td align="right">
		 <?php
		 //检查用户是否收到电子票
		 $eticket_sql = tep_db_query('SELECT email_track_id, email_track_date, email_address FROM `email_track` WHERE orders_id="'.(int)$oID.'" AND email_type="eTicket" ');
		 while($eticket_row =tep_db_fetch_array($eticket_sql)){
			 if((int)$eticket_row['email_track_id']){
				echo '<b style="color: #00CC00;">已收到eTicket邮件！</b> <span style="color: #CCCCCC;">'.$eticket_row['email_track_date']." ".$eticket_row['email_address'].'</span><br>';
			 }
		 }
		 ?>
		 </td>
       </tr>

      <tr>

        <td><table border="0" width="100%" cellspacing="0" cellpadding="2">

          <tr class="dataTableHeadingRow">

            <td class="dataTableHeadingContent"><?php echo TABLE_HEADING_PRODUCTS; ?> <br>行程</td>

            <td class="dataTableHeadingContent"><?php echo TABLE_HEADING_PRODUCTS_MODEL; ?> <br>团号</td>

			<td class="dataTableHeadingContent" ><?php echo TABLE_HEADING_DATE_OF_DEPARTURE; ?></td>

			<td class="dataTableHeadingContent" nowrap="nowrap" ><?php echo 'Guest Names'; ?></td>

			<td class="dataTableHeadingContent" nowrap="nowrap" width="150" ><?php echo 'Room Info'; ?></td>
			<td class="dataTableHeadingContent">
				<?php 
					if(sizeof($order->products)=="1"){
						$display_providers_column=get_if_display_provider_status_history($order->products[0]['id'], $oID);
					}else{
						$display_providers_column=1;
					}
					if($display_providers_column=="0"){
						echo '&nbsp;';
					}else{
						echo TABLE_PROVIDERS_CONFIRMATION;
					}
				?>
			</td>

            <td class="dataTableHeadingContent" align="right" width="1"><?php //echo TABLE_HEADING_TAX; ?></td>
			<?php if($access_full_edit == 'true' || $access_order_cost == 'true') { /*?>
  	    	<td class="dataTableHeadingContent" align="right"><?php echo TABLE_HEADING_COST_PRICE; ?></td>
			<?php */} ?>
			<!--
            <td class="dataTableHeadingContent" align="right" nowrap><?php echo TABLE_HEADING_PRICE_EXCLUDING_TAX; ?></td>

            <td class="dataTableHeadingContent" align="right" nowrap><?php echo TABLE_HEADING_PRICE_INCLUDING_TAX; ?></td>

            <td class="dataTableHeadingContent" align="right"><?php echo TABLE_HEADING_TOTAL_EXCLUDING_TAX; ?></td>

			-->

            <td align="right">
				<table  width="260" border="0" cellspacing="2" cellpadding="2">
				  <tr>
					<td class="dataTableHeadingContent" width="10%" nowrap="nowrap">&nbsp;</td>
					<td width="30%" class="dataTableHeadingContent" align="right" nowrap="nowrap"><?php echo 'Attr. Total';?></td>
					<td width="30%" class="dataTableHeadingContent" align="right"  nowrap="nowrap"><?php echo 'Tour Price';?></td>
					<td width="30%" class="dataTableHeadingContent" align="right" nowrap="nowrap"><?php echo 'Total'; ?></td>
				  </tr>
				</table>			</td>

			<td class="dataTableHeadingContent" align="right">&nbsp;</td>
          </tr>

<?php

$diff_color_count = 0;

    for ($i=0, $n=sizeof($order->products); $i<$n; $i++) {
		$display_providers_comment=get_if_display_provider_status_history($order->products[$i]['id'], $oID);

	$total_attribute_price = 0;
	$total_attribute_price_cost = 0;


	  if(!isset($_SESSION['row_color_'.$order->products[$i]['model'].$oID]) ){
			     $_SESSION['row_color_'.$order->products[$i]['model'].$oID] = tep_get_rand_color($diff_color_count);
				 $diff_color_count++;
			   }


      echo '          <tr  bgcolor="'.$_SESSION['row_color_'.$order->products[$i]['model'].$oID].'">' . "\n" .

           //'            <td class="dataTableContent" valign="top" align="right">' . $order->products[$i]['qty'] . '&nbsp;x</td>' . "\n" .


           '            <td class="dataTableContent" valign="top"> <a target="_blank" href="' . tep_catalog_href_link(FILENAME_PRODUCT_INFO, 'products_id=' . $order->products[$i]['id']) . '">' . $order->products[$i]['name'].'</a>';



      if (isset($order->products[$i]['attributes']) && (sizeof($order->products[$i]['attributes']) > 0)) {

        for ($j = 0, $k = sizeof($order->products[$i]['attributes']); $j < $k; $j++) {

          echo '<br><nobr><small>&nbsp;<i> - ' . $order->products[$i]['attributes'][$j]['option'] . ': ' . $order->products[$i]['attributes'][$j]['value'];

          if ($order->products[$i]['attributes'][$j]['price'] != '0') echo ' (' . $order->products[$i]['attributes'][$j]['prefix'] . $currencies->format($order->products[$i]['attributes'][$j]['price'] * $order->products[$i]['qty'], true, $order->info['currency'], $order->info['currency_value']) . ')';


		  if (($access_full_edit == 'true' || $access_order_cost == 'true') && $order->products[$i]['attributes'][$j]['price_cost'] != '0') {
		  	echo ' (' . $order->products[$i]['attributes'][$j]['prefix'] . $currencies->format($order->products[$i]['attributes'][$j]['price_cost'] * $order->products[$i]['qty'], true, $order->info['currency'], $order->info['currency_value']) . ')';
		  }

          echo '</i></small></nobr>';

		  if($order->products[$i]['attributes'][$j]['prefix'] == '-'){
		 	 $total_attribute_price = $total_attribute_price -  ($order->products[$i]['attributes'][$j]['price'] * $order->products[$i]['qty']);
		     $total_attribute_price_cost = $total_attribute_price_cost - ($order->products[$i]['attributes'][$j]['price_cost'] * $order->products[$i]['qty']);
		  }else{
		 	 $total_attribute_price = $total_attribute_price +  ($order->products[$i]['attributes'][$j]['price'] * $order->products[$i]['qty']);
		     $total_attribute_price_cost = $total_attribute_price_cost + ($order->products[$i]['attributes'][$j]['price_cost'] * $order->products[$i]['qty']);

		  }


        }

      }

	  //单人配房提示
	  $single_pu_tags = get_single_pu_tags($oID,$order->products[$i]['id']);
	  if(tep_not_null($single_pu_tags)){
	  	echo '<div style="color:green">单人配房：'.$single_pu_tags.'</div>';
	  }
      //tom added 日本团添加自带磁带start
      if(in_array($order->products[$i]['model'],$japan_array)){
         echo '<br><nobr><small>&nbsp;<i> -'.db_to_html('带中文磁带').'</i></small></nobr>';
      }
      //tom added 日本团添加自带磁带end
	  //howard added for sub-products and sub-PROVIDER_TOUR_CODE start
	  //取得子团号及子供应商信息
	  $sub_products_sql = tep_db_query('SELECT products_model_sub, products_model_sub_notes, provider_tour_code_sub FROM `products` WHERE products_id ="'.$order->products[$i]['id'].'" ');
	  $sub_products_row = tep_db_fetch_array($sub_products_sql);
	  $sub_provider_html = '';
	  if(tep_not_null($sub_products_row['provider_tour_code_sub'])){
	  	$sub_provider_html = '<div style="color:#999999">'.str_replace(';','<br/>',$sub_products_row['provider_tour_code_sub']).'</div>';
	  }

	  $sub_model_html = '';
	  $sub_model = array();
	  $hidden_big_button = false;
	  if(tep_not_null($sub_products_row['products_model_sub'])){
		  $sub_model = explode(';',$sub_products_row['products_model_sub']);
		  foreach($sub_model as $key => $val){

			$tmp_array = explode('-',$val);
			//$sub_agency_id = preg_replace('/(\D+)/','',$tmp_array[0]);
			if(preg_match('/(\d+)$/',$tmp_array[0],$m)){
				$sub_agency_id = $m[1];
			}
			$sub_products_id = (int)$tmp_array[1];
			$sub_model_html .= '<div style="color:#999999">'.$val.'<a target="_blank" href="'.tep_href_link(FILENAME_ORDERS_FAX, tep_get_all_get_params(array('oID', 'action','i','products_id','update_fax')) . 'oID=' . $oID . '&sub_products_id='.$sub_products_id.'&sub_agency_id='.$sub_agency_id.'&products_id='.$order->products[$i]['id']. '&action=fax_show&i='.$i) . '" title="fax">' . tep_image_button('fax_min.gif', '') . '</a>&nbsp;<a target="_blank" href="'.tep_href_link(FILENAME_ORDERS_FAX, tep_get_all_get_params(array('oID', 'action','i','products_id','update_fax')) . 'oID=' . $oID . '&sub_products_id='.$sub_products_id.'&sub_agency_id='.$sub_agency_id.'&products_id='.$order->products[$i]['id']. '&action=fax_show&update_fax=true&i='.$i) . '" title="UpDate Fax">' . tep_image_button('up_fax_min.gif', '') . '</a></div>';
			$hidden_big_button = true;
		  }
	  }
	  if(tep_not_null($sub_products_row['products_model_sub_notes'])){
	  	$sub_model_html .= '<div style="background-color:#fddffb;padding:2px; margin-top:8px;">'.db_to_html($sub_products_row['products_model_sub_notes']).'</div>';
	  }


	  //howard added for sub-products and sub-PROVIDER_TOUR_CODE end

	  echo '            </td>' . "\n" .

           '            <td class="dataTableContent" valign="top" nowrap>
		   				<a target="_blank" href="' . tep_href_link(FILENAME_CATEGORIES, 'cPath=' . tep_get_products_catagory_id($order->products[$i]['id']) . '&pID=' . $order->products[$i]['id'].'&action=new_product&tabedit=eticket') . '">' . $order->products[$i]['model'] . '</a>

						<br/>
						'.$sub_model_html.'
						<br/>
						<br/>
						<b>'.TABLE_HEADING_PROVIDER_TOUR_CODE.'</b><br/>
						<a target="_blank" href="' . tep_href_link(FILENAME_CATEGORIES, 'cPath=' . tep_get_products_catagory_id($order->products[$i]['id']) . '&pID=' . $order->products[$i]['id'].'&action=new_product&tabedit=eticket') . '">' . tep_get_provider_tourcode($order->products[$i]['id']) . '</a>
						<br/>
						'.$sub_provider_html.'
						<br/>
						</td>' . "\n";
						$disp_flight_info = get_flignt_info_popup($oID, $order->products[$i]['id']);
		    echo '            <td class="dataTableContent" valign="top">' . $order->products[$i]['products_departure_date'].'&nbsp;'.$order->products[$i]['products_departure_time'] . '<br /><br /><b>'.TABLE_HEADING_PLACE_OF_DEPARTURE.'</b><br />'. $order->products[$i]['products_departure_location']  .($disp_flight_info!=''?'<br />'.$disp_flight_info:'').'</td>' . "\n" .
		    '            <td class="dataTableContent" valign="top">'.tep_get_products_guest_names_lists($oID,$order->products[$i]['id'],$order->products[$i]['products_departure_date']).'</td>' . "\n" .
		 	'            <td class="dataTableContent" valign="top">';
					$finalrommstring = str_replace('No','Number',$order->products[$i]['products_room_info']);
					$finalrommstring = str_replace('no','Number',$finalrommstring);
					$finalrommstring = str_replace('room','Room',$finalrommstring);
					$finalrommstring = str_replace('childs','children',$finalrommstring);
					$finalrommstring = $order->products[$i]['products_room_info'];
					if(eregi('- Total :',stripslashes($finalrommstring))){
						$req_roomarray = explode('- Total :',stripslashes($finalrommstring));
					}else if(eregi(TEXT_SHOPPIFG_CART_NO_ROOM_TOTAL,stripslashes($finalrommstring))){
						$req_roomarray[0] = str_replace("<br>".TEXT_SHOPPIFG_CART_NO_ROOM_TOTAL." :",'',stripslashes($finalrommstring));
						$req_roomarray[0] = preg_replace('/[[:space:]](\$|\&#65509;)[0-9\,]*.[0-9]+/', '',$req_roomarray[0]);
					}else if(eregi(TEXT_TOTLE_OF_ROOM_STRING_CHECK,stripslashes($finalrommstring))){
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM1,'',stripslashes($finalrommstring));
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM2,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM3,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM4,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM5,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM6,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM7,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM8,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM9,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM10,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM11,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM12,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM13,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM14,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM15,'',$req_roomarray[0]);
						$req_roomarray[0] = preg_replace('/[[:space:]](\$|\&#65509;)[0-9\,]*.[0-9]+/', '',$req_roomarray[0]);
					}else{
						$req_roomarray[0] = preg_replace('/Total[[:space:]]of[[:space:]]room[[:space:]][0-9]+:[[:space:]](\$|\&#65509;)[0-9\,]*.[0-9]+/', '', stripslashes($finalrommstring));
					}

					if(get_products_departure_date_num($order->products[$i]['id']) <= 1){
						//$req_roomarray[0] = '';
					}

						echo $req_roomarray[0];
						echo '</td>' . "\n" ;

//		   '            <td class="dataTableContent" align="right" valign="top"></td>'; //' . tep_display_tax_value($order->products[$i]['tax']) . '%
					if($display_providers_comment=='1'){
		echo '	    <td class="dataTableContent" align="left" valign="top">
			 '		.($is_gift_certificate_tour==true?'&nbsp;':TEXT_SEAT_NO.' '.$order->products[$i]['customer_seat_no'].'<br />'.
			 		TEXT_BUS_NO.' '.$order->products[$i]['customer_bus_no'].'<br />'.
			 		TEXT_CONFIRMATION_NO.' '.$order->products[$i]['customer_confirmation_no'].'<br />'.
					TEXT_INVOICE_NO.' '.$order->products[$i]['customer_invoice_no'].'<br />'.
					TEXT_INVOICE_TOTAL.' '.$order->products[$i]['customer_invoice_total'].'<br />'.
					TEXT_INVOICE_COMMENT.' '.$order->products[$i]['customer_invoice_comment']).
				tep_draw_form('edit_order_'.$order->products[$i]['orders_products_id'], FILENAME_ORDERS, tep_get_all_get_params(array('action')) . 'action=update_order','post','id="edit_order_'.$order->products[$i]['orders_products_id'].'"').tep_draw_hidden_field('orders_id', $_GET['oID']).
			 '<table class="dataTableContent"><tr>';
			 	$pro_status_array=array();
				$qry_pro_status ="select * from " . TABLE_PROVIDER_ORDER_PRODUCTS_STATUS ." os WHERE os.provider_order_status_for=0 ORDER BY os.sort_order ASC, os.provider_order_status_name ASC"; 
				$res_pro_status=tep_db_query($qry_pro_status);
				$pro_status_array[] = array('id' => 0,
											'text' => SELECT_NONE);
				while ($row_pro_status = tep_db_fetch_array($res_pro_status)) {
				$pro_status_array[] = array('id' => $row_pro_status['provider_order_status_id'],
										'text' => $row_pro_status['provider_order_status_name']);
				}
			$txt_provider_status_name=tep_db_prepare_input($order->products[$i]['provider_order_status_name']);
			$txt_admin_last_status_name=tep_db_prepare_input($order->products[$i]['admin_last_status_name']);
			$txt_provider_comment=tep_db_prepare_input($order->products[$i]['provider_comment']);
			$txt_admin_last_comment=tep_db_prepare_input($order->products[$i]['admin_last_comment']);
			$ajax_response_div_id='ajax_pro_conf_response_'.$order->products[$i]['orders_products_id'];
			echo '<td class="' . $RowStyle . '" rowspan="2" valign="middle">';
			if($is_gift_certificate_tour==true){
				echo '&nbsp;';
			}else{
				echo '<div id="'.$ajax_response_div_id.'">';
					//if(!tep_not_null($order->products[$i]['provider_order_status_id']) || $order->products[$i]['provider_order_status_id']=="1"){
						echo TEXT_PROVIDERS_LAST_STATUS.'<br />'.$txt_provider_status_name.' - '.$txt_provider_comment.'<br />';
						echo TEXT_ADMIN_LAST_STATUS.'<br />'.$txt_admin_last_status_name.' - '.$txt_admin_last_comment.'<br />';
						echo	TEXT_MESSAGE_TO_PROVIDER.'<br />'.
						tep_draw_hidden_field('products_id_'.$order->products[$i]['orders_products_id'], $order->products[$i]['id']).
						tep_draw_textarea_field('provider_comment_'.$order->products[$i]['orders_products_id'], $wrap, 25, 3, '').'<br />';
						echo tep_draw_pull_down_menu('provider_order_status_id_'.$order->products[$i]['orders_products_id'], $pro_status_array, 0).'<br />';
						$ajax_pro_conf_params='onclick="sendFormData(\'edit_order_'.$order->products[$i]['orders_products_id'].'\',\''. tep_href_link(FILENAME_ORDERS, 'action=act_providers_conf&ajax_formname=orders&opID='.$order->products[$i]['orders_products_id']).'\', \''.$ajax_response_div_id.'\',\'true\');"';
						echo tep_draw_input_field('btnProvidersConfirmation_'.$order->products[$i]['orders_products_id'], TXT_SEND_MESSAGE,$ajax_pro_conf_params,false,'button');
				/*}else{
						echo $txt_provider_comment;
				}*/
				echo '</div>';
			}
		echo '</td></tr></table></form>
			 </td>';
	}else{
		echo '<td class="dataTableContent" align="left" valign="top">&nbsp;</td>';
	}
		echo '	    <td class="dataTableContent" align="left" valign="top">&nbsp;</td>';

		 if($access_full_edit == 'true' || $access_order_cost == 'true') {
			//echo '            <td class="dataTableContent" align="right" valign="top"><b>' . $currencies->format($order->products[$i]['final_price_cost'], true, $order->info['currency'], $order->info['currency_value']) . '</b></td>';
		 }


         echo  '            <td class="dataTableContent" align="right" valign="top">';
		 // <b>' . $currencies->format($order->products[$i]['final_price'], true, $order->info['currency'], $order->info['currency_value']) . '</b>

	?>
			<table width="260" border="0" cellspacing="2" cellpadding="2">
					  <tr>
						<td class="dataTableContent" width="10%"><b>Retail</b></td>
						<td width="30%" class="dataTableContent" align="right" nowrap="nowrap"><b><?php
						echo $currencies->format($total_attribute_price, true, $order->info['currency'], $order->info['currency_value']);
						?></b></td>
						<td width="30%" class="dataTableContent" align="right"  nowrap="nowrap"><b><?php
						$retail_pr_tt = $order->products[$i]['final_price'];

						echo $currencies->format($retail_pr_tt - $total_attribute_price, true, $order->info['currency'], $order->info['currency_value']);
						?></b></td>
						<td width="30%" class="dataTableContent" align="right" nowrap="nowrap"><?php echo '<b>' . $currencies->format($retail_pr_tt, true, $order->info['currency'], $order->info['currency_value']) . '</b>'; ?></td>
					  </tr>
					  <?php if($access_full_edit == 'true' || $access_order_cost == 'true') { ?>
					    <?php /*?><tr bgcolor="#FDDFFB">
						<td  class="dataTableContent" align="right" style="color:#FF0000" nowrap="nowrap"><b>Attribute Cost</b></td>
						<td  class="dataTableContent" align="right" style="color:#FF0000"  nowrap="nowrap"><b>Tour Cost</b></td>
						<td  class="dataTableContent" align="right"  style="color:#FF0000" nowrap="nowrap"><b>Total</b></td>
						</tr><?php */?>
					   <tr bgcolor="#FDDFFB">
						<td class="dataTableContent"><b>Cost</b></td>
						<td  class="dataTableContent" align="right" nowrap="nowrap"><b><?php
						if($total_attribute_price > 0 &&  $total_attribute_price_cost == 0){
							echo 'N/A';
						}else{
						echo $currencies->format($total_attribute_price_cost, true, $order->info['currency'], $order->info['currency_value']);
						}
						?></b></td>
						<td  class="dataTableContent" align="right"  nowrap="nowrap"><b><?php
						$retail_pr_tt_cost = $order->products[$i]['final_price_cost'];
						echo $currencies->format($retail_pr_tt_cost - $total_attribute_price_cost, true, $order->info['currency'], $order->info['currency_value']);
						?></b></td>
						<td  class="dataTableContent" align="right" nowrap="nowrap"><?php echo '<b>' . $currencies->format($retail_pr_tt_cost, true, $order->info['currency'], $order->info['currency_value']) . '</b>'; ?></td>
					  </tr>
					  <?php } ?>
					  <?php
					  if($order->products[$i]['operate_currency_exchange_code'] != 'USD' && $order->products[$i]['operate_currency_exchange_code'] != '' && $order->products[$i]['operate_currency_exchange_value'] != 0){
					  ?>
					  <tr>
					  	<td colspan="4" align="right" class="dataTableContent" style="color:#007900 ">
							<?php
								$converted_usd = 1/$order->products[$i]['operate_currency_exchange_value'];
								echo '(1 '.$order->products[$i]['operate_currency_exchange_code'].' = '. number_format($converted_usd, 3) .' USD)';
							?>
						</td>
					  </tr>
					  <?php
					  }
					  ?>
		  </table>

		<?php
echo	'</td>' ;
/*
        echo   '            <td class="dataTableContent" align="right" valign="top"><b>' . $currencies->format(tep_add_tax($order->products[$i]['final_price'], $order->products[$i]['tax']), true, $order->info['currency'], $order->info['currency_value']) . '</b></td>' . "\n" .

           '            <td class="dataTableContent" align="right" valign="top"><b>' . $currencies->format($order->products[$i]['final_price'] * $order->products[$i]['qty'], true, $order->info['currency'], $order->info['currency_value']) . '</b></td>' . "\n" .

           '            <td class="dataTableContent" align="right" valign="top"><b>' . $currencies->format(tep_add_tax($order->products[$i]['final_price'], $order->products[$i]['tax']) * $order->products[$i]['qty'], true, $order->info['currency'], $order->info['currency_value']) . '</b></td>' . "\n";

*/
	  echo '<td class="dataTableContent" align="left" valign="top">';
	  if($hidden_big_button==false){	//在没有小传真按钮时才显示大按钮
	  	echo '            <a  href="' .  tep_href_link(FILENAME_ORDERS_FAX, tep_get_all_get_params(array('oID', 'action','i','products_id','update_fax', 'auto_submit')) . 'oID=' . $oID . '&products_id='.$order->products[$i]['id']. '&action=fax_show&i='.$i) . '" title="Fax">' . tep_image_button('button_fax.gif', '') . '</a><br/><a  href="' .  tep_href_link(FILENAME_ORDERS_FAX, tep_get_all_get_params(array('oID', 'action','i','products_id','update_fax', 'auto_submit')) . 'oID=' . $oID . '&products_id='.$order->products[$i]['id']. '&action=fax_show&update_fax=true&i='.$i) . '" title="Update Fax">' . tep_image_button('button_update_fax.gif', '') . '</a><br />
	  <a  href="' .  tep_href_link(FILENAME_ORDERS_FAX, tep_get_all_get_params(array('oID', 'action','i','products_id','update_fax', 'auto_submit')) . 'oID=' . $oID . '&products_id='.$order->products[$i]['id']. '&action=fax_show&i='.$i.'&auto_submit=1') . '" title="Preview Fax" target="_blank">' . tep_image_button('button_preview_fax.gif', '') . '</a>';
	  }
	  echo '<br/><a href="' . tep_href_link(FILENAME_ORDERS, tep_get_all_get_params(array('oID', 'action','i','products_id')) . 'oID=' . $oID . '&products_id='.$order->products[$i]['id']. '&action=eticket&i='.$i) . '">' . tep_image_button('button_eticket.gif', IMAGE_EDIT) . '</a>';

	    //根据电子票中的人数判断买二送一标准
		$eticket_sql = tep_db_query('SELECT guest_name  FROM `orders_product_eticket` WHERE orders_id ="'.(int)$oID.'" AND products_id="'.(int)$order->products[$i]['id'].'" limit 1');
		$eticket_row = tep_db_fetch_array($eticket_sql);
		$tmp_array = explode("<::>",$eticket_row['guest_name']);
		/*if(count($tmp_array) <=3){
			$is_buy_two_get_one=false;
		}*/
		$pep_num = (count($tmp_array)-1);
	  //如果该是买二送一团以及订购人数超过或等於3人就是买二送一或二
		$is_buy_two_get_one = check_buy_two_get_one($order->products[$i]['id'], $pep_num, endate_to_dbdate($order->products[$i]['products_departure_date']));

		if($pep_num=='3'){
			if($is_buy_two_get_one=='1' || $is_buy_two_get_one =='2'){
				echo '<br><b style="color:#FF0000">买二送一团</b>';
			}
		}else if($pep_num=='4'){
			if($is_buy_two_get_one=='1' || $is_buy_two_get_one =='3'){
				echo '<br><b style="color:#FF0000">买二送二团</b>';
			}
			if($is_buy_two_get_one =='2'){
				echo '<br><b style="color:#FF0000">买二送一团</b>';
			}

		}

	  //结伴同游
	  if(is_travel_comp((int)$oID, (int)$order->products[$i]['id']) > 0 ){
	  	echo '<br><b style="color:#FF9900">结伴同游团</b>';
	  }
	  //结伴同游end

	  //团购提示
	  if($order->products[$i]['group_buy_discount']>0){
	  	echo '<br><b style="color:#006699">团体预定优惠：-'.$currencies->format($order->products[$i]['group_buy_discount'], true, $order->info['currency'], $order->info['currency_value']).'</b>';
	  }
	  //团购提示end


	  echo '</td>' . "\n";

      echo '          </tr>' . "\n";

    }

?>

          <tr>

            <td align="right" colspan="7"><table border="0" cellspacing="0" cellpadding="2">

<?php

    for ($i = 0, $n = sizeof($order->totals); $i < $n; $i++) {
 		if( ( $order->totals[$i]['class'] != 'ot_tax' &&  $order->totals[$i]['class'] != 'ot_shipping')  ||  ($order->totals[$i]['value'] > 0 ) ){
			  echo '              <tr>' . "\n" .

				   '                <td align="right" class="smallText">' . $order->totals[$i]['title'] . '</td>' . "\n" .

				   '                <td align="right" class="smallText">' . $order->totals[$i]['text'] . '</td>' . "\n" .

				   '              </tr>' . "\n";
		}

    }


	if($access_full_edit == 'true' || $access_order_cost == 'true') {
		 $select_order_totles_cost_query = tep_db_query("select title, text from " . TABLE_ORDERS_TOTAL . " where orders_id = '" . (int)$oID . "' and class='ot_cost' order by sort_order");
		 if($select_order_totles_cost_row = tep_db_fetch_array($select_order_totles_cost_query)){
		  echo '              <tr>' . "\n" .

			   '                <td align="right" class="smallText">' . $select_order_totles_cost_row['title'] . '</td>' . "\n" .

			   '                <td align="right" class="smallText">' . $select_order_totles_cost_row['text'] . '</td>' . "\n" .

			   '              </tr>' . "\n";
		 }




	 }

	 //amit added to show cost total for admin
	if($access_full_edit == 'true' || $access_order_cost == 'true') {

				  echo '       <tr>' . "\n" .

			   '                <td align="right" class="smallText">Cost:</td>' . "\n" .

			   '                <td align="right" class="smallText"><b>' . $currencies->format($order->info['order_cost'], true, $order->info['currency'], $order->info['currency_value']) . '</b></td>' . "\n" .

			   '              </tr>' . "\n";

	}

	//amit added to show cost total for admin

?>

            </table></td>
          </tr>

        </table></td>
      </tr>

      <tr>

        <td><?php echo tep_draw_separator('pixel_trans.gif', '1', '10'); ?></td>
      </tr>
	  	<?php
			$n = sizeof($order->products);
			if($n > 0){
		?>
			<tr><td><strong><?php echo TXT_PROVIDER_INFO;?></strong></td></tr>
			<tr>
				<td>
					<table cellpadding="0" cellspacing="0" border="1">
						<tr>
							<td>
								<table cellpadding="5" cellspacing="0" border="0" class="smallText">
									<tr><td class="border_bot1">&nbsp;</td></tr>
									<tr><td class="border_bot1"><strong><?php echo TXT_PRO_CONTACT_PERSON;?></strong></td></tr>
									<tr><td class="border_bot1"><strong><?php echo TXT_PRO_COMPANY;?></strong></td></tr>
									<tr><td><strong><?php echo TXT_PRO_TELEPHONE;?></strong></td></tr>
								</table>
							</td>

						<?php
						for($i = 0; $i < $n; $i++){
							$qry_provider_info = "select a.agency_id, a.contactperson, a.agency_name, a.phone, p.products_id, p.products_model from ".TABLE_PRODUCTS." as p, ".TABLE_TRAVEL_AGENCY." as a where p.agency_id = a.agency_id AND p.products_id = '".(int)$order->products[$i]['id']."'";
							$res_provider_info = tep_db_query($qry_provider_info);
							$row_provider_info = tep_db_fetch_array($res_provider_info);
						?>
							<td>
								<table cellpadding="5" cellspacing="0" border="0" class="smallText">
									<tr><td class="border_bot1"><strong><?php echo tep_db_prepare_input($row_provider_info['products_model']);?></strong></td></tr>
									<tr><td class="border_bot1"><?php echo tep_db_prepare_input($row_provider_info['contactperson']);?></td></tr>
									<tr><td class="border_bot1"><?php echo tep_db_prepare_input($row_provider_info['agency_name']);?></td></tr>
									<tr><td><?php echo tep_db_prepare_input($row_provider_info['phone']);?></td></tr>
								</table>
							</td>
					<?php }?>
						</tr>
					</table>
				</td>
			</tr>
			<tr>
        <td><?php echo tep_draw_separator('pixel_trans.gif', '1', '10'); ?></td>
      </tr>
		<?php }?>
	  <tr>
	  <td>
	  <?php
	  //结伴同游订单 howard added
	  include('orders_travel_comp.php');
	  ?>
	  </td>
	  </tr>
      <tr>

        <td><?php echo tep_draw_separator('pixel_trans.gif', '1', '10'); ?></td>
      </tr>

      <tr>

        <td class="main"><b>History</b></td>
      </tr>
      <tr>

        <td class="main"><table border="1" cellspacing="0" cellpadding="5">

          <tr>

            <td class="smallText" align="center"><b><?php echo TABLE_HEADING_DATE_ADDED; ?></b></td>

			<td class="smallText" align="center"><b><?php echo TABLE_HEADING_UPDATED_BY; ?></b></td>

            <td class="smallText" align="center"><b><?php echo TABLE_HEADING_CUSTOMER_NOTIFIED; ?></b></td>

            <td class="smallText" align="center"><b><?php echo TABLE_HEADING_STATUS; ?></b></td>

            <td class="smallText" align="center"><b><?php echo TABLE_HEADING_COMMENTS; ?></b></td>
          </tr>

<?php

    $orders_history_query = tep_db_query("select orders_status_id, date_added, customer_notified, comments, updated_by from " . TABLE_ORDERS_STATUS_HISTORY . " where orders_id = '" . tep_db_input($oID) . "' order by orders_status_history_id");

    if (tep_db_num_rows($orders_history_query)) {

      while ($orders_history = tep_db_fetch_array($orders_history_query)) {

        echo '          <tr>' . "\n" .

             '            <td class="smallText" align="center">' . tep_datetime_short($orders_history['date_added']) . '</td>' . "\n" .

 			 '            <td class="smallText" align="center">' . tep_get_admin_customer_name($orders_history['updated_by']) . '&nbsp;</td>' . "\n" .

             '            <td class="smallText" align="center">';

        if ($orders_history['customer_notified'] == '1') {

          echo tep_image(DIR_WS_ICONS . 'tick.gif', ICON_TICK) . "</td>\n";

        } else {

          echo tep_image(DIR_WS_ICONS . 'cross.gif', ICON_CROSS) . "</td>\n";

        }

        echo '            <td class="smallText">' . $orders_status_array[$orders_history['orders_status_id']] . '</td>' . "\n" .

             '            <td class="smallText">' . nl2br(tep_db_output($orders_history['comments'])) . '&nbsp;</td>' . "\n" .

             '          </tr>' . "\n";

      }

    } else {

        echo '          <tr>' . "\n" .

             '            <td class="smallText" colspan="5">' . TEXT_NO_ORDER_HISTORY . '</td>' . "\n" .

             '          </tr>' . "\n";

    }

?>

        </table></td>
      </tr>
	     <tr>

                                    <td><?php echo tep_draw_separator('pixel_trans.gif', '1', '10'); ?></td>
                                </tr>
                    <?php
//tom added china  bank
                                            $bank_query = tep_db_query('SELECT * FROM `domestic_orders` WHERE orders_id = "' . tep_db_input($oID) . '"');
                                            $bank_rows = tep_db_fetch_array($bank_query);
                                            if ((int) $bank_rows['orders_id']) {
                    ?>

                                                <tr>
                                                    <td class="main"><b>中国国内订单状态操作历史</b></td>
                                                </tr>
                                                <tr>
                                                    <td class="main"><table border="1" cellspacing="0" cellpadding="5">
                                                            <tr>
                                                                <td class="smallText" align="center"><b>操作人</b></td>
                                                                <td class="smallText" align="center"><b>更新状态</b></td>
                                                                <td class="smallText" align="center"><b>转账金额</b></td>
                                                                <td class="smallText" align="center"><b>实际收款</b></td>
                                                                <td class="smallText" align="center"><b>更新时间</b></td>
                                                                <td class="smallText" align="center"><b>备注</b></td>
                                                            </tr>
                                <?php
                                                $operation_history_query = tep_db_query('SELECT * FROM `domestic_orders_history` WHERE orders_id = "' . tep_db_input($oID) . '"ORDER BY `update_time` ASC');
                                                while ($operation_history_rows = tep_db_fetch_array($operation_history_query)) {
                                ?>
                                                    <tr>
                                                        <td class="smallText" align="center"><?= tep_get_admin_customer_name($operation_history_rows['admin_id']) ?></td>
                                                <td class="smallText" align="center"><?= $operation_history_rows['manager_history']
                                ?></td>
                                                <td class="smallText" align="center"><?= $bank_rows['dransfer_total']
                                ?></td>
                                                <td class="smallText" align="center"><?= $bank_rows['real_charge'] ?></td>
                                                <td class="smallText" align="center"><?= $operation_history_rows['update_time']
                                ?></td>
                                                <td class="smallText" align="center"><?= $operation_history_rows['notes'] ?></td>
                                            </tr>
                                <?php }
                                ?>
                                            </table></td></tr>

                    <?php
                                            }
                    ?>
			
<?php
//<!-- Order product status history -Start -->
	$qry_order_prod_history = "select h.popc_id, h.provider_comment, h.provider_status_update_date, h.popc_user_type, s.provider_order_status_name, op.products_id, op.products_model, if(h.popc_user_type=0, h.popc_updated_by, p.agency_id) as updated_by, popc_updated_by, p.agency_id 
			FROM " . TABLE_PROVIDER_ORDER_PRODUCTS_STATUS_HISTORY . " h, ".TABLE_PROVIDER_ORDER_PRODUCTS_STATUS." s, ".TABLE_ORDERS_PRODUCTS." op, ".TABLE_PRODUCTS." p, ".TABLE_TRAVEL_AGENCY." ta
			WHERE 
				h.provider_order_status_id=s.provider_order_status_id AND 
				h.orders_products_id=op.orders_products_id AND 
				op.products_id=p.products_id AND 
				p.agency_id=ta.agency_id AND
				h.notify_tours4fun=1 AND
				op.orders_id = '" . tep_db_input($oID) . "' ORDER BY p.products_id ASC, h.provider_status_update_date DESC";
    $res_order_prod_history = tep_db_query($qry_order_prod_history);
if (tep_db_num_rows($res_order_prod_history)){
?>
	<tr>
		<td class="main"><br><b><?php echo TEXT_PROVIDER_STATUS_HISTORY; ?></b></td>
	</tr>
	<tr>
        <td class="main"><table border="1" cellspacing="0" cellpadding="5">
          <tr>
						<td class="smallText"><b><?php echo TABLE_HEADING_PRODUCTS_MODEL; ?></b></td>
            <td class="smallText" align="center"><b><?php echo TABLE_HEADING_DATE_ADDED; ?></b></td>
 						<td class="smallText" align="center"><b><?php echo TABLE_HEADING_UPDATED_BY; ?></b></td>
            <td class="smallText" align="center"><b><?php echo TABLE_HEADING_STATUS; ?></b></td>
            <td class="smallText" align="center"><b><?php echo TABLE_HEADING_COMMENTS; ?></b></td>
          </tr>
<?php
			$previous_prod_id="";
      while ($row_order_prod_history = tep_db_fetch_array($res_order_prod_history))
	  	{
				if($row_order_prod_history['popc_user_type']=='0'){
					$status_updated_by=STORE_NAME." - ";
					$bgcolor="#FFC0CB";
				}else{
					$status_updated_by=tep_get_providers_agency($row_order_prod_history['agency_id'], 1)." - ";
					$bgcolor="#33FF99";
				}
				if((int)$row_order_prod_history['popc_updated_by']>0){
					$status_updated_by.=tep_get_admin_customer_name($row_order_prod_history['popc_updated_by'], (int)$row_order_prod_history['popc_user_type']);
				}else{
					$status_updated_by.=$row_order_prod_history['popc_updated_by'];
				}
				
				if($row_order_prod_history['products_id']!=$previous_prod_id){
					$previous_prod_id=$row_order_prod_history['products_id'];
					echo '<tr><td class="smallText" align="left" colspan="5"><strong>' . $row_order_prod_history['products_model'] . '</strong></td></tr>';
				}
				
        echo '          <tr bgcolor="'.$bgcolor.'">' . "\n" .
							'            <td class="smallText" align="left" bgcolor="'.$_SESSION['row_color_'.$row_order_prod_history['products_model'].$oID].'">' . $row_order_prod_history['products_model'] . '</td>' . "\n" .
             '            <td class="smallText" align="center">' . tep_datetime_short($row_order_prod_history['provider_status_update_date']) . '</td>' . "\n" .
 			 '            <td class="smallText" align="center">' . $status_updated_by . '&nbsp;</td>' . "\n";
        echo '            <td class="smallText">' . $row_order_prod_history['provider_order_status_name'] . '</td>' . "\n" .
             '            <td class="smallText">' . html_entity_decode(stripslashes($row_order_prod_history['provider_comment'])) . '&nbsp;</td>' . "\n" .
             '          </tr>' . "\n";
      }
    /*} else {
        echo '          <tr>' . "\n" .
             '            <td class="smallText" colspan="5">' . TEXT_NO_PROVIDER_STATUS_HISTORY . '</td>' . "\n" .
             '          </tr>' . "\n";
    }*/
?>
        </table></td>
      </tr>
<?php //<!-- Order product status history -End -->
}?>

	  <?php
	  	$select_check_order_product_history_sql = "select op.orders_products_id, oph.final_price_reference, oph.ord_prod_history_id, oph.cost, oph.retail, oph.last_updated_date, oph.invoice_number, oph.invoice_amount, oph.updated_by, oph.comment, op.products_id, op.products_model, op.products_name ,op.payment_paid, oph.products_model as oph_model, oph.products_name as oph_name from " .TABLE_ORDERS_PRODUCTS_UPDATE_HISTORY. " oph, ".TABLE_ORDERS_PRODUCTS." op where oph.orders_products_id=op.orders_products_id and op.orders_id='".$oID."'  order by oph.ord_prod_history_id ";
		$select_check_order_product_history_row = tep_db_query($select_check_order_product_history_sql);

		if(tep_db_num_rows($select_check_order_product_history_row) > 0){
	   ?>
    <tr>
        <td class="main"><br><b><?php echo 'Price Update History'; ?></b></td>
       </tr>

	  <tr>
        <td class="main">
			<table border="1" cellspacing="0" cellpadding="5">
			  <tr>
			  <td class="smallText"><b><?php echo 'Tour Code'; ?></b></td>
				<td class="smallText"><b><?php echo 'Updated Tour'; ?></b></td>

				<td class="smallText" align="center"><b><?php echo 'Retail Price'; ?></b></td>
				<td class="smallText" align="center"><b><?php echo 'Retail Price Adjusted'; ?></b></td>
				<?php if($access_full_edit == 'true' || $login_groups_id == '2' || $login_groups_id == '7' || $access_order_cost == 'true') { ?>
				<td class="smallText" ><b><?php echo 'Retail Comment'; ?></b></td>
				<?php } ?>
				<?php if($access_full_edit == 'true' || $access_order_cost == 'true') { ?>
				<td class="smallText" align="center"><b><?php echo 'Invoice No.'; ?></b></td>
				<td class="smallText" align="center"><b><?php echo 'Invoice Amt.'; ?></b></td>
				<td class="smallText" align="center"><b><?php echo 'Cost'; ?></b></td>
				<td class="smallText" align="center"><b><?php echo 'Cost Adjusted'; ?></b></td>
				<?php } ?>
				<?php if($access_full_edit == 'true' || $login_groups_id == '2' || $login_groups_id == '7' || $access_order_cost == 'true') { ?>
				<td class="smallText" ><b><?php echo 'Cost Comment'; ?></b></td>
				<?php } ?>
				<td class="smallText"><b><?php echo 'Updated by'; ?></b></td>
				<?php if($access_full_edit == 'true' || $access_order_cost == 'true') { ?>
				<td class="smallText" ><b><?php echo 'GP'; ?></b></td>
				<td class="smallText"><b><?php echo 'Paid'; ?></b></td>
				<?php } ?>
				<td class="smallText"><b><?php echo 'Modify Date'; ?></b></td>
			  </tr>

			  <?php
			 // $row_cnt = 0;
			 $hist_previous_prod_id="";
			  $diff_color_count = 0;
			  while($select_check_order_product_history = tep_db_fetch_array($select_check_order_product_history_row)){

			  $tota_ratail_calculation[$select_check_order_product_history['products_id']] = $tota_ratail_calculation[$select_check_order_product_history['products_id']] + $select_check_order_product_history['retail'];
			  $tota_cost_calculation[$select_check_order_product_history['products_id']] = $tota_cost_calculation[$select_check_order_product_history['products_id']] + $select_check_order_product_history['cost'];
			  $array_split_cost_retail_comment = explode('!!###!!',$select_check_order_product_history['comment']);
			   if($select_check_order_product_history['oph_model'] != ''){
					$disply_prod_modl =  $select_check_order_product_history['oph_model'];
				}else{
					$disply_prod_modl = $select_check_order_product_history['products_model'];
				}

			   if(!isset($_SESSION['row_color_'.$disply_prod_modl.$oID]) ){
			     $_SESSION['row_color_'.$disply_prod_modl.$oID] = tep_get_rand_color($diff_color_count);
				 $diff_color_count++;
			   }

			   if(!isset($_SESSION['paid_status'.$disply_prod_modl.$oID]) ){
			     if($select_check_order_product_history['payment_paid']==1){
				  	////////// amit added for paid link
					$select_check_order_product_payment_history_sql = "select ord_prod_payment_id, op.orders_products_id from " .TABLE_ORDERS_PRODUCTS_PAYMENT_HISTORY. " opph, ".TABLE_ORDERS_PRODUCTS." op where opph.orders_products_id=op.orders_products_id and (CONCAT(',',opph.orders_products_id,',') REGEXP ',".$select_check_order_product_history['orders_products_id'].",')  order by opph.ord_prod_payment_id desc";
					$select_check_order_product_payment_history_row = tep_db_query($select_check_order_product_payment_history_sql);

					$view_count = tep_db_num_rows($select_check_order_product_payment_history_row);
					if($view_count>0){
						$select_check_order_product_payment_history = tep_db_fetch_array($select_check_order_product_payment_history_row);
						$view_count_link = '<a  target="_blank" href="' . tep_href_link(FILENAME_STATS_PAID_PAYMENT_ORDER_HISTORY_NEW,'payment_id='.$select_check_order_product_payment_history['ord_prod_payment_id'].'&item_id='.$select_check_order_product_history['orders_products_id'], 'NONSSL') . '"><font color="#FF0000">Paid</font></a>';
						if($view_count>1){
							$view_count_link .= $view_count;
						}
					}
				 	////////// amit added for paid link
				 	$_SESSION['paid_status'.$disply_prod_modl.$oID] = $view_count_link;
				 	//$_SESSION['paid_status'.$disply_prod_modl.$oID] = '<font color="#FF0000">Paid</font>';
				 }else{
				 	$_SESSION['paid_status'.$disply_prod_modl.$oID] = '<font color="#007900">Unpaid</font>';
				 }
			   }

			   if($select_check_order_product_history['products_id']!=$hist_previous_prod_id){
					$hist_previous_prod_id = $select_check_order_product_history['products_id'];
					echo '<tr><td class="smallText" align="left" colspan="14"><strong>' . $disply_prod_modl . '</strong></td></tr>';
				}

			  ?>
			   <tr bgcolor="<?php echo $_SESSION['row_color_'.$disply_prod_modl.$oID];?>">
			    <td class="smallText"><?php
				echo $disply_prod_modl;
				?></td>
				<td class="smallText"><?php
				if($select_check_order_product_history['oph_name'] != ''){
					echo $select_check_order_product_history['oph_name'];
				}else{
				echo $select_check_order_product_history['products_name'];
				}
				?></td>

				<td class="smallText" align="right" nowrap>
                <font color="#CCCCCC">Sub-Total:
                <?php
                $ratail_value = $tota_ratail_calculation[$select_check_order_product_history['products_id']];
				echo '<b>'.$ratail_value.'</b>';
				?>
                </font>
                <?php
                //计算实际价格参考 start
				$final_price_reference = $select_check_order_product_history['final_price_reference'] ;
				if($final_price_reference < 0.01){
					$final_price_reference = get_and_up_final_price_reference($oID,$select_check_order_product_history['ord_prod_history_id'],$ratail_value);
				}
				$symbol = '';
				if(sizeof($order->products)>1){
					$symbol = "&asymp;";
				}
				echo '<br>Final Price: '.$symbol.$final_price_reference;
				//计算实际价格参考 end
				?>
                </td>
				<td class="smallText" align="right"><?php
				if( $row_cnt[$select_check_order_product_history['products_id']] > 0) {
					if($select_check_order_product_history['retail'] < 0){
					echo '<span class="errorText">'.$select_check_order_product_history['retail'].'</span>';
					}else{
						if($select_check_order_product_history['retail'] > 0){
							$add_plush_sign = '+';
						}else{
							$add_plush_sign = '';
						}
					echo '<span>'.$add_plush_sign.$select_check_order_product_history['retail'].'</span>';
					}
				 }else{
				 echo '0.00';
				 } ?></td>
				 <?php if($access_full_edit == 'true' || $login_groups_id == '2' || $login_groups_id == '7' || $access_order_cost == 'true') { ?>
				<td class="smallText"><?php
					echo tep_db_prepare_input($array_split_cost_retail_comment[1]);
				?>&nbsp;
				</td>
				<?php } ?>
				<?php if($access_full_edit == 'true' || $access_order_cost == 'true') { ?>
				<td class="smallText" align="center"><?php echo $select_check_order_product_history['invoice_number']; ?>&nbsp;</td>
				<td class="smallText" align="center"><?php echo $select_check_order_product_history['invoice_amount']; ?>&nbsp;</td>
				<td class="smallText" align="right"><?php echo $tota_cost_calculation[$select_check_order_product_history['products_id']];   ?></td>

				<td class="smallText" align="right"><?php
				 if( $row_cnt[$select_check_order_product_history['products_id']] > 0) {
				 	if($select_check_order_product_history['cost'] < 0){
				 	echo '<span class="errorText">'.$select_check_order_product_history['cost'].'</span>';
				 	}else{
						if($select_check_order_product_history['cost'] > 0){
							$add_plush_sign = '+';
						}else{
							$add_plush_sign = '';
						}
						echo '<span>'.$add_plush_sign.$select_check_order_product_history['cost'].'</span>';
					}
				 }else{
				 echo '0.00';
				 } ?></td>
				<?php } ?>
				<?php if($access_full_edit == 'true' || $login_groups_id == '2' || $login_groups_id == '7' || $access_order_cost == 'true') { ?>
				<td class="smallText"><?php
					echo tep_db_prepare_input($array_split_cost_retail_comment[0]);
				?>&nbsp;				</td>
				<?php } ?>
				<td class="smallText" nowrap><?php echo tep_get_admin_customer_name($select_check_order_product_history['updated_by']); ?>&nbsp;</td>
				<?php if($access_full_edit == 'true' || $access_order_cost == 'true') { ?>
				<td class="smallText" align="center">
				<?php
				if( $tota_ratail_calculation[$select_check_order_product_history['products_id']] != 0.00 && $tota_ratail_calculation[$select_check_order_product_history['products_id']] != 0 && $tota_ratail_calculation[$select_check_order_product_history['products_id']] != ''){
					$gp_cal = 1 - ($tota_cost_calculation[$select_check_order_product_history['products_id']]/$tota_ratail_calculation[$select_check_order_product_history['products_id']]);
				}else{
					$gp_cal = '';
				}
				echo number_format($gp_cal,2,'.','');
				?></td>
				<td class="smallText" nowrap><?php echo $_SESSION['paid_status'.$disply_prod_modl.$oID];?></td>
				<?php } ?>
				<td class="smallText" nowrap><?php echo tep_datetime_short($select_check_order_product_history['last_updated_date']); ?></td>
			  </tr>

			  <?php
			  $row_cnt[$select_check_order_product_history['products_id']] =  $row_cnt[$select_check_order_product_history['products_id']] + 1;
			   }  ?>
			 </table>		  </td>
      </tr>
	  <tr>
        <td><?php echo tep_draw_separator('pixel_trans.gif', '1', '5'); ?></td>
      </tr>
	  <?php } ?>

 	  <tr>

        <td><?php echo tep_draw_separator('pixel_trans.gif', '1', '5'); ?>
			<a name="settleanchor"></a>		</td>
      </tr>
	  <?php
	  //amit added for settlement history
	  	include('orders_settlement_history.php');
	  //amit added for settlement history
	  ?>
	   <tr>
        <td><?php echo tep_draw_separator('pixel_trans.gif', '1', '5'); ?></td>
      </tr>
	  <?php
	  	if($login_groups_id != '11'){//Accountant group
		if($login_groups_id == '7'){
		  ?>
		  <tr>
			<td class="main"><strong>Charge Captured Information</strong></td>
		  </tr>
		  <tr>
       		 <td>
				<table cellspacing="0" cellpadding="5" border="1">
					  <tr>
					  <td class="smallText"><strong>Charge Captured Date (PST Time)</strong></td>
						<td class="smallText"><strong>Payment Method</strong></td>
						<td class="smallText"><strong>Amount</strong></td>
						<td class="smallText"><strong>Reference Comment</strong></td>
						<td class="smallText"><strong>Update By</strong></td>
						<td class="smallText"><strong>Modify Date</strong></td>
					  </tr>

					  <?php
					  	$ord_settle_prods_detail_history_sql = "select * from ".TABLE_ORDERS_SETTLEMENT_INFORMATION." osi where orders_id ='".(int)$oID."' order by orders_settlement_id asc ";
						$ord_settle_prods_detail_history_query = tep_db_query($ord_settle_prods_detail_history_sql);
						while($ord_settle_prods_detail_history_row = tep_db_fetch_array($ord_settle_prods_detail_history_query)){
					  ?>
					  <tr>
					    <td class="smallText"><?php echo $ord_settle_prods_detail_history_row['settlement_date'];?></td>
						<td class="smallText"><?php echo $ord_settle_prods_detail_history_row['orders_payment_method'];?></td>
						<td class="smallText" align="right">
						<?php
							if($ord_settle_prods_detail_history_row['order_value'] < 0) {
								echo '<span class="errorText">'.number_format($ord_settle_prods_detail_history_row['order_value'], 2, '.', '').'</span>';
							}else{
								echo number_format($ord_settle_prods_detail_history_row['order_value'], 2, '.', '');
							}
						?>&nbsp;</td>
						<td class="smallText"><?php echo tep_db_prepare_input(nl2br($ord_settle_prods_detail_history_row['reference_comments'])); ?></td>
						<td class="smallText"><?php echo tep_get_admin_customer_name($ord_settle_prods_detail_history_row['updated_by']);?></td>
						<td class="smallText"><?php echo $ord_settle_prods_detail_history_row['date_added'];?></td>
					  </tr>
					  <?php } ?>
					</table>

				</td>
      		</tr>
		  <?php
		  }
	  ?>
      <tr>

        <td class="main"><br><b><?php echo TABLE_HEADING_COMMENTS; ?></b></td>
      </tr>

      <tr>

        <td><?php echo tep_draw_separator('pixel_trans.gif', '1', '5'); ?></td>
      </tr>

      <tr><?php echo tep_draw_form('status', FILENAME_ORDERS, tep_get_all_get_params(array('action')) . 'action=update_order'); ?>

        <td class="main"><?php echo tep_draw_textarea_field('comments', 'soft', '110', '20'); ?></td>
      </tr>

      <tr>

        <td><?php echo tep_draw_separator('pixel_trans.gif', '1', '10'); ?></td>
      </tr>

      <tr>

        <td><table border="0" cellspacing="0" cellpadding="2">

          <tr>

            <td><table border="0" cellspacing="0" cellpadding="2">

              <tr>

                <td class="main"><b>Email Subject:</b>				</td>

				 <td class="main">

				 <?php echo tep_draw_input_field('email_subject', '', 'size="60"'); ?>

				 <!--<input type="text" name="email_subject" value="" size="60">-->				</td>
				</tr>

				<tr> <td colspan="2"><?php echo tep_draw_separator('pixel_trans.gif', '1', '5'); ?></td></tr>

              <tr>

                <td class="main"><b><?php echo ENTRY_STATUS; ?></b></td><td> <?php echo tep_draw_pull_down_menu('status', $orders_statuses, $order->info['orders_status'],'onChange="return changesubjectemail_new(this);"'); ?></td>
              </tr>

			 <tr>  <td colspan="2"><?php echo tep_draw_separator('pixel_trans.gif', '1', '5'); ?></td></tr>



              <tr>

                <td class="main"><b><?php echo ENTRY_NOTIFY_CUSTOMER; ?></b> <?php echo tep_draw_checkbox_field('notify', '', false); ?></td>

                <td class="main"><b><?php echo ENTRY_NOTIFY_COMMENTS; ?></b> <?php echo tep_draw_checkbox_field('notify_comments', '', true); ?></td>
              </tr>

			  <?php
			  //结伴同游通知选项
			  if((int)is_travel_comp((int)$oID)){
			  ?>
			  <tr>
                <td class="main"><b>Notify Travel Companion Customer:</b> <?php echo tep_draw_checkbox_field('send_travel_companion_user', '1', false); ?></td>
                <td class="main">&nbsp;</td>
              </tr>
			  <?php
			  }
			  //结伴同游通知选项end
			  ?>

				  <tr> <td colspan="2"><?php echo tep_draw_separator('pixel_trans.gif', '1', '5'); ?></td></tr>

			  <tr>

			  <td class="main"></td>

			   <td>

			   <input id="Update_Button" name="Update_Button" type="button" value="<?=IMAGE_UPDATE?>" onClick="Submit_Update(this);" >
			   <script type="text/javascript">
			   function Submit_Update(Obj){
			   		if(window.confirm("<?php echo db_to_html('您确定要更新此订单的信息吗？包括订单状态的更新...')?>\t")==true){
						Obj.value = "<?php echo db_to_html('数据正在更新，请稍侯...');?>";
						Obj.disabled=true;
						document.status.submit();
					}

			   }
			   </script>

			   <?php //echo tep_image_submit('button_update.gif', IMAGE_UPDATE); ?>

			   </td></tr>

            </table></td>

            <td valign="top"><?php //echo tep_image_submit('button_update.gif', IMAGE_UPDATE); ?></td>
          </tr>

        </table></td>
	  </tr>

      </form>
	  <?php
	  }else{
	  ?>

	  <tr>
        <td class="main" class="2"><br><b><?php echo 'Charge Captured Information'; ?></b></td>
       </tr>
	  <tr>
        <td colspan="2">
				<table cellspacing="0" cellpadding="5" border="1">
					  <tr>
					  <td class="smallText"><strong>Charge Captured Date (PST Time)</strong></td>
						<td class="smallText"><strong>Payment Method</strong></td>
						<td class="smallText"><strong>Amount</strong></td>
						<td class="smallText"><strong>Reference Comment</strong></td>
						<td class="smallText"><strong>Update By</strong></td>
						<td class="smallText"><strong>Modify Date</strong></td>
					  </tr>

					  <?php
					  	$ord_settle_prods_detail_history_sql = "select * from ".TABLE_ORDERS_SETTLEMENT_INFORMATION." osi where orders_id ='".(int)$oID."' order by orders_settlement_id asc ";
						$ord_settle_prods_detail_history_query = tep_db_query($ord_settle_prods_detail_history_sql);
						while($ord_settle_prods_detail_history_row = tep_db_fetch_array($ord_settle_prods_detail_history_query)){
					  ?>
					  <tr>
					    <td class="smallText"><?php echo $ord_settle_prods_detail_history_row['settlement_date'];?></td>
						<td class="smallText"><?php echo $ord_settle_prods_detail_history_row['orders_payment_method'];?></td>
						<td class="smallText" align="right">
						<?php
							if($ord_settle_prods_detail_history_row['order_value'] < 0) {
								echo '<span class="errorText">'.number_format($ord_settle_prods_detail_history_row['order_value'], 2, '.', '').'</span>';
							}else{
								echo number_format($ord_settle_prods_detail_history_row['order_value'], 2, '.', '');
							}
						?>&nbsp;</td>
						<td class="smallText"><?php echo tep_db_prepare_input(nl2br($ord_settle_prods_detail_history_row['reference_comments'])); ?></td>
						<td class="smallText"><?php echo tep_get_admin_customer_name($ord_settle_prods_detail_history_row['updated_by']);?></td>
						<td class="smallText"><?php echo $ord_settle_prods_detail_history_row['date_added'];?></td>
					  </tr>
					  <?php } ?>
					</table>

		</td>
      </tr>
	   <tr>
        <td colspan="2"><?php echo tep_draw_separator('pixel_trans.gif', '1', '5'); ?></td>
      </tr>
	  <tr>

                <td class="main"><b><?php echo ENTRY_STATUS; ?></b>&nbsp;<?php echo tep_get_orders_status_name($order->info['orders_status']); ?></td>

              </tr>

			 <tr>  <td colspan="2"><?php echo tep_draw_separator('pixel_trans.gif', '1', '5'); ?></td></tr>

	  <?php
	  }//end if login group 10
	  ?>

  <tr>

        <?php  //Begin Paypal IPN V2.8 DMG (I improvised here.)



if (strtolower($order->info['payment_method']) == 'paypal' && isset($HTTP_GET_VARS['referer']) && $HTTP_GET_VARS['referer'] == 'ipn'){

?>

<td colspan="2" align="right">
<?php
//echo '<a href="javascript:popupWindow(\'' .  (HTTP_SERVER . DIR_WS_ADMIN . FILENAME_ORDERS_INVOICE) . '?' . (tep_get_all_get_params(array('oID')) . 'oID=' . $HTTP_GET_VARS['oID']) . '\')">' . tep_image_button('button_invoice.gif', IMAGE_ORDERS_INVOICE) . '</a><a href="javascript:popupWindow(\'' .  (HTTP_SERVER . DIR_WS_ADMIN . FILENAME_ORDERS_PACKINGSLIP) . '?' . (tep_get_all_get_params(array('oID')) . 'oID=' . $HTTP_GET_VARS['oID']) . '\')">' . tep_image_button('button_packingslip.gif', IMAGE_ORDERS_PACKINGSLIP) . '</a><a href="' . tep_href_link(FILENAME_PAYPAL, tep_get_all_get_params(array('action'))) . '">' . tep_image_button('button_back.gif', IMAGE_BACK) . '</a>';
echo '<a href="javascript:popupWindow(\'' .  (HTTP_SERVER . DIR_WS_ADMIN . FILENAME_ORDERS_INVOICE) . '?' . (tep_get_all_get_params(array('oID')) . 'oID=' . $HTTP_GET_VARS['oID']) . '\')">' . tep_image_button('button_invoice.gif', IMAGE_ORDERS_INVOICE) . '</a><a href="' . tep_href_link(FILENAME_PAYPAL, tep_get_all_get_params(array('action'))) . '">' . tep_image_button('button_back.gif', IMAGE_BACK) . '</a>';
?></td>



<?php } else { //not paypal

?>

<td colspan="2" align="right">
<?php
//echo '<a href="javascript:popupWindow(\'' .  (HTTP_SERVER . DIR_WS_ADMIN . FILENAME_ORDERS_INVOICE) . '?' . (tep_get_all_get_params(array('oID')) . 'oID=' . $HTTP_GET_VARS['oID']) . '\')">' . tep_image_button('button_invoice.gif', IMAGE_ORDERS_INVOICE) . '</a><a href="javascript:popupWindow(\'' .  (HTTP_SERVER . DIR_WS_ADMIN . FILENAME_ORDERS_PACKINGSLIP) . '?' . (tep_get_all_get_params(array('oID')) . 'oID=' . $HTTP_GET_VARS['oID']) . '\')">' . tep_image_button('button_packingslip.gif', IMAGE_ORDERS_PACKINGSLIP) . '</a><a href="' . tep_href_link(FILENAME_ORDERS, tep_get_all_get_params(array('action'))) . '">' . tep_image_button('button_back.gif', IMAGE_BACK) . '</a>';
echo '<a href="javascript:popupWindow(\'' .  (HTTP_SERVER . DIR_WS_ADMIN . FILENAME_ORDERS_INVOICE) . '?' . (tep_get_all_get_params(array('oID')) . 'oID=' . $HTTP_GET_VARS['oID']) . '\')">' . tep_image_button('button_invoice.gif', IMAGE_ORDERS_INVOICE) . '</a><a href="' . tep_href_link(FILENAME_ORDERS, tep_get_all_get_params(array('action'))) . '">' . tep_image_button('button_back.gif', IMAGE_BACK) . '</a>';
?></td>

<?php

}  //end PapPal IPN V2.8

?>
     </tr>

 <?php

        }elseif (($action == 'eticket') && ($order_exists == true)) {

    $order = new order($oID);

?>

     <tr>
				<td>
				<?php
					if(isset($HTTP_GET_VARS['search']) && $HTTP_GET_VARS['search'] != ''){
					$search_val = tep_db_prepare_input($HTTP_GET_VARS['search']);
					}else{
					$search_val = $oID;
					}

					echo tep_draw_form('orders', FILENAME_ORDERS, tep_get_all_get_params(array('oID','y','x', 'action')), 'get'); ?>

					<table width="100%" cellpadding="0" cellspacing="0">
					<tr>
						 <td class="smallText"  align="right">
						 <?php echo HEADING_TITLE_SEARCH . ' <input type="text" name="oID" value="'.$search_val.'"  size="12"> '. tep_draw_hidden_field('action', 'edit'); ?>
						 </td><td>&nbsp;<?php echo tep_image_submit('button_search.gif', IMAGE_SEARCH); ?></td>
						<td class="pageHeading" align="right"><?php echo tep_draw_separator('pixel_trans.gif', '10', '1'); ?></td>
								 </tr>
					</table>
					 </form>
				</td>
			</tr>

      <tr>

        <td><?php echo tep_draw_separator('pixel_trans.gif', '1', '10'); ?></td>
      </tr>

      <tr>

        <td><table border="0" cellspacing="0" cellpadding="2" width="100%">

<?php

// BOF: WebMakers.com Added: Show Order Info

?>



<!-- add Order # // -->

<?php echo tep_draw_form('etickets', FILENAME_ORDERS, tep_get_all_get_params(array('action')) . 'action=update_eticket', 'post', 'onsubmit="return validation_guest();"');

$i = $_GET['i'];

$orders_eticket_query = tep_db_query("select * from ".TABLE_ORDERS_PRODUCTS_ETICKET." where orders_id = '" . (int)$oID . "' and products_id=".$_GET['products_id']." ");

$orders_eticket_result = tep_db_fetch_array($orders_eticket_query);

?>





<tr>

<td width="20%" class="main">E-Ticket Number #<br><?php //echo TEXT_CHINESE_ETICKET_NUMBER;?></td>

<td width="37%" class="main"><?php echo tep_db_input($oID); ?></td>

<td width="21%" class="main">Confirmation Date</td>

<td width="22%" class="main"><?php echo date('m-d-Y');?></td>
</tr>

<!-- add date/time // -->





          <tr>

            <td colspan="4" class="main">E-Ticket for</td>
            </tr>

			<?php

				//for ($i=0, $n=sizeof($order->products); $i<$n; $i++)

				//{

				?>

					 <tr>

						<td colspan="4" class="main"><?php echo (1).') <a target="_blank" href="' . tep_catalog_href_link(FILENAME_PRODUCT_INFO, 'products_id=' . $order->products[$i]['id']) . '">'.$order->products[$i]['name'].'</a>&nbsp;[<a target="_blank" href="' . tep_href_link(FILENAME_CATEGORIES, 'cPath=' . tep_get_products_catagory_id($order->products[$i]['id']) . '&pID=' . $order->products[$i]['id'].'&action=new_product&tabedit=eticket') . '">'.$order->products[$i]['model'].'</a>]';?></td>
					</tr>




			<?php



				//}

			    ?>

        </table></td>
      </tr>



	  <tr>

        <td class="main"><hr></td>
      </tr>

	  <tr>

        <td class="main">

			<table width="100%" cellpadding="3" cellspacing="0">

				<tr>

					<td class="main" colspan="4"><b>Guest Name</b> <?php //echo TEXT_CHINESE_CUST_SERVICE_CON;?></td>
				</tr>

				<?php

				$guestnames = explode("<::>",$orders_eticket_result['guest_name']);



				if($orders_eticket_result['guest_number']==0)

				{

					foreach($guestnames as $key=>$val)

					$loop = $key;

				}

				else

				{

					$loop = $orders_eticket_result['guest_number'];

				}





				for($noofguest=1;$noofguest<=$loop;$noofguest++)

				{

						if(($noofguest%2)!=0)

						echo '<tr>';

						?>

						<td width="3%" class="main"><?php echo $noofguest; ?></td>

						<td width="40%" class="main">
						<?php
						 //howard edited 2010-05-19
								$guest_name_incudes_child_age = explode('||',$guestnames[($noofguest-1)]);
								if(isset($guest_name_incudes_child_age[1])){ ?>
									<input type="text" name="<?php echo 'guest'.$noofguest; ?>" id="<?php echo 'guest'.$noofguest; ?>" value="<?php echo stripslashes(trim($guest_name_incudes_child_age[0])); ?>" /> Birth Date: <input type="text" size="10" name="<?php echo 'etckchildage'.$noofguest; ?>" id="<?php echo 'etckchildage'.$noofguest; ?>" value="<?php echo stripslashes(trim($guest_name_incudes_child_age[1])); ?>" /> [<a href="javascript:void(0)" style="color: #F00" title="remove guest" onClick="remove_to_garbage_boxs('<?= 'guest'.$noofguest;?>','<?php echo 'etckchildage'.$noofguest; ?>')">x</a>]
						<?php }else{ ?>
							<input type="text" name="<?php echo 'guest'.$noofguest; ?>" id="<?php echo 'guest'.$noofguest; ?>" value="<?php echo stripslashes(trim($guestnames[($noofguest-1)])); ?>" /> [<a href="javascript:void(0)" style="color: #F00" title="remove guest" onClick="remove_to_garbage_boxs('<?= 'guest'.$noofguest;?>')">x</a>]
						<?php } ?>						</td>

						<?php

						if(($noofguest%2)==0)

						echo '</tr>';



				} ?>
				<?php	 //howard edited 2010-05-19 start?>
				<tr>
				<td><input name="garbage_boxs" id="garbage_boxs" type="hidden" value="">&nbsp;</td>
				<td><div id="new_guest"><table border="0" cellspacing="0" cellpadding="0"><tr><td height="30" align="right" class="infoBoxContent">Add Guest Name:<input type="text" name="new_cus_name" size="20"></td><td class="infoBoxContent">
				Child Birth Date:
				<script type="text/javascript">
				var dateBirth = new ctlSpiffyCalendarBox("dateBirth", "etickets", "birth_date","btnDateBirth","",scBTNMODE_CUSTOMBLUE);

				dateBirth.writeControl(); dateBirth.dateFormat="MM/dd/yyyy";
				</script>
				</td><td align="right" class="infoBoxContent"></td><td class="infoBoxContent"><input name="SubmitFast" type="submit" value=" Update "></td></tr></table></div></td>
				</tr>
				<?php	 //howard edited 2010-05-19 end?>
				<tr>

					<td class="main" colspan="4"><b>Guest Cell Phone (Emergency Only):</b> <?php //echo TEXT_CHINESE_GUEST_CELL_PHONE;?><?php echo tep_draw_input_field('customers_cellphone', tep_customers_cellphone($the_customers_id), ''); ?><?php echo tep_draw_hidden_field('customers_id', $the_customers_id, ''); ?> </td>
				</tr>
			</table>		</td>
      </tr>



	   <tr>

        <td class="main"><hr></td>
      </tr>



	  <tr>

        <td class="main">

			<table width="100%" cellpadding="3" cellspacing="0">



				<?php

				//for ($i=0, $n=sizeof($order->products); $i<$n; $i++)

				//{

				?>

					<tr>

					<td width="30%" class="main" valign="top"><b>Room Requested:  <?php  //echo TEXT_CHINESE_ROOM_REQUESTED; //echo $order->products[$i]['name']; ?></b></td>

					<td width="70%" class="main">&nbsp;

					<?php

					//$order->products[$i]['products_room_info'] = str_replace("<br>".TEXT_SHOPPIFG_CART_TOTAL_FARES_TRANSACTION_FEE,'',$order->products[$i]['products_room_info']);
					//2010-05-19 added a var
					//$products_room_info_textarea = $order->products[$i]['products_room_info'];
					$order->products[$i]['products_room_info'] = preg_replace('/总价\(包括[0-9.]+%服务费\)/','',$order->products[$i]['products_room_info']);

					if(eregi('- Total :',stripslashes($order->products[$i]['products_room_info']))){

						$req_roomarray = explode('- Total :',stripslashes($order->products[$i]['products_room_info']));

					}else if(eregi(TEXT_SHOPPIFG_CART_NO_ROOM_TOTAL,stripslashes($order->products[$i]['products_room_info']))){
						$req_roomarray[0] = str_replace("<br>".TEXT_SHOPPIFG_CART_NO_ROOM_TOTAL." :",'',stripslashes($order->products[$i]['products_room_info']));
						$req_roomarray[0] = preg_replace('/[[:space:]](\$|\&#65509;)[0-9\,]*.[0-9]+/', '',$req_roomarray[0]);
					}else if(eregi(TEXT_TOTLE_OF_ROOM_STRING_CHECK,stripslashes($order->products[$i]['products_room_info']))){

						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM1,'',stripslashes($order->products[$i]['products_room_info']));
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM2,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM3,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM4,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM5,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM6,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM7,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM8,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM9,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM10,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM11,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM12,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM13,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM14,'',$req_roomarray[0]);
						$req_roomarray[0] = str_replace('<br>'.TEXT_TOTLE_OF_ROOM15,'',$req_roomarray[0]);
						$req_roomarray[0] = preg_replace('/[[:space:]](\$|\&#65509;)[0-9\,]*.[0-9]+/', '',$req_roomarray[0]);

					}else{

						$req_roomarray[0] = preg_replace('/Total[[:space:]]of[[:space:]]room[[:space:]][0-9]+:[[:space:]](\$|\&#65509;)[0-9\,]*.[0-9]+/', '', stripslashes($order->products[$i]['products_room_info']));
					}

					if(get_products_departure_date_num($order->products[$i]['id']) <= 1){
						//$req_roomarray[0] = '';
					}
					//echo $req_roomarray[0];

					//2010-05-19 added
					$products_room_info_textarea = str_replace(array("<br>","</br>","<br />"),"\r\n",$req_roomarray[0], $m);
					echo '</br></br>'.tep_draw_textarea_field('products_room_info_textarea', 'soft', 55, ((int)$m+2));
					?>					</td>
					</tr>

			<?php

				//}

			    ?>
			</table>		</td>
      </tr>



	  <tr>

        <td class="main"><hr></td>
      </tr>

	   <tr>

        <td class="main">

			<table width="100%" cellpadding="3" cellspacing="0">

				<!--<tr>

					<td class="main" colspan="4"><b>Flight Information</b></td>

				</tr>-->

				<?php

				//for ($i=0, $n=sizeof($order->products); $i<$n; $i++)

				//{

				?>

					<tr>

					<td width="30%" class="main" valign="top" colspan="2"><b>Flight Information: <?php //echo TEXT_CHINESE_FLIGHT_INFO; //echo $order->products[$i]['name']; ?></b>(Flight Information is applicable only if your tour itinerary includes airport transfer on Day 1 of the tour.) </td>
					</tr>

					<?php

					$orders_history_query = tep_db_query("select * from ".TABLE_ORDERS_PRODUCTS_FLIGHT." where orders_id = '" . tep_db_input($oID) . "' and products_id=".$_GET['products_id']." ");

					if (tep_db_num_rows($orders_history_query))

					{

					 while ($orders_history = tep_db_fetch_array($orders_history_query))

						  {



					echo '<tr>

						<td class="main" colspan="2">';

						?>

						<script language="javascript"><!--



var dateAvailable = new ctlSpiffyCalendarBox("dateAvailable", "etickets", "arrival_date","btnDate","<?php echo tep_get_date_disp($orders_history['arrival_date']); ?>",scBTNMODE_CUSTOMBLUE);

var dateAvailable1 = new ctlSpiffyCalendarBox("dateAvailable1", "etickets", "departure_date","btnDate1","<?php echo tep_get_date_disp($orders_history['departure_date']); ?>",scBTNMODE_CUSTOMBLUE);

//--></script>

						<table border="0" width="100%" cellspacing="0" cellpadding="2">

						  <tr>

							<td class="main">Arrival Airline Name<br><?php //echo TEXT_ARRIVAL_AIRLINE_NAME;?></td>

							<td><?php echo tep_draw_input_field('airline_name', $orders_history['airline_name'], ''); ?></td>

							<td class="main">Departure Airline Name<br><?php //echo TEXT_DEPARTURE_AIRLINE_NAME;?></td>

							<td><?php echo tep_draw_input_field('airline_name_departure', $orders_history['airline_name_departure'], ''); ?></td>
						  </tr>

						  <tr>

						  	<td class="main">Arrival Flight Number<br><?php //echo TEXT_ARRIVAL_FLIGHT_NUMBER;?></td>

							<td><?php echo tep_draw_input_field('flight_no', $orders_history['flight_no'], ''); ?></td>

							<td class="main">Departure Flight Number<br><?php //echo TEXT_DEPARTURE_FLIGHT_NUMBER;?></td>

							<td><?php echo tep_draw_input_field('flight_no_departure', $orders_history['flight_no_departure'], ''); ?></td>
						  </tr>

						  <tr>

							<td class="main">Arrival Airport Name<br><?php //echo TEXT_ARRIVAL_AIRPORT_NAME;?></td>

							<td><?php echo tep_draw_input_field('airport_name', $orders_history['airport_name'], ''); ?></td>

							<td class="main">Departure Airport Name<br><?php //echo TEXT_DEPARTURE_AIRPORT_NAME;?></td>

							<td><?php echo tep_draw_input_field('airport_name_departure', $orders_history['airport_name_departure'], ''); ?></td>
						  </tr>

						  <tr>

								<td class="main">Arrival Date<br><?php //echo TEXT_ARRIVAL_DATE;?></td>

								<td><?php //echo tep_draw_input_field('arrival_date', $arrival_date, ''); ?>

								<script language="javascript">dateAvailable.writeControl(); dateAvailable.dateFormat="MM/dd/yyyy";</script>								</td>

								<td class="main">Departure Date<br><?php //echo TEXT_DEPARTURE_DATE;?></td>

								<td><?php //echo tep_draw_input_field('departure_date', $departure_date, ''); ?>

								<script language="javascript">dateAvailable1.writeControl(); dateAvailable1.dateFormat="MM/dd/yyyy";</script></td>
							  </tr>

						  <tr>

						    <td class="main">Arrival Time<br><?php //echo TEXT_ARRIVAL_TIME;?></td>

							<td><?php echo tep_draw_input_field('arrival_time', $orders_history['arrival_time'], ''); ?></td>

						  	<td class="main">Departure Time<br><?php //echo TEXT_DEPARTURE_TIME;?></td>

							<td><?php echo tep_draw_input_field('departure_time', $orders_history['departure_time'], ''); ?></td>
						  </tr>
						</table>

						<?php

						echo '

						</td>

					 </tr>';

							}// end of while loop

					}//end of if

				//}//end of for

			    ?>
			</table>		</td>
      </tr>





	  <tr>

        <td class="main"><hr></td>
      </tr>

	  <?php



	  if($orders_eticket_result['depature_full_address'] != ''){

	  $depature_full_address = $orders_eticket_result['depature_full_address'];

	  } else {

		$orders_fulladdress_query = tep_db_query("select * from orders_products where orders_id = '" . tep_db_input($oID) . "' and products_id = ".(int)$order->products[$i]['id']." ");

		$orders_fulladdress = tep_db_fetch_array($orders_fulladdress_query);

		//$depature_full_address =  $order->products[$i]['products_departure_date'].' &nbsp; '.$order->products[$i]['products_departure_time'].' &nbsp; '.$orders_fulladdress['departure_full_address'];

		$depature_full_address =  str_replace(' 00:00:00','',$orders_fulladdress['products_departure_date']).' &nbsp; '.$orders_fulladdress['products_departure_time'].' &nbsp; '.$orders_fulladdress['products_departure_location'];

	  }

	  ?>

	  <tr>

        <td class="main">

			<table width="100%" cellpadding="3" cellspacing="0">

				<tr>

					<td width="15%" class="main"><b>Tour Start Date and Location: </b><br><?php //echo TEXT_CHINESE_DPAR_TIME_LOC;?></td>

					<td width="85%" class="main"><input type="text" name="depature_full_address" value="<?php echo stripslashes($depature_full_address);?>" size="50"/></td>
				</tr>
			</table>		</td>
      </tr>



	  <tr>

        <td class="main"><hr></td>
      </tr>

<?php
	if($order->products[$i]['customer_seat_no'] !="" || $order->products[$i]['customer_bus_no'] !="" || $order->products[$i]['customer_confirmation_no'] !="" ){
?>
	<tr>
		<td class="main" align="left">
			<table width="100%" cellpadding="3" cellspacing="0" border="0" class="main conf_detail_texts">
		<?php
			$confirmation_detail_str="";
			if($order->products[$i]['customer_bus_no'] !=""){
				$confirmation_detail_str.=TEXT_BUS_NO.' <u>'.$order->products[$i]['customer_bus_no'].'</u><br />';
			}
			if($order->products[$i]['customer_seat_no'] !=""){
				$confirmation_detail_str.=TEXT_SEAT_NO.' <u>'.$order->products[$i]['customer_seat_no'].'</u><br />';
			}
			if($order->products[$i]['customer_confirmation_no'] !=""){
				$confirmation_detail_str.=TEXT_CONFIRMATION_NO.' <u>'.$order->products[$i]['customer_confirmation_no'].'</u><br />';
			}
		?>
				<tr>
					<td><?php echo $confirmation_detail_str;?></td>
				</tr>
			</table>
		</td>
	</tr>
	<tr>
		<td class="main"><hr></td>
	</tr>
<?php }?>
<?php

$agency_query = tep_db_query("select a.* from ".TABLE_PRODUCTS." as p, ".TABLE_TRAVEL_AGENCY." as a where p.products_id = '" . (int)$order->products[$i]['id'] . "' and p.agency_id = a.agency_id ");

$agency_result = tep_db_fetch_array($agency_query);
			 
$arr_highlight_agency_details=array(33,67,68,3,35,36);
$style_highlight_agency='';
if(in_array($agency_result['agency_id'], $arr_highlight_agency_details)){
	$style_highlight_agency='style="font-weight:bold; font-size:16px; color:#000000;"';
}
?>

<?php
/*	if($display_eticket_itinerary_new_format==true){
	}else{*/
?>
	  <tr>

        <td class="main">

			<table width="100%" cellpadding="3" cellspacing="0">

				<tr>

					<td width="15%" class="main"><b>Local Tour Contact: </b><br><?php //echo TEXT_CHINESE_TOUR_COUCH_CONTECT;?></td>

					<td width="85%" class="main"><input type="text" name="tourprovider" value="<?php if($orders_eticket_result['tour_provider'] != '') echo stripslashes($orders_eticket_result['tour_provider']); else echo '<b>'.$agency_result['agency_name'].'</b> Tel: '.$agency_result['phone'];?>" size="50"/></td>
				</tr>
			</table>		</td>
      </tr>
<?php //}?>





<?php
		if($display_eticket_itinerary_new_format==true && $forceelase == true){
		?>
		<tr>
        <td class="main">
		<input type="hidden" name="emergency_contact_person" value="<?php if($orders_eticket_result['emergency_contact_person'] != '') echo stripslashes($orders_eticket_result['emergency_contact_person']); else echo stripslashes($agency_result['emerency_contactperson']);?>" size="20"/>
		<input type="hidden" name="emergency_contact_no" value="<?php if($orders_eticket_result['emergency_contact_no'] != '') echo stripslashes($orders_eticket_result['emergency_contact_no']); else echo stripslashes($agency_result['emerency_number']);?>" size="20"/>
		</td>
		</tr>
		<?php
		}else{?>
	  <tr>

        <td class="main">

			<table width="100%" cellpadding="3" cellspacing="0">

				<tr>

					<td width="15%" class="main"><b>Emergency Contact Person : </b><br><?php //echo TEXT_CHINESE_EMG_CON_PERSION;?></td>

					<td width="35%" class="main"><input type="text" name="emergency_contact_person" value="<?php if($orders_eticket_result['emergency_contact_person'] != '') echo stripslashes($orders_eticket_result['emergency_contact_person']); else echo stripslashes($agency_result['emerency_contactperson']);?>" size="20"/></td>

					<td width="15%" class="main"><b>Emergency Contact Number : </b><br><?php //echo TEXT_CHINESE_EMG_CON_NUMBER;?></td>

					<td width="35%" class="main"><input type="text" name="emergency_contact_no" value="<?php if($orders_eticket_result['emergency_contact_no'] != '') echo stripslashes($orders_eticket_result['emergency_contact_no']); else echo stripslashes($agency_result['emerency_number']);?>" size="20"/></td>
				</tr>
			</table>		</td>
      </tr>



	  <tr>

        <td class="main"><hr></td>
      </tr>
<?php }?>

<?php
	if($orders_eticket_result['special_note']=='')
	{
		$special_query = tep_db_query("select products_special_note, products_vacation_package from ".TABLE_PRODUCTS."  where products_id = '" . (int)$order->products[$i]['id'] . "' ");

			$special_result = tep_db_fetch_array($special_query);
		$special_note = $special_result['products_special_note'];

	}else{
		$special_note = $orders_eticket_result['special_note'];
	}
	if($special_result['products_vacation_package'] == '1'){
			if($display_eticket_itinerary_new_format==true){
				$special_note_itinerary = 'If you will self transfer to hotel on day one, please connect with customer service dept or local tour contact to re-confirm hotel information three days prior to departure date.<br>如果您需要在第一天自行前往酒店,请在出发前三日联系途风网客服部门或地接社以最后确定酒店信息。';
			}
	}
				?>




	  <tr>

        <td class="main">

			<table width="100%" cellpadding="3" cellspacing="0">

				<tr>

					<td class="main" colspan="4"><b>Suggested Tour Itinerary</b>  <?php //echo TEXT_CHINESE_SUGEST_TOUR_ITENORY;?></td>
				</tr>

				<?php
				//howard added for notes start
					$notes_expand = "请您在出发前一天致电给出团地接社做最后确认！";
				//howard added for notes end
				if($orders_eticket_result['tour_arrangement'] != '')

				{

				$tour_arrangement = $orders_eticket_result['tour_arrangement'];

				}else{
					if($display_eticket_itinerary_new_format==true && $forceelase == true){
						$suggested_tour_itinerary_date = $order->products[$i]['products_departure_date'];
						$suggested_tour_itinerary_pick_up_time = $order->products[$i]['products_departure_time'].' '.$order->products[$i]['products_departure_location'];
						if(tep_not_null($style_highlight_agency)){
							$suggested_tour_itinerary_pick_up_time = '<span '.$style_highlight_agency.'>'.$suggested_tour_itinerary_pick_up_time.'</span>';
						}
						
						$suggested_tour_eticket_itinerary = tep_get_products_eticket_itinerary($order->products[$i]['id'],$languages_id);
						$suggested_tour_eticket_hotel = tep_get_products_eticket_hotel($order->products[$i]['id'],$languages_id);
						$suggested_tour_eticket_notes = $special_note_itinerary.'<br /><br />'.tep_get_products_eticket_notes($order->products[$i]['id'],$languages_id);
						$suggested_tour_eticket_local_contact="";
						if($orders_eticket_result['tour_provider'] != ''){
							$suggested_tour_eticket_local_contact.=stripslashes($orders_eticket_result['tour_provider']);
						}else{
							$suggested_tour_eticket_local_contact.= '<b style="font-size:16px;">'.$agency_result['agency_name'].'<br>'.$agency_result['agency_name1'].'</b><br>Tel: '.$agency_result['phone'];
						}
						$suggested_tour_eticket_local_contact.="<br><br>Emergency Contact Person and Tel Number:<br>紧急联络人及电话:<br>";
						if($orders_eticket_result['emergency_contact_person'] != ''){
							$suggested_tour_eticket_local_contact.=stripslashes($orders_eticket_result['emergency_contact_person']).' ';
						}else{
							$suggested_tour_eticket_local_contact.=stripslashes($agency_result['emerency_contactperson']).' ';
						}
						//$suggested_tour_eticket_local_contact.="<br><br>Emergency Contact  Number:<br>";
						if($orders_eticket_result['emergency_contact_no'] != ''){
							$suggested_tour_eticket_local_contact.=stripslashes($orders_eticket_result['emergency_contact_no']);
						}else{
							$suggested_tour_eticket_local_contact.=stripslashes($agency_result['emerency_number']);
						}

						$suggested_tour_eticket_local_contact_arr_explode = explode('!##!',$suggested_tour_eticket_local_contact);
						$suggested_tour_eticket_itinerary_arr_explode = explode('!##!',$suggested_tour_eticket_itinerary);
						$suggested_tour_eticket_hotel_arr_explode = explode('!##!',$suggested_tour_eticket_hotel);
						$suggested_tour_eticket_notes_arr_explode = explode('!##!',$suggested_tour_eticket_notes);

						$exra_auto_row_load_eticke ='';
						for ($lp_i = 0; $lp_i < sizeof($suggested_tour_eticket_itinerary_arr_explode); $lp_i++) {
							if($lp_i > 0){
								$suggested_tour_itinerary_pick_up_time = '';
								$eticket_notes_string = $suggested_tour_eticket_notes_arr_explode[$lp_i];
							}else{
								$eticket_notes_string = $notes_expand.str_replace($notes_expand,'',$suggested_tour_eticket_notes_arr_explode[$lp_i]);
							}
							$exra_auto_row_load_eticke .= '<TR valign="top">

											<TD>'.date_add_day($lp_i,'d',$suggested_tour_itinerary_date).'<br /><br />'.$suggested_tour_itinerary_pick_up_time.'</TD>
											<TD>'.$suggested_tour_eticket_local_contact_arr_explode[$lp_i].'</TD>

											<TD>'.$suggested_tour_eticket_itinerary_arr_explode[$lp_i].'</TD>

											<TD>'.$suggested_tour_eticket_hotel_arr_explode[$lp_i].'</TD>

											<TD>'.$eticket_notes_string.'</TD></TR>';
					}
				}else{
						$suggested_tour_itinerary_date = $order->products[$i]['products_departure_date'];
						$suggested_tour_itinerary_pick_up_time = $order->products[$i]['products_departure_time'].' '.$order->products[$i]['products_departure_location'];
						if(tep_not_null($style_highlight_agency)){
							$suggested_tour_itinerary_pick_up_time = '<span '.$style_highlight_agency.'>'.$suggested_tour_itinerary_pick_up_time.'</span>';
						}

						$suggested_tour_eticket_itinerary = tep_get_products_eticket_itinerary($order->products[$i]['id'],$languages_id);
						$suggested_tour_eticket_hotel = tep_get_products_eticket_hotel($order->products[$i]['id'],$languages_id);
						$suggested_tour_eticket_notes = tep_get_products_eticket_notes($order->products[$i]['id'],$languages_id);

						$suggested_tour_eticket_itinerary_arr_explode = explode('!##!',$suggested_tour_eticket_itinerary);
						$suggested_tour_eticket_hotel_arr_explode = explode('!##!',$suggested_tour_eticket_hotel);
						$suggested_tour_eticket_notes_arr_explode = explode('!##!',$suggested_tour_eticket_notes);

						$exra_auto_row_load_eticke ='';
						for ($lp_i = 0; $lp_i < sizeof($suggested_tour_eticket_itinerary_arr_explode); $lp_i++) {
							if($lp_i > 0){
								$suggested_tour_itinerary_pick_up_time = '';
								$eticket_notes_string = $suggested_tour_eticket_notes_arr_explode[$lp_i];
							}else{
								$eticket_notes_string = $notes_expand.str_replace($notes_expand,'',$suggested_tour_eticket_notes_arr_explode[$lp_i]);
							}
							$exra_auto_row_load_eticke .= '<TR>

													<TD>'.date_add_day($lp_i,'d',$suggested_tour_itinerary_date).'&nbsp;</TD>

													<TD>'.$suggested_tour_itinerary_pick_up_time.'&nbsp;</TD>

													<TD>'.$suggested_tour_eticket_itinerary_arr_explode[$lp_i].'&nbsp;</TD>

													<TD>'.$suggested_tour_eticket_hotel_arr_explode[$lp_i].'&nbsp;</TD>

													<TD>'.$eticket_notes_string.'&nbsp;</TD></TR>';

						}
					}



				$tour_arrangement = '<TABLE cellSpacing=1 cellPadding=2 width=\"100%\" border=1><TBODY>';
				if($display_eticket_itinerary_new_format==true && $forceelase == true){
					$tour_arrangement .= TEXT_DEFULAT_TOUR_ARRANMGENT_NEW;
				}else{
					$tour_arrangement .= TEXT_DEFULAT_TOUR_ARRANMGENT;
				}
				$tour_arrangement .= $exra_auto_row_load_eticke;
				$tour_arrangement .= '
<TR><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD></TR>
<TR><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD></TR>
<TR><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD></TR>
<TR><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD></TR>
<TR><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD></TR>
<TR><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD><TD>&nbsp;</TD></TR>';
				}

				?>

				<tr>

					<td class="main" colspan="4"><?php echo tep_draw_textarea_field('tour_arrangement', 'soft', '120', '25', $tour_arrangement); ?></td>
				</tr>
			</table>		</td>
      </tr>



	<tr>

        <td class="main">

			<table width="100%" cellpadding="3" cellspacing="0">

				<tr>

					<td class="main" colspan="4"><b>Special Note</b>  <?php //echo TEXT_CHINESE_SPECIAL_NOTES;?></td>
				</tr>

				<tr>

					<td class="main" colspan="4">
					<?php
					//自动在通知添加一些文字
					$add_text = "\n\n旅行团供应商会尽量保证行程安排和预计的保持一致。但为了保证行程顺利, 旅行团供货商保留对由于天气、交通、旅行游览车临时发生故障和其它一些无法控制的原因所导致对行程更改、推迟和取消的权利。\n旅行团供应商保留在出发前如果参团人数不足以成团的情况下取消行程的权利，途风网会提前通知。\n旅行团供应商保留因为参团人数不足而调换游览车的权力。\n旅行团供应商所有临时采取的行为, 均会从整个团体利益出发而考虑。此行为与途风网完全无关，但是途风网会全力协助途风贵宾争取权宜。";
					if(!preg_match('/旅行团供应商会尽量保证行程安排和预计的保持一致。但为了保证行程顺利,/',$special_note)){
						$special_note = str_replace($add_text, '', $special_note).$add_text;
						tep_db_query("update ".TABLE_ORDERS_PRODUCTS_ETICKET." set special_note='".tep_db_input($special_note)."' , tour_arrangement='". tep_db_input($tour_arrangement)."' where orders_id = ".(int)$_GET['oID']." and products_id = ".$_GET['products_id']." ");

					}
					echo tep_draw_textarea_field('special_note', 'soft', '80', '5', stripslashes($special_note));
					?>
					</td>
				</tr>
			</table>		</td>
      </tr>

	<tr>
        <td class="main" colspan="2"><hr></td>
      </tr>

	  <tr>
			<td class="main" colspan="2">
				<table width="100%" cellpadding="3" cellspacing="0">
					<tr>
						<td width="30%" class="main"><b>Customer Service Contact:<br><?php echo '客服联系方式';?> </b></td>
						<td width="70%" class="main">
						By Email: <?php echo STORE_OWNER_EMAIL_ADDRESS;?><br>
						<?php echo '电子邮件：';?>  <?php echo STORE_OWNER_EMAIL_ADDRESS;?><br>
						<?php echo '投诉邮箱：';?>  <?php echo 'jiandu@toursforfun.com'?>
						<br><br>
						By Telephone: 1-626-389-8666&nbsp;&nbsp;1-866-638-6888<?php echo db_to_html('(美加免费)')?><br>
						<?php echo '电话[美国]:'?> 1-626-389-8666&nbsp;&nbsp;1-866-638-6888<?php echo db_to_html('(美加免费)')?><br>
						<?php echo '电话[中国]:'?> 400-600-1610<br>
						<br>(9:00AM-5:00PM Pacific Standard Time MON-FRI)<br>
						(<?php echo '9:00am-5:00pm 太平洋时间 星期一-星期五';?>)
						</td>
					</tr>
				</table>
			</td>
		  </tr>

	 <!-- <tr>

        <td class="main">

			<table width="100%" cellpadding="3" cellspacing="0">

				<tr>

					<td class="main"> ?lease check our website for detailed information including all the terms and conditions and special notes about your reserved tour.

?lease be sure to bring travel documents.  Local tour provider is not responsible for any expenses due to lack of appropriate travel documents.

?ocal tour provider reserves the right to adjust tour arrangements.



Thank you for choosing toursforfun.com.  We appreciate your business.

Enjoy your fun tour!</td>

				</tr>



			</table>

		</td>

      </tr>-->









	 <?php

  if (HTML_AREA_WYSIWYG_DISABLE == 'Enable') { ?>

            <script language="JavaScript1.2" defer>

             var config = new Object();  // create new config object

              config.width = "800px";

           	 config.height = "500px";

             config.bodyStyle = 'background-color: <?php echo HTML_AREA_WYSIWYG_BG_COLOUR; ?>; font-family: "<?php echo HTML_AREA_WYSIWYG_FONT_TYPE; ?>"; color: <?php echo HTML_AREA_WYSIWYG_FONT_COLOUR; ?>; font-size: <?php echo HTML_AREA_WYSIWYG_FONT_SIZE; ?>pt;';

             config.debug = <?php echo HTML_AREA_WYSIWYG_DEBUG; ?>;

          	 //editor_generate('tour_arrangement',config);



<?php if ((HTML_AREA_WYSIWYG_DISABLE_JPSY == 'Enable') && (HTML_AREA_WYSIWYG_DISABLE == 'Enable')){ ?>

             config.height = "25px";

             config.bodyStyle = 'background-color: white; font-family: Arial; color: black; font-size:12px;';

             config.toolbar = [ ['InsertImageURL'] ];

             config.OscImageRoot = '<?= trim(HTTP_SERVER . DIR_WS_CATALOG_IMAGES) ?>';

             editor_generate('products_image',config);

             editor_generate('products_image_med',config);

             editor_generate('products_image_lrg',config);

            <?php } ?>

            </script>

<?php } ?>







      <tr>

        <td><?php echo tep_draw_separator('pixel_trans.gif', '1', '10'); ?></td>
      </tr>



     <tr>

		<td colspan="2" align="right"><?php echo '<a href="' .  (HTTP_SERVER . DIR_WS_ADMIN . 'eticket.php') . '?' . (tep_get_all_get_params(array('oID')) . 'oID=' . $HTTP_GET_VARS['oID']) . '" target="_blank">' . tep_image_button('button_preview.gif', IMAGE_PREVIEW) . '</a> '.'<a href="' .  (HTTP_SERVER . DIR_WS_ADMIN . 'eticket.php') . '?' . (tep_get_all_get_params(array('oID')) . 'oID=' . $HTTP_GET_VARS['oID']) . '&sendmail=true" target="_blank">' . tep_image_button('button_send_mail.gif', IMAGE_SEND_EMAIL) . '</a> '. tep_image_submit('button_update.gif', IMAGE_UPDATE).' <a href="' . tep_href_link(FILENAME_ORDERS, tep_get_all_get_params(array('action'))) . '&action=edit">' . tep_image_button('button_back.gif', IMAGE_BACK) . '</a>'; ?></td>
     </tr>



	 </form>

 <?php

        }else{

        ?>

		<script language="javascript"><!--

var dateAvailable_dept_start = new ctlSpiffyCalendarBox("dateAvailable_dept_start", "orders", "dept_start_date","btnDate3","<?php echo tep_get_date_disp($dept_start_date); ?>",scBTNMODE_CUSTOMBLUE);
var dateAvailable_dept_end = new ctlSpiffyCalendarBox("dateAvailable_dept_end", "orders", "dept_end_date","btnDate4","<?php echo tep_get_date_disp($dept_end_date); ?>",scBTNMODE_CUSTOMBLUE);
//--></script>

      <tr>

        <td width="100%"><table border="0" width="100%" cellspacing="0" cellpadding="0">

          <tr>

            <td class="pageHeading" width="20%"><?php echo HEADING_TITLE; ?></td>

             <td align="left" width="45%" valign="top"><table width="100%" border="0" cellspacing="0" cellpadding="3">
<?php echo tep_draw_form('orders', FILENAME_ORDERS, '', 'get'); ?>
              <tr>

                <td class="smallText"  colspan="2"><?php
				 if (isset($HTTP_GET_VARS['search']) && tep_not_null($HTTP_GET_VARS['search'])) {
					 $oID=$_GET['search'];
				 }
				 echo HEADING_TITLE_SEARCH . ' ' . tep_draw_input_field('oID', '', 'size="12"') . tep_draw_hidden_field('action', 'edit'); ?></td>
             </tr>
			  <?php if($access_full_edit == 'true' || $login_groups_id == '2' || $login_groups_id == '7' || $access_order_cost == 'true') { ?>
			  <tr>
                <td class="smallText"  colspan="2">
				<?php echo TABEL_HEADING_SALES_AMT . ' ' . tep_draw_input_field('sales_amt', $HTTP_GET_VARS['sales_amt'], 'size="12"');?>				</td>
			  </tr>

			   <tr>
                <td class="smallText"  colspan="2">
				<?php echo TABEL_HEADING_INVOICE_NO . ' ' . tep_draw_input_field('invoice_no', $HTTP_GET_VARS['invoice_no'], 'size="12"');?>				</td>
			  </tr>
			  <?php } ?>
			  <?php if($access_full_edit == 'true' || $access_order_cost == 'true'){ ?>
			   <tr>
                <td class="smallText"  colspan="2">
				<?php echo TABEL_HEADING_INVOICE_AMT . ' ' . tep_draw_input_field('invoice_amt', $HTTP_GET_VARS['invoice_amt'], 'size="12"');?>				</td>
			  </tr>
			  <?php } ?>
			 <tr>
			  	<td  class="smallText"> Date of Departure Start:
				<script language="javascript">dateAvailable_dept_start.writeControl(); dateAvailable_dept_start.dateFormat="MM/dd/yyyy";</script>				</td>
				<td  class="smallText"> Date of Departure End:
					<script language="javascript">dateAvailable_dept_end.writeControl(); dateAvailable_dept_end.dateFormat="MM/dd/yyyy";</script>				</td>
			</tr>

			<tr>
			<td></td>
				<td>
					<?php echo tep_image_submit('button_search.gif', IMAGE_SEARCH); ?>				</td>
			</tr>

			 </form>



            </table></td>
<td width="35%" valign="top">
				<table width="100%" align="right" cellpadding="2" cellspacing="2">
					<tr>
			<td colspan="2">
			<?php echo tep_draw_form('status', FILENAME_ORDERS, '', 'get'); ?>
			<table width="100%" cellpadding="0" cellspacing="0">
			  <tr>
					<td class="smallText" colspan="2">
						<?php echo HEADING_TITLE_STATUS . ' ' . tep_draw_pull_down_menu('status', array_merge(array(array('id' => '', 'text' => TEXT_ALL_ORDERS)), $orders_statuses), '', 'style="width:250px;" onChange="this.form.submit();"');
						if($_GET['providers']!=""){
							echo tep_draw_hidden_field('providers', $_GET['providers']);
						}?>
					</td>
      	</tr>
			</table>
			<?php echo '</form>'; ?>			</td>
			</tr>
	<tr>
			<td colspan="2">
			<?php echo tep_draw_form('start_date', FILENAME_ORDERS, '', 'get'); ?>
			<table width="100%" cellpadding="0" cellspacing="0">
			  <tr>

                <td class="smallText" colspan="2">
					<?php
						$date_options = array();
						$date_options[] = array('id' => '', 'text' => TEXT_ALL_ORDERS);
						$date_options[] = array('id' => '3', 'text' => 'Three Days');
						$date_options[] = array('id' => '7', 'text' => 'One Week');
						$date_options[] = array('id' => '14', 'text' => 'Two Weeks');
						$date_options[] = array('id' => '31', 'text' => 'One Month');
						$date_options[] = array('id' => 'greater', 'text' => 'Future');

						echo 'Tour Start Date Filter' . ' ' . tep_draw_pull_down_menu('start_date', $date_options, '', 'onChange="this.form.submit();"'); ?>				</td>
              </tr>
			</table>
			<?php echo '</form>'; ?>			</td></tr>
			<tr>
				<td colspan="2">
					<?php echo tep_draw_form('providers', FILENAME_ORDERS, '', 'get'); ?>
					<table width="100%" cellpadding="0" cellspacing="0">
						<tr>
							<td class="smallText" colspan="2">
							<?php
								$cond_status_ws_providers="";
								if($_GET['status']!=""){
									echo tep_draw_hidden_field('status', $_GET['status']);
									$cond_status_ws_providers=" WHERE agency_id IN (SELECT agency_id FROM ".TABLE_PRODUCTS." p, ".TABLE_ORDERS_PRODUCTS." op, ".TABLE_ORDERS." o WHERE p.products_id=op.products_id AND o.orders_id=op.orders_id AND o.orders_status='".$_GET['status']."' )";
								}

								if(tep_not_null($HTTP_GET_VARS['dept_start_date'])){
								echo tep_draw_hidden_field('dept_start_date', $HTTP_GET_VARS['dept_start_date']);
								}
								
								if(tep_not_null($HTTP_GET_VARS['dept_end_date'])){
								echo tep_draw_hidden_field('dept_end_date', $HTTP_GET_VARS['dept_end_date']);
								}
								
								echo tep_draw_hidden_field('sort', 'date');
								echo tep_draw_hidden_field('order', 'decending');
						
								$provider_array = array(array('id' => '', 'text' => SELECT_NONE));
								$provider_query = tep_db_query("select agency_id,agency_name from ".TABLE_TRAVEL_AGENCY." ".$cond_status_ws_providers." order by agency_name asc");
								while($provider_result = tep_db_fetch_array($provider_query))
								{
									$provider_array[] = array('id' => $provider_result['agency_id'],
																						 'text' => $provider_result['agency_name']);
								}

								echo TEXT_PROVIDERS.tep_draw_pull_down_menu('providers', $provider_array, $_GET['providers'], 'style="width:230px;" onChange="this.form.submit();"');
								?>
							</td>
						</tr>
					</table>
					<?php echo '</form>'; ?>
				</td>
			</tr>
			<tr>
			  <td colspan="2" ><a href="<?php echo tep_href_link(FILENAME_TOUR_CODE_DECODE);?>" target="_blank"><b>Click here to show Encoded/Decoded Tour Code</b></a></td>
			  </tr>

			<tr><td height="5"><?php echo tep_draw_separator('pixel_trans.gif', 50, 10); ?></td></tr>
				</table>			</td>
          </tr>

        </table>		</td>
      </tr>

	  <?php
	  // howard added Orders Warning start
	  // 取得 CC冻结超过15天未处理成 Charge Captured  已收费 的订单总数
	  $OldDateTime = date('Y-m-d 23:59:59', (time()-(15*24*60*60)) );

	  $cc_check_sql = tep_db_query('SELECT orders_id FROM `orders` WHERE orders_status not in (0,6,100005,100058,100006) AND date_purchased < "'.$OldDateTime.'" AND cc_number !="" AND cc_number is not null ');
	  //筛选
	  $array_1 = array();
	  while($cc_check = tep_db_fetch_array($cc_check_sql)){
		 $check_oh_sql = tep_db_query('SELECT orders_id FROM `orders_status_history` WHERE orders_id="'.(int)$cc_check['orders_id'].'" AND orders_status_id ="100006" limit 1');
		 $check_oh_row = tep_db_fetch_array($check_oh_sql);
		 if(!(int)$check_oh_row['orders_id']){
		 	$array_1[] = $cc_check['orders_id'];
		 }
	  }

	  //取得航班信息更新的订单
	  $flight_check_sql = tep_db_query('SELECT count(*) as count
                             FROM orders_product_flight f, orders o
                             WHERE f.orders_id = o.orders_id AND f.show_warning_on_admin = "1" AND (
                             o.orders_status <>6 AND o.orders_status <>100058 AND o.orders_status <>100002 AND o.orders_status <>100005 AND o.orders_status <>100006
)');
	  $flight_check_row = tep_db_fetch_array($flight_check_sql);

	  ?>
	  <tr><td class="main">
	  <table border="0" cellspacing="0" cellpadding="0">
		  <tr>
			<td rowspan="2" nowrap="nowrap" class="pageHeading">订单预警栏&nbsp;</td>
			<td  nowrap="NOWRAP" class="main" >&nbsp;CC冻结超过15天未处理[<a href="<?php echo tep_href_link('orders_warning.php','action=CC_check');?>" target="_blank"><span class="errorText"><?php echo count($array_1);?></span></a>]</td>
		  </tr>
		  <tr>
			<td class="main" nowrap>&nbsp;航班信息更新[<a href="<?php echo tep_href_link('orders_warning.php','action=flight_check');?>" target="_blank"><span class="errorText"><?php echo (int)$flight_check_row['count']?></span></a>]</td>
		  </tr>
		</table>
	  </td></tr>
	  <?php
	  // howard added Orders Warning end
	  ?>

      <tr>

        <td><table border="0" width="100%" cellspacing="0" cellpadding="0">

          <tr>
          <tr>

            <td valign="top"><table border="0" width="100%" cellspacing="0" cellpadding="2">

<?php

$search_extra_where = '';
$search_extra_get = '';
$search_extra_invoice_sale_amt = '';
    if (
		isset($HTTP_GET_VARS['search']) && tep_not_null($HTTP_GET_VARS['search'])  ||
		isset($HTTP_GET_VARS['sales_amt']) && tep_not_null($HTTP_GET_VARS['sales_amt'])  ||
		isset($HTTP_GET_VARS['invoice_amt']) && tep_not_null($HTTP_GET_VARS['invoice_amt'])  ||
		isset($HTTP_GET_VARS['invoice_no']) && tep_not_null($HTTP_GET_VARS['invoice_no'])
		) {
      $keywords = tep_db_input(tep_db_prepare_input($HTTP_GET_VARS['search']));

 if($HTTP_GET_VARS['invoice_amt'] !='' || $HTTP_GET_VARS['invoice_no'] !=''){



			if($HTTP_GET_VARS['invoice_amt'] !=''){
			$search_extra_invoice_sale_amt .= " and oph.invoice_amount like '".$HTTP_GET_VARS['invoice_amt']."%' ";
			}

			if($HTTP_GET_VARS['invoice_no'] !=''){
			$search_extra_invoice_sale_amt .= " and oph.invoice_number like '".$HTTP_GET_VARS['invoice_no']."%' ";
			}


			$search_invoice_number_ids = '';
			$search_invoice_number_query_sql = "select o.orders_id, oph.invoice_number   from  ".TABLE_ORDERS_PRODUCTS_UPDATE_HISTORY." oph LEFT JOIN ".TABLE_ORDERS_PRODUCTS_UPDATE_HISTORY." oph2 ON oph.orders_products_id = oph2.orders_products_id
AND oph.ord_prod_history_id < oph2.ord_prod_history_id and oph.last_updated_date < oph2.last_updated_date,  ".TABLE_ORDERS_PRODUCTS." as op, orders as o, products as p where oph2.last_updated_date IS NULL  ".$search_extra_invoice_sale_amt." and oph.orders_products_id = op.orders_products_id and op.orders_id = o.orders_id and  op.products_id=p.products_id order by op.products_departure_date "; //o.last_modified desc

			$search_invoice_number_query = tep_db_query($search_invoice_number_query_sql);
			if(tep_db_num_rows($search_invoice_number_query)>0){

			  while ($search_invoice_number = tep_db_fetch_array($search_invoice_number_query)) {
				$search_invoice_number_ids .= "'" . (int)$search_invoice_number['orders_id'] . "', ";
			  }

			  $search_invoice_number_ids = substr($search_invoice_number_ids, 0, -2);
			}

			 if($search_invoice_number_ids != ''){

			  $search_invoice_number_ids_where .= " or  o.orders_id in (" . $search_invoice_number_ids . ") ";
			 }

	 }

	   if($keywords == ''){
	   $keywords = 'xxxxxxxxxxxxxxx';
	   }

	   if($HTTP_GET_VARS['sales_amt'] !=''){
			$search_sale_amt = " or op.final_price like '".$HTTP_GET_VARS['sales_amt']."%' ";
		}

	  $search_extra_where .= " and (o.customers_name like '%" . $keywords . "%' or op.products_model like '%".$keywords."%' or p.provider_tour_code like '%".$keywords."%' ".$search_sale_amt." ".$search_invoice_number_ids_where.") ";

	  $search_extra_get = "&search=".$_GET['search'];
	  $addgroupby = " group by  o.orders_id ";
	  }
		if(isset($_GET['providers']) && tep_not_null($_GET['providers'])){
			$search_extra_where.= " AND op.products_id IN (SELECT p.products_id FROM ".TABLE_PRODUCTS." p WHERE p.agency_id = '".tep_db_input($_GET['providers'])."') ";
			$search_extra_get .= "&providers=".$_GET['providers'];
		}
	  if ((isset($HTTP_GET_VARS['dept_start_date']) && tep_not_null($HTTP_GET_VARS['dept_start_date'])) && (isset($HTTP_GET_VARS['dept_end_date']) && tep_not_null($HTTP_GET_VARS['dept_end_date'])) ) {

	  $make_start_date = tep_get_date_db($HTTP_GET_VARS['dept_start_date']) ;
  	  $make_end_date = tep_get_date_db($HTTP_GET_VARS['dept_end_date']) ;
	  $search_extra_where .= " and  op.products_departure_date >= '" . $make_start_date . "' and op.products_departure_date <= '" . $make_end_date . "' ";

	   $search_extra_get .= "&dept_start_date=".$_GET['dept_start_date']."&dept_end_date=".$_GET['dept_end_date'];

	  }

	  else if ((isset($HTTP_GET_VARS['dept_start_date']) && tep_not_null($HTTP_GET_VARS['dept_start_date'])) && (!isset($HTTP_GET_VARS['dept_end_date']) or !tep_not_null($HTTP_GET_VARS['dept_end_date'])) ) {

	  $make_start_date = tep_get_date_db($HTTP_GET_VARS['dept_start_date']);

	  $search_extra_where .= " and  op.products_departure_date >= '" . $make_start_date . "' ";

	  $search_extra_get .= "&dept_start_date=".$_GET['dept_start_date'];

	  }
	  else if ((!isset($HTTP_GET_VARS['dept_start_date']) or !tep_not_null($HTTP_GET_VARS['dept_start_date'])) && (isset($HTTP_GET_VARS['dept_end_date']) && tep_not_null($HTTP_GET_VARS['dept_end_date'])) ) {

	 $make_end_date = tep_get_date_db($HTTP_GET_VARS['dept_end_date']);

	    $search_extra_where .= " and  op.products_departure_date <= '" . $make_end_date . "' ";
	  $search_extra_get .= "&dept_end_date=".$_GET['dept_end_date'];
	  }




  $HEADING_CUSTOMERS = TABLE_HEADING_CUSTOMERS;

  $HEADING_CUSTOMERS .= '<br><a href="' . $_SERVER['PHP_SELF'] . '?sort=customer&order=ascending'.(isset($HTTP_GET_VARS['status']) ? '&status=' . $HTTP_GET_VARS['status'] . '' : '').(isset($HTTP_GET_VARS['start_date']) ? '&start_date=' . $HTTP_GET_VARS['start_date'] . '' : ''). $search_extra_get.'">';

  $HEADING_CUSTOMERS .= '&nbsp;<img src="images/arrow_up.gif" border="0"></a>';

  $HEADING_CUSTOMERS .= '<a href="' . $_SERVER['PHP_SELF'] . '?sort=customer&order=decending'.(isset($HTTP_GET_VARS['status']) ? '&status=' . $HTTP_GET_VARS['status'] . '' : '').(isset($HTTP_GET_VARS['start_date']) ? '&start_date=' . $HTTP_GET_VARS['start_date'] . '' : ''). $search_extra_get.'">';

  $HEADING_CUSTOMERS .= '&nbsp;<img src="images/arrow_down.gif" border="0"></a>';

  $HEADING_DATE_PURCHASED = TABLE_HEADING_DATE_PURCHASED;

  $HEADING_DATE_PURCHASED .= '<br><a href="' . $_SERVER['PHP_SELF'] . '?sort=date&order=ascending'.(isset($HTTP_GET_VARS['status']) ? '&status=' . $HTTP_GET_VARS['status'] . '' : '').(isset($HTTP_GET_VARS['start_date']) ? '&start_date=' . $HTTP_GET_VARS['start_date'] . '' : ''). $search_extra_get.'">';

  $HEADING_DATE_PURCHASED .= '&nbsp;<img src="images/arrow_up.gif" border="0"></a>';

  $HEADING_DATE_PURCHASED .= '<a href="' . $_SERVER['PHP_SELF'] . '?sort=date&order=decending'.(isset($HTTP_GET_VARS['status']) ? '&status=' . $HTTP_GET_VARS['status'] . '' : '').(isset($HTTP_GET_VARS['start_date']) ? '&start_date=' . $HTTP_GET_VARS['start_date'] . '' : ''). $search_extra_get.'">';

  $HEADING_DATE_PURCHASED .= '&nbsp;<img src="images/arrow_down.gif" border="0"></a>';

  $HEADING_AD_SOURCE = 'Ad Source';

    $HEADING_DATE_OF_DEPARTURE ='Date of Departure' ;
	$HEADING_DATE_OF_DEPARTURE .= '<br><a href="' . $_SERVER['PHP_SELF'] . '?sort=departure_date&order=ascending'.(isset($HTTP_GET_VARS['status']) ? '&status=' . $HTTP_GET_VARS['status'] . '' : '').(isset($HTTP_GET_VARS['start_date']) ? '&start_date=' . $HTTP_GET_VARS['start_date'] . '' : ''). $search_extra_get.'">';
	$HEADING_DATE_OF_DEPARTURE .= '&nbsp;<img src="images/arrow_up.gif" border="0"></a>';
	$HEADING_DATE_OF_DEPARTURE .= '<a href="' . $_SERVER['PHP_SELF'] . '?sort=departure_date&order=decending'.(isset($HTTP_GET_VARS['status']) ? '&status=' . $HTTP_GET_VARS['status'] . '' : '').(isset($HTTP_GET_VARS['start_date']) ? '&start_date=' . $HTTP_GET_VARS['start_date'] . '' : ''). $search_extra_get.'">';
	$HEADING_DATE_OF_DEPARTURE .= '&nbsp;<img src="images/arrow_down.gif" border="0"></a>';

	$HEADING_LAST_MODIFY_DATE ='Last Modify<br />Date' ;

 $HEADING_LAST_MODIFY_DATE .= '<br><a href="' . $_SERVER['PHP_SELF'] . '?sort=last_modify_date&order=ascending'.(isset($HTTP_GET_VARS['status']) ? '&status=' . $HTTP_GET_VARS['status'] . '' : '').(isset($HTTP_GET_VARS['start_date']) ? '&start_date=' . $HTTP_GET_VARS['start_date'] . '' : '').$search_extra_get.'">';

  $HEADING_LAST_MODIFY_DATE .= '&nbsp;<img src="images/arrow_up.gif" border="0"></a>';

  $HEADING_LAST_MODIFY_DATE .= '<a href="' . $_SERVER['PHP_SELF'] . '?sort=last_modify_date&order=decending'.(isset($HTTP_GET_VARS['status']) ? '&status=' . $HTTP_GET_VARS['status'] . '' : '').(isset($HTTP_GET_VARS['start_date']) ? '&start_date=' . $HTTP_GET_VARS['start_date'] . '' : '').$search_extra_get.'">';

  $HEADING_LAST_MODIFY_DATE .= '&nbsp;<img src="images/arrow_down.gif" border="0"></a>';

	$HEADING_LAST_STATUS_MODIFY_BY =TXT_LAST_STATUS_CHANGED_BY;

 $HEADING_LAST_STATUS_MODIFY_BY .= '<br><a href="' . $_SERVER['PHP_SELF'] . '?sort=last_status_modify_by&order=ascending'.(isset($HTTP_GET_VARS['status']) ? '&status=' . $HTTP_GET_VARS['status'] . '' : '').(isset($HTTP_GET_VARS['start_date']) ? '&start_date=' . $HTTP_GET_VARS['start_date'] . '' : '').$search_extra_get.'">';

  $HEADING_LAST_STATUS_MODIFY_BY .= '&nbsp;<img src="'.DIR_WS_IMAGES.'arrow_up.gif" border="0"></a>';

  $HEADING_LAST_STATUS_MODIFY_BY .= '<a href="' . $_SERVER['PHP_SELF'] . '?sort=last_status_modify_by&order=decending'.(isset($HTTP_GET_VARS['status']) ? '&status=' . $HTTP_GET_VARS['status'] . '' : '').(isset($HTTP_GET_VARS['start_date']) ? '&start_date=' . $HTTP_GET_VARS['start_date'] . '' : '').$search_extra_get.'">';

  $HEADING_LAST_STATUS_MODIFY_BY .= '&nbsp;<img src="'.DIR_WS_IMAGES.'arrow_down.gif" border="0"></a>';

 ?>

              <tr class="dataTableHeadingRow">

                <td class="dataTableHeadingContent"><?php echo HEADING_ORDER_ID; ?></td>

                <td class="dataTableHeadingContent"><?php echo $HEADING_CUSTOMERS; ?></td>

				<td class="dataTableHeadingContent"><?php echo $HEADING_AD_SOURCE; ?></td>
				<?php
				/* Ref. URL
				<td class="dataTableHeadingContent">Ref. URL</td>
				*/
				?>

                <td class="dataTableHeadingContent" align="right" nowrap> <?php echo TABLE_HEADING_ORDER_TOTAL; ?></td>

                <td class="dataTableHeadingContent" nowrap><?php echo $HEADING_DATE_PURCHASED; ?></td>

				<td class="dataTableHeadingContent" nowrap><?php echo $HEADING_DATE_OF_DEPARTURE; ?></td>

				<td class="dataTableHeadingContent" ><?php echo $HEADING_LAST_MODIFY_DATE; ?></td>

				<td class="dataTableHeadingContent" ><?php echo $HEADING_LAST_STATUS_MODIFY_BY; ?></td>

				<td class="dataTableHeadingContent" nowrap ><?php echo TABLE_HEADING_TOUR_CODE; ?></td>

				<td class="dataTableHeadingContent"><?php echo TABLE_HEADING_PROVIDER_TOUR_CODE; ?></td>

                <td class="dataTableHeadingContent" align="right"><?php echo TABLE_HEADING_STATUS; ?></td>

                <td class="dataTableHeadingContent" align="right"><?php echo TABLE_HEADING_ACTION; ?>&nbsp;</td>
              </tr>

<?php

    $sortorder = 'order by ';

	$addedtable ='';

	$addextracondition ='';

    if($_GET["sort"] == 'customer') {

      if($_GET["order"] == 'ascending') {

        $sortorder .= 'o.customers_name  asc, ';

      } else {

        $sortorder .= 'o.customers_name desc, ';

      }

    } elseif($_GET["sort"] == 'date') {

      if($_GET["order"] == 'ascending') {

        $sortorder .= 'o.date_purchased  asc, ';

      } else {

        $sortorder .= 'o.date_purchased desc, ';

      }
} elseif($_GET["sort"] == 'departure_date') {

       if($_GET["order"] == 'ascending') {

        $sortorder .= 'opdate asc, ';

		 $addselect = " min(op.products_departure_date) AS opdate, ";

      } else {

        $sortorder .= 'opdate desc, ';

		 $addselect = " max(op.products_departure_date) AS opdate, ";

      }

    }else if($_GET["sort"] == 'last_modify_date') {

      if($_GET["order"] == 'ascending') {

        $sortorder .= 'o.last_modified  asc, ';

      } else {

        $sortorder .= 'o.last_modified desc, ';

      }

    } else if($_GET["sort"] == 'last_status_modify_by') {
      if($_GET["order"] == 'ascending') {
        $sortorder .= 'last_status_modified_by asc, ';
      } else {
        $sortorder .= 'last_status_modified_by desc, ';
      }
    }

	 $addedtable = ", " . TABLE_ORDERS_PRODUCTS . " as op ";

	  $addextracondition = " o.orders_id = op.orders_id  and ";
	  $addgroupby = " group by  o.orders_id ";


	if(!$_GET["sort"]){
		$check_sql = tep_db_query("select distinct  o.orders_id, ".$addselect." o.customers_name,o.customers_advertiser,  o.customers_id, o.payment_method, o.date_purchased, o.last_modified, o.currency, o.currency_value, s.orders_status_name, ot.text as order_total, op.products_id from " . TABLE_ORDERS . " o, " . TABLE_ORDERS_TOTAL . " ot, " . TABLE_ORDERS_STATUS . " s ".$addedtable." where ". $addextracondition." o.orders_status = s.orders_status_id and ot.orders_id = o.orders_id and s.language_id = '" . (int)$languages_id . "' and ot.class = 'ot_total' and orders_status='1' limit 1");

		$check_row = tep_db_fetch_array($check_sql);
		if((int)$check_row['orders_id']){
			$sortorder .= 'o.orders_status asc, ';
		}
	}

	$sortorder .= 'o.orders_id DESC';

	if (isset($HTTP_GET_VARS['cID'])) {

      $cID = tep_db_prepare_input($HTTP_GET_VARS['cID']);

      $orders_query_raw = "select ".$addselect." o.orders_id, o.customers_name, o.customers_advertiser, o.customers_id, o.payment_method, o.date_purchased, o.last_modified, o.currency, o.currency_value, s.orders_status_name, ot.text as order_total, adm.admin_firstname as last_status_modified_by from " . TABLE_ORDERS . " o LEFT JOIN ".TABLE_ORDERS_STATUS_HISTORY." osh ON o.orders_id=osh.orders_id LEFT JOIN ".TABLE_ADMIN." adm ON osh.updated_by=adm.admin_id, " . TABLE_ORDERS_TOTAL . " ot, " . TABLE_ORDERS_STATUS . " s where o.customers_id = '" . (int)$cID . "' and ot.orders_id = o.orders_id and o.orders_status = s.orders_status_id and s.language_id = '" . (int)$languages_id . "' and ot.class = 'ot_total' AND osh.orders_status_history_id=(SELECT MAX(oh.orders_status_history_id) FROM ".TABLE_ORDERS_STATUS_HISTORY." oh WHERE oh.orders_id=o.orders_id GROUP BY oh.orders_id) ".$sortorder;

    } elseif (isset($HTTP_GET_VARS['status']) && (tep_not_null($HTTP_GET_VARS['status']))) {

      $status = tep_db_prepare_input($HTTP_GET_VARS['status']);

      $orders_query_raw = "select ".$addselect." o.orders_id, o.customers_name, o.customers_advertiser,  o.payment_method, o.date_purchased, o.last_modified, o.currency, o.currency_value, s.orders_status_name, ot.text as order_total, adm.admin_firstname as last_status_modified_by from " . TABLE_ORDERS . " o LEFT JOIN ".TABLE_ORDERS_STATUS_HISTORY." osh ON o.orders_id=osh.orders_id LEFT JOIN ".TABLE_ADMIN." adm ON osh.updated_by=adm.admin_id, " . TABLE_ORDERS_TOTAL . " ot, " . TABLE_ORDERS_STATUS . " s ".$addedtable." where ". $addextracondition." o.orders_status = s.orders_status_id and ot.orders_id = o.orders_id and s.language_id = '" . (int)$languages_id . "' and s.orders_status_id = '" . (int)$status . "' ".$search_extra_where." and ot.class = 'ot_total' AND osh.orders_status_history_id=(SELECT MAX(oh.orders_status_history_id) FROM ".TABLE_ORDERS_STATUS_HISTORY." oh WHERE oh.orders_id=o.orders_id GROUP BY oh.orders_id) group by o.orders_id ".$sortorder;

	} elseif (isset($HTTP_GET_VARS['start_date']) && (tep_not_null($HTTP_GET_VARS['start_date']))) {

      $start_date = tep_db_prepare_input($HTTP_GET_VARS['start_date']);

	  switch ($HTTP_GET_VARS['start_date']){
	  	case '3':
			//$start_date_where = " and op.products_departure_date > '".date('Y-m-d')."'";
			$start_date_where = " and orders_status not in(100002)  and DATEDIFF(op.products_departure_date,'".date('Y-m-d')."')>0 and DATEDIFF(op.products_departure_date,'".date('Y-m-d')."')<=3";
		break;
		case '7':
			//$start_date_where = " and op.products_departure_date > '".date('Y-m-d')."'";
			$start_date_where = " and orders_status not in(100002)  and DATEDIFF(op.products_departure_date,'".date('Y-m-d')."')>0 and DATEDIFF(op.products_departure_date,'".date('Y-m-d')."')<=7";
		break;
		case '14':
			//$start_date_where = " and op.products_departure_date > '".date('Y-m-d')."'";
			$start_date_where = " and orders_status not in(100002)  and DATEDIFF(op.products_departure_date,'".date('Y-m-d')."')>0 and DATEDIFF(op.products_departure_date,'".date('Y-m-d')."')<=14";
		break;
		case '31':
			//$start_date_where = " and op.products_departure_date > '".date('Y-m-d')."'";
			$start_date_where = " and orders_status not in(100002)  and DATEDIFF(op.products_departure_date,'".date('Y-m-d')."')>0 and DATEDIFF(op.products_departure_date,'".date('Y-m-d')."')<=31";
		break;
		case 'greater':
			$start_date_where = " and orders_status not in(100002)  and op.products_departure_date > '".date('Y-m-d')."'";
		break;
		default:
	  		$start_date_where = " ";
		break;
	  }


     $orders_query_raw = "select o.orders_id, o.customers_name,o.customers_advertiser,  o.payment_method, o.date_purchased, o.last_modified, o.currency, o.currency_value, s.orders_status_name, ot.text as order_total, adm.admin_firstname as last_status_modified_by from " . TABLE_ORDERS . " o LEFT JOIN ".TABLE_ORDERS_STATUS_HISTORY." osh ON o.orders_id=osh.orders_id LEFT JOIN ".TABLE_ADMIN." adm ON osh.updated_by=adm.admin_id, " . TABLE_ORDERS_TOTAL . " ot, " . TABLE_ORDERS_STATUS . " s ".$addedtable." where  ". $addextracondition." o.orders_status = s.orders_status_id and ot.orders_id = o.orders_id and s.language_id = '" . (int)$languages_id . "' and ot.class = 'ot_total' AND osh.orders_status_history_id=(SELECT MAX(oh.orders_status_history_id) FROM ".TABLE_ORDERS_STATUS_HISTORY." oh WHERE oh.orders_id=o.orders_id GROUP BY oh.orders_id) and s.orders_status_id != 100006 and s.orders_status_id != 6 ".$start_date_where." group by o.orders_id order by o.orders_id DESC";

    }
	else if(
	(isset($HTTP_GET_VARS['search']) && tep_not_null($HTTP_GET_VARS['search'])) ||
	(isset($HTTP_GET_VARS['dept_start_date']) && tep_not_null($HTTP_GET_VARS['dept_start_date'])) ||
	(isset($HTTP_GET_VARS['dept_end_date']) && tep_not_null($HTTP_GET_VARS['dept_end_date']))  ||
	(isset($HTTP_GET_VARS['sales_amt']) && tep_not_null($HTTP_GET_VARS['sales_amt']))  ||
	(isset($HTTP_GET_VARS['invoice_amt']) && tep_not_null($HTTP_GET_VARS['invoice_amt']))  ||
	(isset($HTTP_GET_VARS['invoice_no']) && tep_not_null($HTTP_GET_VARS['invoice_no']))  ||
	(isset($HTTP_GET_VARS['providers']) && tep_not_null($HTTP_GET_VARS['providers']))
	)
	{
 		$orders_query_raw = "select distinct o.orders_id, ".$addselect." o.customers_name,o.customers_advertiser,  o.customers_id, o.payment_method, o.date_purchased, o.last_modified, o.currency, o.currency_value, s.orders_status_name, ot.text as order_total, op.products_id, adm.admin_firstname as last_status_modified_by from " . TABLE_ORDERS . " o LEFT JOIN ".TABLE_ORDERS_STATUS_HISTORY." osh ON o.orders_id=osh.orders_id LEFT JOIN ".TABLE_ADMIN." adm ON osh.updated_by=adm.admin_id, " . TABLE_ORDERS_TOTAL . " ot, " . TABLE_ORDERS_PRODUCTS . " op left join ".TABLE_PRODUCTS." p on p.products_id=op.products_id, " . TABLE_ORDERS_STATUS . " s  where ". $addextracondition." o.orders_status = s.orders_status_id and ot.orders_id = o.orders_id and op.orders_id=o.orders_id and ot.orders_id=o.orders_id and s.language_id = '" . (int)$languages_id . "' and ot.class = 'ot_total' AND osh.orders_status_history_id=(SELECT MAX(oh.orders_status_history_id) FROM ".TABLE_ORDERS_STATUS_HISTORY." oh WHERE oh.orders_id=o.orders_id GROUP BY oh.orders_id) " . $search_extra_where . $addgroupby . $sortorder ;
    }
	else {

      //$orders_query_raw = "select o.orders_id, o.customers_name,  o.customers_advertiser, o.customers_id, o.payment_method, o.date_purchased, o.last_modified, o.currency, o.currency_value, s.orders_status_name, ot.text as order_total from " . TABLE_ORDERS . " o, " . TABLE_ORDERS_TOTAL . " ot, " . TABLE_ORDERS_STATUS . " s where o.orders_status = s.orders_status_id and ot.orders_id = o.orders_id and s.language_id = '" . (int)$languages_id . "' and ot.class = 'ot_total' " . $sortorder;
		$orders_query_raw = "select distinct  o.orders_id, ".$addselect." o.customers_name,o.customers_advertiser,  o.customers_id, o.payment_method, o.date_purchased, o.last_modified, o.currency, o.currency_value, s.orders_status_name, ot.text as order_total, op.products_id, adm.admin_firstname as last_status_modified_by from " . TABLE_ORDERS . " o LEFT JOIN ".TABLE_ORDERS_STATUS_HISTORY." osh ON o.orders_id=osh.orders_id LEFT JOIN ".TABLE_ADMIN." adm ON osh.updated_by=adm.admin_id, " . TABLE_ORDERS_TOTAL . " ot, " . TABLE_ORDERS_STATUS . " s ".$addedtable." where ". $addextracondition." o.orders_status = s.orders_status_id and ot.orders_id = o.orders_id and s.language_id = '" . (int)$languages_id . "' and ot.class = 'ot_total' AND osh.orders_status_history_id=(SELECT MAX(oh.orders_status_history_id) FROM ".TABLE_ORDERS_STATUS_HISTORY." oh WHERE oh.orders_id=o.orders_id GROUP BY oh.orders_id) " . $addgroupby . $sortorder ;
    }
	//echo $orders_query_raw;exit;
    $orders_split = new splitPageResults($HTTP_GET_VARS['page'], MAX_DISPLAY_SEARCH_RESULTS_ADMIN, $orders_query_raw, $orders_query_numrows);

    $orders_query = tep_db_query($orders_query_raw);

    while ($orders = tep_db_fetch_array($orders_query)) {

    if ((!isset($HTTP_GET_VARS['oID']) || (isset($HTTP_GET_VARS['oID']) && ($HTTP_GET_VARS['oID'] == $orders['orders_id']))) && !isset($oInfo)) {

        $oInfo = new objectInfo($orders);

      }



      if (isset($oInfo) && is_object($oInfo) && ($orders['orders_id'] == $oInfo->orders_id)) {

        echo '              <tr id="defaultSelected" class="dataTableRowSelected" onmouseover="rowOverEffect(this)" onmouseout="rowOutEffect(this)" onclick="document.location.href=\'' . tep_href_link(FILENAME_ORDERS, tep_get_all_get_params(array('oID', 'action')) . 'oID=' . $oInfo->orders_id . '&action=edit') . '\'">' . "\n";

      } else {

        echo '              <tr class="dataTableRow" onmouseover="rowOverEffect(this)" onmouseout="rowOutEffect(this)" onclick="document.location.href=\'' . tep_href_link(FILENAME_ORDERS, tep_get_all_get_params(array('oID')) . 'oID=' . $orders['orders_id']) . '\'">' . "\n";

      }

?>

                <td class="dataTableContent" nowrap="nowrap" >
				<b><?php echo $orders['orders_id']; ?></b>
				<?php
				//结伴同游
				if(is_travel_comp((int)$orders['orders_id'])>0){
					echo '<b style="color:#FF9900">结伴同游</b> ';
				}
				//结伴同游 end
				//团购标记
				if(have_group_buy((int)$orders['orders_id'])>0){
					echo '<b style="color:#006699">团体预定</b> ';
				}
				//团购标记 end

				?>
				</td>

				<td class="dataTableContent" ><?php echo '<a href="' . tep_href_link(FILENAME_ORDERS, tep_get_all_get_params(array('oID', 'action')) . 'oID=' . $orders['orders_id'] . '&action=edit') . '">' . tep_image(DIR_WS_ICONS . 'preview.gif', ICON_PREVIEW) . '</a>&nbsp;' . $orders['customers_name']; ?></td>

               <td class="dataTableContent" ><?php echo $orders['customers_advertiser'];//tep_get_ad_source($orders['customers_id']); ?></td>

			   <?php /* Ref. URL
			   <td class="dataTableContent" align="right" nowrap="nowrap">
				<?php
				if((int)$orders['customers_id']){
					$cust_sql = tep_db_query('SELECT customers_referer_url FROM `customers` WHERE customers_id="'.(int)$orders['customers_id'].'" LIMIT 1');
					$cust_row = tep_db_fetch_array($cust_sql);
					if(tep_not_null($cust_row['customers_referer_url'])){
						echo '<a href="'.$cust_row['customers_referer_url'].'" target="_blank" title="'.$cust_row['customers_referer_url'].'" >'.substr($cust_row['customers_referer_url'], 0, 26).'...
</a>';
					}else{
						echo '&nbsp;';
					}
				}else{
					echo '&nbsp;';
				}
				?>
			   </td>
			   */?>

			   <td class="dataTableContent" align="right"><?php echo strip_tags($orders['order_total']); ?></td>


                <td class="dataTableContent" ><?php echo tep_datetime_short($orders['date_purchased']); ?></td>

				 <td class="dataTableContent" ><b><?php echo tep_get_date_of_departure($orders['orders_id']); ?></b></td>

				 <td class="dataTableContent" align="center"><?php echo get_datedifference($orders['last_modified']).' '.TXT_AGO; ?></td>

				 <td class="dataTableContent" align="center"><?php echo tep_db_prepare_input($orders['last_status_modified_by']); ?></td>

				 <td class="dataTableContent" nowrap ><?php echo tep_get_tours_codes_from($orders['orders_id']); ?></td>

				 <td class="dataTableContent" >
					<?php  echo tep_get_provider_tours_codes_from($orders['orders_id']);  ?>				 </td>

                <td class="dataTableContent" align="right"><?php echo $orders['orders_status_name']; ?></td>

                <td class="dataTableContent" align="right"><?php if (isset($oInfo) && is_object($oInfo) && ($orders['orders_id'] == $oInfo->orders_id)) { echo tep_image(DIR_WS_IMAGES . 'icon_arrow_right.gif', ''); } else { echo '<a href="' . tep_href_link(FILENAME_ORDERS, tep_get_all_get_params(array('oID')) . 'oID=' . $orders['orders_id']) . '">' . tep_image(DIR_WS_IMAGES . 'icon_info.gif', IMAGE_ICON_INFO) . '</a>'; } ?>&nbsp;</td>

              </tr>

<?php

    }

?>

              <tr>

                <td colspan="12"><table border="0" width="100%" cellspacing="0" cellpadding="2">

                  <tr>

                    <td class="smallText" valign="top"><?php echo $orders_split->display_count($orders_query_numrows, MAX_DISPLAY_SEARCH_RESULTS_ADMIN, $HTTP_GET_VARS['page'], TEXT_DISPLAY_NUMBER_OF_ORDERS); ?></td>

                    <td class="smallText" align="right"><?php echo $orders_split->display_links($orders_query_numrows, MAX_DISPLAY_SEARCH_RESULTS_ADMIN, MAX_DISPLAY_PAGE_LINKS, $HTTP_GET_VARS['page'], tep_get_all_get_params(array('page', 'oID', 'action'))); ?></td>
                  </tr>

                </table></td>
              </tr>

            </table></td>

<?php

  $heading = array();

  $contents = array();



  switch ($action) {

    case 'delete':

      $heading[] = array('text' => '<b>' . TEXT_INFO_HEADING_DELETE_ORDER . '</b>');



      $contents = array('form' => tep_draw_form('orders', FILENAME_ORDERS, tep_get_all_get_params(array('oID', 'action')) . 'oID=' . $oInfo->orders_id . '&action=deleteconfirm'));

      $contents[] = array('text' => TEXT_INFO_DELETE_INTRO . '<br><br>');

      $contents[] = array('text' => TEXT_INFO_DELETE_DATA . '&nbsp;' . $oInfo->customers_name . '<br>');

      $contents[] = array('text' => TEXT_INFO_DELETE_DATA_OID . '&nbsp;<b>' . $oInfo->orders_id . '</b><br>');

      $contents[] = array('text' => '<br>' . tep_draw_checkbox_field('restock') . ' ' . TEXT_INFO_RESTOCK_PRODUCT_QUANTITY);

      $contents[] = array('align' => 'center', 'text' => '<br>' . tep_image_submit('button_delete.gif', IMAGE_DELETE) . ' <a href="' . tep_href_link(FILENAME_ORDERS, tep_get_all_get_params(array('oID', 'action')) . 'oID=' . $oInfo->orders_id) . '">' . tep_image_button('button_cancel.gif', IMAGE_CANCEL) . '</a>');

      break;





    default:

      if (isset($oInfo) && is_object($oInfo)) {

        $heading[] = array('text' => '<b>[' . $oInfo->orders_id . ']&nbsp;&nbsp;' . tep_datetime_short($oInfo->date_purchased) . '</b>');



        if (tep_not_null($oInfo->last_modified)) $contents[] = array('text' => TEXT_DATE_ORDER_LAST_MODIFIED . ' ' . tep_date_short($oInfo->last_modified));

		 //$contents[] = array('align' => 'center', 'text' => '<a href="' . tep_href_link(FILENAME_ORDERS, tep_get_all_get_params(array('oID', 'action')) . 'oID=' . $oInfo->orders_id . '&action=edit') . '">' . tep_image_button('button_edit.gif', IMAGE_EDIT) . '</a> <a href="' . tep_href_link(FILENAME_ORDERS, tep_get_all_get_params(array('oID', 'action')) . 'oID=' . $oInfo->orders_id . '&action=delete') . '">' . tep_image_button('button_delete.gif', IMAGE_DELETE) . '</a> <a href="' . tep_href_link(FILENAME_EDIT_ORDERS, 'oID=' . $oInfo->orders_id). '">' . tep_image_button('button_update.gif', IMAGE_UPDATE) . '</a>');
		 $contents[] = array('align' => 'center', 'text' => '<a href="' . tep_href_link(FILENAME_ORDERS, tep_get_all_get_params(array('oID', 'action')) . 'oID=' . $oInfo->orders_id . '&action=edit') . '">' . tep_image_button('button_edit.gif', IMAGE_EDIT) . '</a> <a href="' . tep_href_link(FILENAME_EDIT_ORDERS, 'oID=' . $oInfo->orders_id). '">' . tep_image_button('button_update.gif', IMAGE_UPDATE) . '</a>');




     $contents[] = array('text' => '<br>' . TEXT_DATE_ORDER_CREATED . ' ' . tep_date_short($oInfo->date_purchased));

        $contents[] = array('text' => '<br>' . TEXT_INFO_PAYMENT_METHOD . ' '  . $oInfo->payment_method);

//begin PayPal_Shopping_Cart_IPN V2.8 DMG

        if (strtolower($oInfo->payment_method) == 'paypal') {

        include_once(DIR_FS_CATALOG_MODULES . 'payment/paypal/functions/general.func.php');

        $contents[] = array('text' => TABLE_HEADING_PAYMENT_STATUS . ': ' .paypal_payment_status($oInfo->orders_id) );

    }

//end PayPal_shopping_Cart_IPN

if(isset($_GET['providers']) && tep_not_null($_GET['providers'])){
	$start_date_where.= " AND op.products_id IN (SELECT p.products_id FROM ".TABLE_PRODUCTS." p WHERE p.agency_id = '".tep_db_input($_GET['providers'])."') ";
	$search_extra_get_query_string = "&providers=".$_GET['providers'];
}
	  $orders_contents = '';
  $orders_status_query = tep_db_query("select orders_status_name, orders_status_id from " . TABLE_ORDERS_STATUS . " where language_id = '" . $languages_id . "'  ORDER BY orders_status_name ASC ");
  //select orders_status_name, orders_status_id from " . TABLE_ORDERS_STATUS . " where language_id = '" . $languages_id . "' order by orders_status_name
  while ($orders_status = tep_db_fetch_array($orders_status_query)) {

 if (isset($HTTP_GET_VARS['start_date']) && (tep_not_null($HTTP_GET_VARS['start_date']))) {

      $start_date = tep_db_prepare_input($HTTP_GET_VARS['start_date']);

	  switch ($HTTP_GET_VARS['start_date']){
	  	case '3':
			//$start_date_where = " and op.products_departure_date > '".date('Y-m-d')."'";
			$start_date_where = " and DATEDIFF(op.products_departure_date,'".date('Y-m-d')."')>0 and DATEDIFF(op.products_departure_date,'".date('Y-m-d')."')<=3";
		break;
		case '7':
			//$start_date_where = " and op.products_departure_date > '".date('Y-m-d')."'";
			$start_date_where = " and DATEDIFF(op.products_departure_date,'".date('Y-m-d')."')>0 and DATEDIFF(op.products_departure_date,'".date('Y-m-d')."')<=7";
		break;
		case '14':
			//$start_date_where = " and op.products_departure_date > '".date('Y-m-d')."'";
			$start_date_where = " and DATEDIFF(op.products_departure_date,'".date('Y-m-d')."')>0 and DATEDIFF(op.products_departure_date,'".date('Y-m-d')."')<=14";
		break;
		case '31':
			//$start_date_where = " and op.products_departure_date > '".date('Y-m-d')."'";
			$start_date_where = " and DATEDIFF(op.products_departure_date,'".date('Y-m-d')."')>0 and DATEDIFF(op.products_departure_date,'".date('Y-m-d')."')<=31";
		break;
		case 'greater':
			$start_date_where = " and op.products_departure_date > '".date('Y-m-d')."'";
		break;
		default:
	  		$start_date_where = " ";
		break;
	  }
}else if ((isset($HTTP_GET_VARS['dept_start_date']) && tep_not_null($HTTP_GET_VARS['dept_start_date'])) && (isset($HTTP_GET_VARS['dept_end_date']) && tep_not_null($HTTP_GET_VARS['dept_end_date'])) ) {

	  //$make_start_date = $HTTP_GET_VARS['dept_start_date'] ;
	  $make_start_date = tep_get_date_db($HTTP_GET_VARS['dept_start_date']);
  	  //$make_end_date = $HTTP_GET_VARS['dept_end_date'] ;
	  $make_end_date = tep_get_date_db($HTTP_GET_VARS['dept_end_date']);
	  $start_date_where .= " and  op.products_departure_date >= '" . $make_start_date . "' and op.products_departure_date <= '" . $make_end_date . "' ";

	   $search_extra_get .= "&dept_start_date=".$_GET['dept_start_date']."&dept_end_date=".$_GET['dept_end_date'];

	  }

	  else if ((isset($HTTP_GET_VARS['dept_start_date']) && tep_not_null($HTTP_GET_VARS['dept_start_date'])) && (!isset($HTTP_GET_VARS['dept_end_date']) or !tep_not_null($HTTP_GET_VARS['dept_end_date'])) ) {

	  $make_start_date = tep_get_date_db($HTTP_GET_VARS['dept_start_date']);

	  $start_date_where .= " and  op.products_departure_date >= '" . $make_start_date . "' ";

	  $search_extra_get .= "&dept_start_date=".$_GET['dept_start_date'];

	  }
	  else if ((!isset($HTTP_GET_VARS['dept_start_date']) or !tep_not_null($HTTP_GET_VARS['dept_start_date'])) && (isset($HTTP_GET_VARS['dept_end_date']) && tep_not_null($HTTP_GET_VARS['dept_end_date'])) ) {

	 $make_end_date = tep_get_date_db($HTTP_GET_VARS['dept_end_date']);

	    $start_date_where .= " and  op.products_departure_date <= '" . $make_end_date . "' ";
	  $search_extra_get .= "&dept_end_date=".$_GET['dept_end_date'];
	  }

 $orders_pending_query = tep_db_query("select * from " . TABLE_ORDERS . " as o, " . TABLE_ORDERS_TOTAL . " as ot, ".TABLE_ORDERS_PRODUCTS." as op where op.orders_id=o.orders_id and ot.orders_id = o.orders_id and ot.class = 'ot_total' and o.orders_status = '" . $orders_status['orders_status_id'] . "' ".$start_date_where." group by o.orders_id");
   $count = tep_db_num_rows($orders_pending_query);
    $orders_pending = tep_db_fetch_array($orders_pending_query);
    if (tep_admin_check_boxes(FILENAME_ORDERS, 'sub_boxes') == true) {
      $orders_contents .= '<a href="' . tep_href_link(FILENAME_ORDERS, 'status=' . $orders_status['orders_status_id'].$search_extra_get_query_string).'">' . $orders_status['orders_status_name'] . '</a>: ' . $count . '<br>';// . $search_extra_get
    } else {
      $orders_contents .= '' . $orders_status['orders_status_name'] . ': ' . $count . '<br>';
    }
//Admin end
  }
  $orders_contents = substr($orders_contents, 0, -4);

  $contents[] = array('text'  => '<hr color="#333333" /><br><b>Orders Status:</b><br>'. $orders_contents);

      }

      break;

  }



  if ( (tep_not_null($heading)) && (tep_not_null($contents)) ) {

    echo '            <td width="25%" valign="top">' . "\n";



    $box = new box;

    echo $box->infoBox($heading, $contents);



    echo '            </td>' . "\n";

  }

?>
          </tr>

        </table></td>
      </tr>

<?php

  }

?>
    </table>
</td>

<!-- body_text_eof //-->

  </tr>

</table>

<!-- body_eof //-->



<!-- footer //-->

<?php require(DIR_WS_INCLUDES . 'footer.php'); ?>

<!-- footer_eof //-->

<br>

</body>

</html>

<?php require(DIR_WS_INCLUDES . 'application_bottom.php'); ?>



<script>

function LTrim(str){if(str==null){return null;}for(var i=0;str.charAt(i)==" ";i++);return str.substring(i,str.length);}

function RTrim(str){if(str==null){return null;}for(var i=str.length-1;str.charAt(i)==" ";i--);return str.substring(0,i+1);}

function Trim(str){return LTrim(RTrim(str));}

function validation_guest()

{

			var i = 0 ;

			for ( i= 0 ; i < window.document.etickets.elements.length ; i ++)

			{

				if(window.document.etickets.elements[i].name.substr(0,5) == "guest")

				{

					var ch = Trim(window.document.etickets.elements[i].value);

					if(ch == "")

					{

						alert("Please Enter guest name")

						window.document.etickets.elements[i].focus();

						return false;

					}

				}

			}

			return true;





}

function append_settle_payment_method(addvalue,addpayment){

var totalorders_payment_method=document.settele_order.orders_payment_method.value;
var totalorders_reference_comments=document.settele_order.reference_comments.value;
        /*
		for(var i=0; i < document.settele_order.append_pmethod.length; i++)
        {
			if(document.settele_order.append_pmethod[i].checked){
			totalorders_payment_method += " + "+document.settele_order.append_pmethod[i].value;
			totalorders_reference_comments += "\n"+document.settele_order.append_pmethod[i].value + ": ";

			}
        }
		*/
totalorders_payment_method += " + "+addpayment;
totalorders_reference_comments += "\n"+addvalue+ ": ";
document.settele_order.orders_payment_method.value = totalorders_payment_method;
document.settele_order.reference_comments.value = totalorders_reference_comments;
document.settele_order.reference_comments.focus();
}
</script>
